<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LICAM Asistente de Laboratorio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script> <!-- A√ëADIDO: Biblioteca para Excel -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Base Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 - Fondo m√°s profesional */
        }
        
        /* Tab Navigation Styles (for a clean, indicator-only look) */
        .tab-button {
            transition: all 0.3s ease;
            font-weight: 600;
            border-bottom: 3px solid transparent;
        }
        .tab-button:hover {
            color: #1d4ed8; /* Blue 700 */
        }
        .tab-button.active {
            border-color: #1d4ed8; /* Blue 700 para el indicador activo */
            color: #1d4ed8; /* Blue 700 para el texto activo */
            background-color: #f0f4f8; /* Un fondo muy ligero para la pesta√±a activa */
        }

        /* Well/Plate Styles */
        .well {
            transition: all 0.2s ease;
            border: 3px solid #e2e8f0; /* Color de borde m√°s sutil */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
            /* Soft default background */
            background-color: #f7fafc; 
        }
        .well.selected {
            /* Sombra interna para indicar el color del borde */
            box-shadow: inset 0 0 0 3px #2563eb, 0 6px 12px -3px rgba(0, 0, 0, 0.2); 
            border-color: transparent; /* El borde ya no es visible por el shadow */
            background-color: #eff6ff; /* Blue 50 */
            transform: scale(1.05); /* Efecto de "lift" sutil */
        }
        .well:not(.configured) .well-label {
            opacity: 0.6;
            font-style: italic;
        }
        /* Well Type Colors (Usando box-shadow: inset para el anillo) */
        .well.control { box-shadow: inset 0 0 0 3px #10b981; } /* Green 500 */
        .well.experimental { box-shadow: inset 0 0 0 3px #ef4444; } /* Red 500 */
        .well.blanco { box-shadow: inset 0 0 0 3px #6366f1; } /* Indigo 500 */
        .well.tratamiento-1 { box-shadow: inset 0 0 0 3px #f97316; } /* Orange 500 */
        .well.tratamiento-2 { box-shadow: inset 0 0 0 3px #8b5cf6; } /* Violet 500 */

        /* General Dynamic/Modal Styles */
        .modal {
            display: none;
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(4px); /* Efecto de desenfoque */
            z-index: 50; /* Ensure modals are on top */
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .toast {
            /* Use Tailwind for visibility/opacity control in JS */
            z-index: 60;
        }
        .sub-calc {
            display: none;
        }

        /* Styles for inner content tables/boxes */
        .calc-result-box {
            background-color: #f0f9ff; /* Blue 50 */
            border-left: 4px solid #3b82f6; /* Blue 500 */
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            color: #1e3a8a; /* Dark blue text for contrast */
        }
        /* Prose Styles Enhancement */
        .prose h3, .prose h4 { margin-top: 1.5em; margin-bottom: 0.5em; font-weight: 700; color: #1e3a8a; }
        #model-data-table th, #model-data-table td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            text-align: left;
        }
        #model-data-table th {
            background-color: #eef2ff; /* Indigo 50 */
            color: #4338ca; /* Indigo 700 */
        }
        
        /* Estilos espec√≠ficos para el Contador AI */
        .image-preview-slot {
            height: 150px;
            width: 100%;
            object-fit: contain;
            border-radius: 0.375rem;
            transition: all 0.2s;
        }
        .image-preview-slot:hover {
            opacity: 0.9;
        }
        .table-responsive {
            overflow-x: auto;
        }
        #cell-counter-results-table th, #cell-counter-results-table td {
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            text-align: left;
        }
        #cell-counter-results-table th {
            background-color: #f1f5f9;
            font-weight: 600;
            color: #334155;
        }
        #cell-counter-results-table tbody tr:nth-child(odd) {
            background-color: #f8fafc;
        }
        .interpretation-content h4 {
            font-weight: bold;
            color: #1e40af; 
            margin-top: 10px;
            margin-bottom: 5px;
            border-bottom: 1px solid #bfdbfe;
            padding-bottom: 2px;
        }
        .calculation-result-ai {
            background-color: #e0f2f1;
            border-left: 4px solid #14b8a6;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <header class="bg-white shadow-xl sticky top-0 z-20 border-b border-blue-200">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="logo_licam.png" onerror="this.onerror=null;this.src='';" alt="Logo LICAM" class="h-14 w-auto object-contain">
                <h1 class="text-3xl font-extrabold text-blue-700 tracking-tight">LICAM <span class="text-gray-500 font-semibold text-xl">Asistente de Laboratorio</span></h1>
            </div>
            <div>
                 <img src="logo_ipn.png" onerror="this.onerror=null;this.src='';" alt="Logo IPN" class="h-12 w-auto object-contain">
            </div>
        </div>
    </header>
    <div class="bg-white shadow-md z-10 sticky top-14">
        <div class="container mx-auto px-4 border-b border-gray-200">
            <nav class="flex space-x-1 overflow-x-auto pb-0" aria-label="Tabs">
                <button onclick="changeTab('guide')" id="tab-guide" class="tab-button active text-md py-3 px-4 flex-shrink-0 flex items-center space-x-2">üí° Gu√≠a de Uso</button>
                <button onclick="changeTab('planner')" id="tab-planner" class="tab-button text-md py-3 px-4 flex-shrink-0 flex items-center space-x-2">üß™ Organizador de Cultivo</button>
                <button onclick="changeTab('cell-counter')" id="tab-cell-counter" class="tab-button text-md py-3 px-4 flex-shrink-0 flex items-center space-x-2">üî¨ Contador AI</button>
                <button onclick="changeTab('models')" id="tab-models" class="tab-button text-md py-3 px-4 flex-shrink-0 flex items-center space-x-2">üê≠ Modelos Animales</button>
                <button onclick="changeTab('protocols')" id="tab-protocols" class="tab-button text-md py-3 px-4 flex-shrink-0 flex items-center space-x-2">üìö Protocolos y Recursos</button>
                <button onclick="changeTab('report')" id="tab-report" class="tab-button text-md py-3 px-4 flex-shrink-0 flex items-center space-x-2">üìÑ Reporte del Experimento</button>
                <button onclick="changeTab('calculators')" id="tab-calculators" class="tab-button text-md py-3 px-4 flex-shrink-0 flex items-center space-x-2">üî¢ Calculadoras R√°pidas</button>
                <button onclick="changeTab('about')" id="tab-about" class="tab-button text-md py-3 px-4 flex-shrink-0 flex items-center space-x-2">‚ÑπÔ∏è Acerca del Proyecto</button>
            </nav>
        </div>
    </div>


    <main class="container mx-auto p-4 md:p-8">
        <!-- GU√çA DE USO -->
        <div id="content-guide" class="space-y-6 bg-white p-8 rounded-3xl shadow-2xl border border-gray-200">
            <h2 class="text-3xl font-bold text-blue-700 border-b pb-4">üí° Gu√≠a de Uso R√°pido</h2>
            <div class="prose max-w-none text-gray-700">
                <p>¬°Bienvenido/a al Asistente de Laboratorio LICAM! Esta gu√≠a te ayudar√° a usar las funciones principales.</p>
                <h3>Organizador de Cultivo (üß™)</h3>
                <p>Esta es la secci√≥n principal para planificar tus experimentos en placas.</p>
                <ul class="list-disc list-inside">
                    <li><strong>1. Configuraci√≥n del Experimento:</strong> Dale un nombre a tu experimento y selecciona el tipo de placa (6, 12, 24, 48, 96 pozos). Haz clic en "Generar Placa".</li>
                    <li><strong>Guardar/Cargar Experimento:</strong> Usa los botones verdes y grises para guardar tu progreso en un archivo <code>.json</code> o cargar un experimento previamente guardado.</li>
                    <li><strong>2. Dise√±o de la Placa:</strong> Haz clic en los pozos para seleccionarlos (se pondr√°n azules). Puedes seleccionar varios. Usa "Seleccionar Todos" o "Limpiar Selecci√≥n" para ayudarte.</li>
                    <li><strong>Configurar Pozo(s):</strong> Con los pozos seleccionados, haz clic en "Configurar Pozo(s)". Se abrir√° una ventana:
                        <ul>
                            <li><strong>Par√°metros Generales:</strong> Define el Tipo de Pozo, Volumen Total Final y Cantidad de C√©lulas por pozo. Usa el icono ‚öôÔ∏è junto a C√©lulas para:
                                <ul>
                                    <li>Calcular el volumen a tomar de tu stock celular (necesitas la concentraci√≥n de tu stock).</li>
                                    <li>O usar la calculadora de C√°mara de Neubauer: introduce los conteos de 4 cuadrantes y haz clic en "Calcular Concentraci√≥n" para obtener la concentraci√≥n de tu stock en c√©lulas/mL.</li>
                                </ul>
                            </li>
                             <li><strong>Variables/Reactivos:</strong> A√±ade los reactivos que usar√°s. Define la Concentraci√≥n Final deseada. Usa el icono ‚öôÔ∏è para calcular cu√°nto volumen tomar de tu reactivo stock.</li>
                             <li><strong>Pasos del Protocolo:</strong> Define los pasos secuenciales de tu experimento (Ej. Paso 1: Incubaci√≥n PMA, Duraci√≥n: 24 horas; Paso 2: Lavado + LPS, Duraci√≥n: 12 horas). A√±ade tantos pasos como necesites.</li>
                        </ul>
                    </li>
                    <li><strong>3. Creador de Stock General:</strong> Selecciona los pozos que tendr√°n la misma mezcla y haz clic en "Calcular Stock...". Indica un porcentaje extra si lo deseas. La tabla te mostrar√° cu√°nto necesitas preparar en total.</li>
                    <li><strong>4. Cronograma del Protocolo:</strong> Aqu√≠ aparecer√°n todos los Pasos del Protocolo. Cada paso tendr√° su propio temporizador. Haz clic en "Iniciar" para comenzar la cuenta regresiva.</li>
                </ul>

                <h3>Contador AI (üî¨)</h3>
                <p>Utiliza la Inteligencia Artificial para el conteo autom√°tico de c√©lulas en cuadrantes de Neubauer.</p>
                <ul class="list-disc list-inside">
                    <li>**1. Carga de Regiones:** Sube hasta 4 im√°genes independientes (una por cada cuadrante grande "L").</li>
                    <li>**2. An√°lisis:** La IA cuenta las c√©lulas de cada regi√≥n y genera un informe estructurado con el conteo y un an√°lisis morfol√≥gico.</li>
                    <li>**3. C√°lculo Final:** El sistema suma el conteo y calcula la concentraci√≥n final en C√©lulas/mL, asumiendo que usas muestra pura (Diluci√≥n 1:1) y contaste 4 cuadrantes grandes.</li>
                </ul>

                <h3>Modelos Animales (üê≠)</h3>
                <p>Secci√≥n para llevar un registro de datos de modelos animales y calcular dosis.</p>
                <ul class="list-disc list-inside">
                    <li><strong>Seguimiento:</strong> A√±ade modelos con un ID √∫nico. Luego, haz clic en "+ A√±adir Registro" para ingresar Peso (g), Talla (cm), Glucosa (mg/dL), Fuerza de Agarre (gf) y Notas.</li>
                    <li><strong>Dosis:</strong> Utiliza la Calculadora de Dosificaci√≥n para saber cu√°nto volumen administrar (¬µL o mL) seg√∫n la dosis requerida (mg/kg), el peso del modelo y la concentraci√≥n de tu stock.</li>
                    <li><strong>Guardar/Cargar:</strong> Guarda o carga los datos de tus modelos en archivos <code>.json</code>.</li>
                </ul>

                <h3>Protocolos y Recursos (üìö)</h3>
                <p>Contiene una secci√≥n editable de notas para protocolos comunes (ej. Extracci√≥n de ARN) y enlaces directos a bases de datos √∫tiles (PubMed, UniProt, etc.).</p>

                <h3>Reporte y Calculadoras (üìÑ/üî¢)</h3>
                <p>El **Reporte** genera un archivo CSV listo para Excel con la configuraci√≥n de tu placa. Las **Calculadoras** te permiten realizar c√°lculos r√°pidos de Masa Molar, Conversi√≥n de Unidades y Diluci√≥n (C‚ÇÅV‚ÇÅ=C‚ÇÇV‚ÇÇ) de forma independiente.</p>

                <h3>Acerca del Proyecto (‚ÑπÔ∏è)</h3>
                <p>Muestra informaci√≥n sobre el desarrollo, colaboradores, instituci√≥n y datos de contacto de LICAM.</p>
            </div>
        </div>
        <!-- ORGANIZADOR DE CULTIVO -->
        <div id="content-planner" class="hidden space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 bg-white p-6 rounded-3xl shadow-xl border border-gray-200">
                    <h2 class="text-2xl font-bold mb-5 text-indigo-700 border-b pb-3">1. Configuraci√≥n ‚ú®</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="exp-name" class="block text-sm font-medium text-gray-700">Nombre del Experimento:</label>
                            <input type="text" id="exp-name" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2" placeholder="Ej: Curva de dosis PMA/LPS">
                        </div>
                        <div>
                            <label for="plate-type" class="block text-sm font-medium text-gray-700">Tipo de Placa:</label>
                            <select id="plate-type" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2">
                                <option value="6">6 Pozos</option>
                                <option value="12">12 Pozos</option>
                                <option value="24" selected>24 Pozos</option>
                                <option value="48">48 Pozos</option>
                                <option value="96">96 Pozos</option>
                            </select>
                        </div>
                        <button onclick="generatePlate()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">Generar Placa</button>
                    </div>
                    
                    <div class="mt-8 pt-4 border-t border-gray-200">
                        <h3 class="text-xl font-bold mb-3 text-gray-700">Guardar / Cargar Experimento</h3>
                        <div class="flex space-x-2">
                            <button onclick="saveExperiment()" class="flex-1 bg-green-600 text-white font-bold py-2 px-3 text-sm rounded-xl hover:bg-green-700 transition shadow-md">üíæ Guardar</button>
                            <label for="load-exp-input" class="flex-1 bg-gray-600 text-white font-bold py-2 px-3 text-sm rounded-xl hover:bg-gray-700 cursor-pointer text-center transition shadow-md">üìÇ Cargar</label>
                            <input type="file" id="load-exp-input" class="hidden" accept=".json">
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h3 class="text-xl font-bold mb-3 text-gray-700">Controles de Selecci√≥n</h3>
                        <div class="flex space-x-2 mb-4">
                            <button onclick="selectAllWells()" class="flex-1 bg-gray-200 text-gray-800 py-2 px-3 text-sm rounded-xl hover:bg-gray-300 transition shadow-sm">Seleccionar Todos</button>
                            <button onclick="clearSelection()" class="flex-1 bg-gray-200 text-gray-800 py-2 px-3 text-sm rounded-xl hover:bg-gray-300 transition shadow-sm">Limpiar Selecci√≥n</button>
                        </div>
                       <button onclick="openWellConfigModal()" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-indigo-700 transition duration-300 shadow-lg">‚öôÔ∏è Configurar Pozo(s)</button>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-white p-6 rounded-3xl shadow-xl border border-gray-200 flex flex-col">
                    <div class="flex justify-between items-center mb-5 border-b pb-3 border-gray-200">
                        <h2 class="text-2xl font-bold text-indigo-700">2. Dise√±o de la Placa</h2>
                        <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs items-center justify-end">
                            <span class="flex items-center p-1 rounded-md border border-green-500"><span class="w-3 h-3 rounded-full bg-white border-2 border-green-500 mr-1"></span>Control</span>
                            <span class="flex items-center p-1 rounded-md border border-red-500"><span class="w-3 h-3 rounded-full bg-white border-2 border-red-500 mr-1"></span>Experimental</span>
                            <span class="flex items-center p-1 rounded-md border border-indigo-500"><span class="w-3 h-3 rounded-full bg-white border-2 border-indigo-500 mr-1"></span>Blanco</span>
                            <span class="flex items-center p-1 rounded-md border border-orange-500"><span class="w-3 h-3 rounded-full bg-white border-2 border-orange-500 mr-1"></span>Trat. 1</span>
                            <span class="flex items-center p-1 rounded-md border border-violet-500"><span class="w-3 h-3 rounded-full bg-white border-2 border-violet-500 mr-1"></span>Trat. 2</span>
                        </div>
                    </div>
                    <div id="plate-layout-container" class="p-6 bg-gray-100 rounded-xl overflow-x-auto flex-grow flex items-center justify-center">
                        <div id="plate-layout" class="grid gap-3 p-2 bg-white rounded-lg shadow-inner" style="grid-template-columns: repeat(6, 1fr); display:none;">
                            </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-5 text-indigo-700 border-b pb-3">3. Creador de Stock General üíß</h2>
                <div class="flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-6 mb-4 p-4 bg-purple-50 rounded-xl border border-purple-200">
                    <button onclick="calculateMasterMix()" class="bg-purple-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-purple-700 transition duration-300 shadow-md flex-shrink-0">Calcular Stock para Pozos Seleccionados</button>
                    <div class="flex items-center space-x-2">
                        <label for="extra-volume" class="mr-2 text-sm font-medium text-gray-700 whitespace-nowrap">Volumen extra (% de seguridad):</label>
                        <input type="number" id="extra-volume" value="10" class="w-20 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-center p-2">
                    </div>
                </div>
                <div id="master-mix-results" class="calc-result-box">
                    <p class="text-gray-600 font-normal">Los resultados del c√°lculo para el stock general aparecer√°n aqu√≠.</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-5 text-indigo-700 border-b pb-3">4. Cronograma del Protocolo ‚è∞</h2>
                <div class="text-sm text-gray-700 mb-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 rounded-lg">
                    <b class="font-extrabold">üö® Alerta de Tiempo:</b> Las alarmas y notificaciones solo funcionar√°n si esta pesta√±a del navegador permanece abierta.
                </div>
                <div id="protocol-schedule-container" class="space-y-4">
                    <p class="text-gray-500">Los eventos del protocolo para los pozos configurados aparecer√°n aqu√≠.</p>
                </div>
            </div>
        </div>
        
        <!-- CONTADOR CELULAR AI (NUEVA PESTA√ëA) -->
        <div id="content-cell-counter" class="hidden space-y-8">
            <div class="bg-white p-8 rounded-3xl shadow-2xl border border-gray-200">
                <h2 class="text-3xl font-bold text-blue-700 border-b pb-4">üî¨ Contador de C√©lulas (Neubauer AI)</h2>
                <p class="text-gray-500 mt-2 mb-6">Analiza hasta 4 im√°genes de cuadrantes grandes ("L") para el conteo de c√©lulas y c√°lculo de concentraci√≥n.</p>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Columna de Carga de Imagen y Par√°metros (lg:col-span-1) -->
                    <div class="lg:col-span-1 space-y-4">
                        <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">Paso 1: Cargar Regiones (M√°x. 4)</h3>
                        
                        <!-- Slots de Carga -->
                        <div id="cellUploadSlots" class="grid grid-cols-2 gap-4">
                            <!-- Los slots se inicializan v√≠a JS -->
                            <template id="cellUploadSlotTemplate">
                                <div class="bg-gray-50 p-3 rounded-lg shadow-inner border border-gray-200">
                                    <label class="block text-sm font-medium text-gray-600 mb-2" data-slot-label>Regi√≥n N</label>
                                    <input type="file" accept="image/*" class="cell-upload-input hidden" onchange="handleImageUpload(event, this)">
                                    <img class="image-preview-slot cursor-pointer border border-gray-300" 
                                         src="https://placehold.co/150x150/e5e7eb/9ca3af?text=Slot" 
                                         alt="Vista previa de la regi√≥n" 
                                         onclick="this.previousElementSibling.click()">
                                    <button onclick="clearImageSlot(this)" class="clear-button w-full mt-2 py-1 text-xs bg-red-500 text-white rounded-md hover:bg-red-600 hidden">Eliminar</button>
                                </div>
                            </template>
                        </div>

                        <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 pt-4 mb-4">Paso 2: Par√°metros de C√°lculo</h3>
                        <div class="space-y-4 bg-white p-4 rounded-lg shadow-md border">
                            <p class="text-sm font-medium text-gray-700">Factor de Diluci√≥n:</p>
                            <p class="text-md font-bold text-teal-800">1:1 (Muestra Pura)</p>
                            <p class="text-xs text-gray-500">El c√°lculo de concentraci√≥n asume que no se ha diluido la muestra, usando un factor de <span class="font-extrabold text-teal-700">1</span>.</p>
                        </div>


                        <button id="analyzeButton" onclick="analyzeImage()" disabled
                            class="w-full py-3 px-4 bg-gray-400 text-white font-bold rounded-lg transition duration-200 shadow-md disabled:opacity-50 mt-6">
                            Paso 3: Analizar y Calcular Concentraci√≥n
                        </button>
                    </div>

                    <!-- Columna de Resultados (lg:col-span-2) -->
                    <div class="lg:col-span-2 space-y-6">
                        <div id="loadingIndicator" class="hidden bg-yellow-100 p-6 rounded-lg shadow-md border-l-4 border-yellow-500">
                            <div class="flex items-center space-x-3">
                                <svg class="animate-spin h-5 w-5 text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span class="text-yellow-700 font-medium">Analizando hasta 4 regiones... Esto puede tardar m√°s.</span>
                            </div>
                        </div>

                        <div id="resultsCard" class="bg-green-50 p-6 rounded-lg shadow-md border-l-4 border-green-500 min-h-[200px]">
                            <h3 class="text-xl font-bold text-green-700 mb-4">Resultados Detallados por Regi√≥n (IA)</h3>
                            <div id="resultsContent" class="text-gray-700">
                                <p>Los resultados del conteo aparecer√°n aqu√≠ en una tabla detallada por cada regi√≥n cargada.</p>
                                <p class="mt-4 text-sm text-gray-500">Nota: La IA analizar√° la morfolog√≠a y distribuci√≥n para cada imagen.</p>
                            </div>

                            <div id="totalSummary" class="hidden mt-6 pt-4 border-t border-green-300">
                                <h4 class="text-lg font-bold text-green-800">Resumen del Conteo:</h4>
                                <p class="text-sm text-gray-600 mb-4">El conteo sumado de todas las regiones analizadas es: <span id="totalCountDisplay" class="text-2xl font-bold ml-1 text-green-700">0</span> C√©lulas.</p>
                                
                                <!-- Resultado de concentraci√≥n -->
                                <div id="concentrationResult" class="calculation-result-ai p-4 rounded-lg">
                                    <h5 class="text-md font-bold text-teal-700 mb-1">Concentraci√≥n de la Muestra (C√©lulas/mL):</h5>
                                    <p class="text-2xl font-extrabold text-teal-800"><span id="finalConcentrationDisplay">0</span></p>
                                    <p class="text-xs text-gray-600 mt-1">F√≥rmula: $(\sum\text{C√©lulas} / \text{N Cuadrantes}) \times 2,500$. (Diluci√≥n x1).</p>
                                    <p class="text-xs text-gray-600">Usando $\text{N Cuadrantes}$: <span id="calcRegions">0</span></p>
                                </div>
                            </div>

                            <button id="downloadExcelButton" onclick="downloadExcel()"
                                class="hidden mt-4 py-2 px-4 bg-green-600 text-white font-bold rounded-lg transition duration-200 hover:bg-green-700 shadow-md">
                                Descargar Resultados (Excel)
                            </button>
                        </div>

                        <div id="errorCard" class="hidden bg-red-100 p-6 rounded-lg shadow-md border-l-4 border-red-500">
                            <h3 class="text-xl font-bold text-red-700 mb-2">Error en el An√°lisis</h3>
                            <p id="errorMessage" class="text-red-700"></p>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- MODELOS ANIMALES -->
        <div id="content-models" class="hidden space-y-8">
            <!-- ... (CONTENIDO DE MODELOS ANIMALES) ... -->
            <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-5 text-indigo-700 border-b pb-3">üê≠ Seguimiento de Modelos Animales</h2>
                <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4 mb-6">
                    <button onclick="saveModelData()" class="bg-green-600 text-white font-bold py-2 px-4 text-sm rounded-xl hover:bg-green-700 transition shadow-md">üíæ Guardar Datos Modelos</button>
                    <label for="load-model-input" class="bg-gray-600 text-white font-bold py-2 px-4 text-sm rounded-xl hover:bg-gray-700 cursor-pointer text-center transition shadow-md">üìÇ Cargar Datos Modelos</label>
                    <input type="file" id="load-model-input" class="hidden" accept=".json">
                    <div class="flex space-x-2 w-full md:w-auto">
                        <input type="text" id="new-model-id" placeholder="ID Nuevo Modelo (Ej: Rat√≥n-01)" class="border-gray-300 rounded-lg shadow-sm p-2 w-full">
                        <button onclick="addAnimalModel()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-xl hover:bg-blue-700 transition shadow-md flex-shrink-0">A√±adir</button>
                    </div>
                </div>
                <div id="animal-models-container" class="space-y-6">
                    </div>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-5 text-indigo-700 border-b pb-3">üíâ Calculadora de Dosificaci√≥n por Peso</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                    <div>
                        <label class="block text-sm font-bold text-gray-700">Dosis Deseada (mg/kg):</label>
                        <div class="flex space-x-1 mt-1">
                            <input type="number" id="dose-amount" placeholder="Cantidad" class="w-1/2 border-gray-300 rounded-lg shadow-sm p-2">
                            <select id="dose-amount-unit" class="w-1/2 border-gray-300 rounded-lg shadow-sm p-2"></select>
                         </div>
                         <div class="flex space-x-1 mt-2 items-center text-sm">
                            <span class="whitespace-nowrap">por cada</span>
                            <input type="number" id="dose-weight-unit-val" value="1" class="w-1/4 border-gray-300 rounded-lg shadow-sm p-2 text-center">
                            <select id="dose-weight-unit" class="w-1/2 border-gray-300 rounded-lg shadow-sm p-2">
                                <option value="g">g</option>
                                <option value="kg" selected>kg</option>
                            </select>
                         </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700">Peso del Modelo:</label>
                        <div class="flex space-x-1 mt-1">
                            <input type="number" id="model-weight" placeholder="Peso" class="w-1/2 border-gray-300 rounded-lg shadow-sm p-2">
                            <select id="model-weight-unit" class="w-1/2 border-gray-300 rounded-lg shadow-sm p-2">
                                <option value="g" selected>g</option>
                                <option value="kg">kg</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700">Concentraci√≥n del Stock (Ej: mg/mL):</label>
                        <div class="flex space-x-1 mt-1">
                            <input type="number" id="stock-conc-dose" placeholder="Conc." class="w-1/2 border-gray-300 rounded-lg shadow-sm p-2">
                            <select id="stock-conc-dose-unit" class="w-1/2 border-gray-300 rounded-lg shadow-sm p-2"></select>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-between items-center border-t pt-4">
                    <button onclick="calculateModelDose()" class="bg-teal-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-teal-700 transition shadow-md">Calcular Volumen a Administrar</button>
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium">Resultado en:</label>
                        <select id="dose-output-unit" class="border-gray-300 rounded-lg shadow-sm p-2">
                            <option value="¬µL" selected>¬µL</option>
                            <option value="mL">mL</option>
                        </select>
                    </div>
                </div>
                <div id="dose-calculation-result" class="mt-4 calc-result-box"></div>
            </div>
        </div>

        <!-- PROTOCOLOS Y RECURSOS -->
        <div id="content-protocols" class="hidden space-y-6 bg-white p-8 rounded-3xl shadow-xl border border-gray-200">
            <!-- ... (CONTENIDO DE PROTOCOLOS Y RECURSOS) ... -->
            <h2 class="text-3xl font-bold text-blue-700 border-b pb-4">üìö Protocolos Comunes y Recursos Externos</h2>
            <div class="prose max-w-none grid grid-cols-1 md:grid-cols-2 gap-8 text-gray-700">
                <div>
                    <h3>Protocolos Comunes (Notas R√°pidas)</h3>
                    <div class="p-4 border border-gray-300 rounded-xl bg-gray-50 shadow-inner">
                        <h4>Extracci√≥n de ARN (Esquema B√°sico)</h4>
                        <p>Este es un lugar para tus notas o un checklist simple:</p>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <li>Lisis celular (ej. Trizol)</li>
                            <li>Separaci√≥n de fases (Cloroformo)</li>
                            <li>Precipitaci√≥n de ARN (Isopropanol)</li>
                            <li>Lavados (Etanol 70-75%)</li>
                            <li>Resuspensi√≥n (Agua libre de nucleasas)</li>
                            <li>Cuantificaci√≥n (Nanodrop/Qubit)</li>
                            <li>Control de Calidad (Gel/Bioanalyzer)</li>
                        </ul>
                        <p class="text-xs text-gray-500 mt-3">Puedes editar este archivo HTML para a√±adir detalles espec√≠ficos de tus kits o protocolos.</p>
                    </div>
                </div>
                <div>
                    <h3>Bases de Datos Externas</h3>
                    <p>Enlaces r√°pidos a recursos √∫tiles de ciencia:</p>
                    <ul class="list-disc list-inside space-y-2">
                        <li><a href="https://pubmed.ncbi.nlm.nih.gov/" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline font-semibold">PubMed (NCBI):</a> B√∫squeda de literatura biom√©dica.</li>
                        <li><a href="https://www.ncbi.nlm.nih.gov/gene/" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline font-semibold">NCBI Gene:</a> Informaci√≥n sobre genes espec√≠ficos.</li>
                        <li><a href="https://blast.ncbi.nlm.nih.gov/Blast.cgi" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline font-semibold">NCBI BLAST:</a> B√∫squeda de secuencias.</li>
                        <li><a href="https://www.uniprot.org/" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline font-semibold">UniProt:</a> Informaci√≥n sobre prote√≠nas.</li>
                        <li><a href="https://www.rcsb.org/" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline font-semibold">Protein Data Bank (PDB):</a> Estructuras 3D.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- REPORTE -->
        <div id="content-report" class="hidden space-y-6 bg-white p-8 rounded-3xl shadow-xl border border-gray-200">
            <!-- ... (CONTENIDO DE REPORTE) ... -->
            <h2 class="text-3xl font-bold text-blue-700 border-b pb-4">üìÑ Reporte del Experimento</h2>
            <div class="flex space-x-4">
                <button onclick="generateReport()" class="bg-teal-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-teal-700 transition shadow-md">Generar Reporte Completo</button>
                <button onclick="exportReportCSV()" id="export-csv-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 hidden transition shadow-md">‚¨áÔ∏è Descargar Reporte (CSV)</button>
            </div>
            <div id="report-output" class="prose max-w-none mt-4 border-t pt-4 text-gray-700">
                <p class="text-gray-500">Haz clic en el bot√≥n para generar un resumen de tu experimento.</p>
            </div>
        </div>

        <!-- CALCULADORAS R√ÅPIDAS -->
        <div id="content-calculators" class="hidden space-y-8">
            <!-- ... (CONTENIDO DE CALCULADORAS) ... -->
            <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-5 text-indigo-700">üî¢ Calculadora de Masa Molar</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div class="md:col-span-2">
                        <label for="chem-formula" class="block text-sm font-medium text-gray-700">F√≥rmula Qu√≠mica (Ej: C6H12O6):</label>
                        <input type="text" id="chem-formula" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Ej: C6H12O6, NaCl">
                    </div>
                    <div>
                        <button onclick="calculateMolarMass()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition shadow-md">Calcular Masa Molar</button>
                    </div>
                </div>
                <div id="molar-mass-result" class="mt-4 calc-result-box"></div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-5 text-indigo-700">üîÑ Conversor de Unidades</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 items-end">
                    <div>
                        <label for="uc-value" class="block text-sm font-medium text-gray-700">Valor:</label>
                        <input type="number" id="uc-value" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2">
                    </div>
                    <div>
                        <label for="uc-from" class="block text-sm font-medium text-gray-700">Desde:</label>
                        <select id="uc-from" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
                    </div>
                    <div class="hidden md:block text-center text-xl font-bold text-gray-500">=</div>
                    <div>
                        <label for="uc-to" class="block text-sm font-medium text-gray-700">Hasta:</label>
                        <select id="uc-to" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
                    </div>
                    <button onclick="convertUnits()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition shadow-md">Convertir</button>
                </div>
                <div id="uc-result" class="mt-4 calc-result-box"></div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-5 text-indigo-700">üíß Calculadora de Diluci√≥n (C‚ÇÅV‚ÇÅ = C‚ÇÇV‚ÇÇ)</h2>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label for="c1" class="block text-sm font-medium text-gray-700">C1 (Stock):</label>
                            <input type="number" id="c1" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Conc. inicial">
                        </div>
                        <div>
                            <label for="c1-unit" class="block text-sm font-medium text-gray-700">Unidad C1:</label>
                            <select id="c1-unit" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
                        </div>
                        <div>
                            <label for="v1" class="block text-sm font-medium text-gray-700">V1 (Stock):</label>
                            <input type="number" id="v1" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Vol. inicial">
                        </div>
                        <div>
                            <label for="v1-unit" class="block text-sm font-medium text-gray-700">Unidad V1:</label>
                            <select id="v1-unit" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
                        </div>
                        <div>
                            <label for="c2" class="block text-sm font-medium text-gray-700">C2 (Final):</label>
                            <input type="number" id="c2" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Conc. final">
                        </div>
                        <div>
                            <label for="c2-unit" class="block text-sm font-medium text-gray-700">Unidad C2:</label>
                            <select id="c2-unit" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
                        </div>
                        <div>
                            <label for="v2" class="block text-sm font-medium text-gray-700">V2 (Final):</label>
                            <input type="number" id="v2" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Vol. final">
                        </div>
                        <div>
                            <label for="v2-unit" class="block text-sm font-medium text-gray-700">Unidad V2:</label>
                            <select id="v2-unit" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
                        </div>
                    </div>
                </div>
                <div class="mt-6">
                    <button onclick="calculateDilution()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition shadow-md">Calcular Valor Faltante</button>
                </div>
                <div id="dilution-result" class="mt-4 calc-result-box"></div>
            </div>
        </div>

        <!-- ACERCA DEL PROYECTO -->
        <div id="content-about" class="hidden space-y-8 bg-white p-8 rounded-3xl shadow-xl border border-gray-200">
            <!-- ... (CONTENIDO DE ACERCA DE) ... -->
            <h2 class="text-3xl font-bold text-blue-700 border-b pb-4">‚ÑπÔ∏è Informaci√≥n del Proyecto y Colaboradores</h2>
            <div class="prose max-w-none text-gray-700">
                <p class="text-lg">Esta aplicaci√≥n es una herramienta de apoyo desarrollada como parte de un proyecto de tesis para optimizar el trabajo en el laboratorio, especialmente en la planificaci√≥n y seguimiento de cultivos celulares.</p>
                
                <h3 class="font-bold text-2xl text-indigo-600 mt-8 mb-4 border-b border-indigo-100 pb-2">Equipo de Desarrollo y Asesor√≠a</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="p-4 bg-gray-50 border border-gray-200 rounded-xl shadow-md transition hover:shadow-lg">
                        <p class="text-xl font-extrabold text-indigo-700">Tesista</p>
                        <p class="mt-1 font-semibold">Edsel Yahvi M√©ndez Hern√°ndez</p>
                    </div>
                    <div class="p-4 bg-gray-50 border border-gray-200 rounded-xl shadow-md transition hover:shadow-lg">
                        <p class="text-xl font-extrabold text-indigo-700">Asesora Externa</p>
                        <p class="mt-1 font-semibold">Dra. Nayelli N√°jera Garc√≠a</p>
                    </div>
                    <div class="p-4 bg-gray-50 border border-gray-200 rounded-xl shadow-md transition hover:shadow-lg">
                        <p class="text-xl font-extrabold text-indigo-700">Asesor Docente</p>
                        <p class="mt-1 font-semibold">Dr. Bustos Garc√≠a Juan Roberto Israel</p>
                    </div>
                </div>

                <h3 class="font-bold text-2xl text-indigo-600 mt-10 mb-4 border-b border-indigo-100 pb-2">Instituci√≥n y Laboratorio</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl shadow-md transition hover:shadow-lg">
                        <p class="text-xl font-extrabold text-blue-700">Instituci√≥n</p>
                        <p class="mt-1 font-semibold">Escuela Superior de Medicina (ESM) - IPN</p>
                    </div>
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl shadow-md transition hover:shadow-lg">
                        <p class="text-xl font-extrabold text-blue-700">Laboratorio Colaborador (LICAM)</p>
                        <p class="mt-1 font-semibold">Investigaci√≥n Integral Cardiometab√≥lica (IPN)</p>
                    </div>
                </div>
                
                <div class="mt-10 pt-6 border-t border-gray-200">
                    <h3 class="font-bold text-2xl text-indigo-600">Contacto y Redes</h3>
                    <p class="mt-4">
                        <span class="font-bold">Direcci√≥n:</span> Plan de San Luis y D√≠az Mir√≥n s/n Col. Casco de Santo Tom√°s, Miguel Hidalgo, 11340, Ciudad de M√©xico, CDMX.
                    </p>
                    <p>
                        <span class="font-bold">Correo:</span> nnajerag@ipn.mx
                    </p>
                    <p>
                        <span class="font-bold">Tel√©fono:</span> 55 5729 6300 ext 62820
                    </p>
                    <div class="mt-4 flex space-x-4 text-lg">
                        <a href="https://cemiztli.wixsite.com/cardiometabolismo" target="_blank" class="text-blue-600 hover:text-blue-800 font-semibold transition flex items-center">
                            üåê Website
                        </a>
                        <a href="#" class="text-blue-600 hover:text-blue-800 font-semibold transition flex items-center">
                            üìò Facebook
                        </a>
                        <a href="#" class="text-blue-600 hover:text-blue-800 font-semibold transition flex items-center">
                            üì∏ Instagram
                        </a>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <div id="well-config-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4">
        <!-- ... (CONTENIDO DEL MODAL DE CONFIGURACI√ìN DE POZO) ... -->
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-4xl max-h-[95vh] overflow-y-auto p-8 border-4 border-indigo-500/50">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Configurar Pozo(s): <span id="well-ids-display" class="text-indigo-600 font-extrabold"></span></h2>
                <button onclick="closeWellConfigModal()" class="text-3xl text-gray-500 hover:text-gray-800 transition leading-none">&times;</button>
            </div>
            
            <div class="space-y-6">
                <div>
                    <h3 class="font-bold text-xl mb-3 text-indigo-700 border-b border-indigo-100 pb-2">Par√°metros Generales</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border rounded-xl bg-indigo-50">
                        <div>
                            <label for="well-type" class="block text-sm font-medium text-gray-700">Tipo de Pozo:</label>
                             <select id="well-type" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm p-2">
                                 <option value="default">No Asignado</option>
                                 <option value="control">Control</option>
                                 <option value="experimental">Experimental</option>
                                 <option value="blanco">Blanco</option>
                                 <option value="tratamiento-1">Tratamiento 1</option>
                                 <option value="tratamiento-2">Tratamiento 2</option>
                             </select>
                        </div>
                        <div>
                            <label for="well-total-volume" class="block text-sm font-medium text-gray-700">Volumen Total Final (¬µL):</label>
                            <input type="number" id="well-total-volume" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Ej: 2000">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">C√©lulas por Pozo:</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="well-cell-count" class="w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Ej: 200000">
                                <button onclick="toggleSubCalc('cell-calc')" class="bg-gray-200 p-2 rounded-lg hover:bg-gray-300 transition">‚öôÔ∏è</button>
                            </div>
                            <div id="cell-calc" class="sub-calc p-3 border rounded-lg bg-white mt-2 space-y-3 shadow-inner">
                                <div class="space-y-2">
                                    <p class="text-xs font-semibold text-gray-700 border-b pb-1">Calcular volumen de stock celular:</p>
                                    <div class="flex items-center space-x-2">
                                        <input type="number" id="cell-stock-conc" placeholder="Conc. stock" class="w-full text-sm border-gray-300 rounded-lg p-2">
                                        <select id="cell-stock-conc-unit" class="text-sm border-gray-300 rounded-lg p-2">
                                            <option value="1">c√©lulas/mL</option>
                                            <option value="1000">c√©lulas/¬µL</option>
                                        </select>
                                    </div>
                                    <button onclick="calculateCellVolume()" class="w-full text-sm bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition shadow-sm">Calcular Volumen (¬µL)</button>
                                    <p id="cell-volume-result" class="text-sm font-medium text-blue-700 bg-blue-100 p-2 rounded-lg"></p>
                                </div>
                                <div class="mt-4 pt-4 border-t border-gray-200 space-y-2">
                                    <p class="text-xs font-semibold text-gray-700 border-b pb-1">Calculadora C√°mara de Neubauer:</p>
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="number" id="neubauer-q1" placeholder="Cuadrante 1" class="w-full text-sm border-gray-300 rounded-lg p-2">
                                        <input type="number" id="neubauer-q2" placeholder="Cuadrante 2" class="w-full text-sm border-gray-300 rounded-lg p-2">
                                        <input type="number" id="neubauer-q3" placeholder="Cuadrante 3" class="w-full text-sm border-gray-300 rounded-lg p-2">
                                        <input type="number" id="neubauer-q4" placeholder="Cuadrante 4" class="w-full text-sm border-gray-300 rounded-lg p-2">
                                    </div>
                                    <button onclick="calculateNeubauer()" class="w-full text-sm bg-teal-500 text-white py-2 rounded-lg hover:bg-teal-600 transition shadow-sm">Calcular Concentraci√≥n</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="font-bold text-xl mb-3 text-indigo-700 border-b border-indigo-100 pb-2">Variables / Reactivos</h3>
                    <div id="variables-container" class="space-y-4">
                        </div>
                    <button onclick="addVariable()" class="mt-4 text-sm bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-xl hover:bg-gray-300 transition shadow-sm">+ A√±adir Variable</button>
                </div>

                <div>
                    <h3 class="font-bold text-xl mb-3 text-indigo-700 border-b border-indigo-100 pb-2">Pasos del Protocolo</h3>
                    <div class="p-4 border rounded-xl bg-indigo-50 space-y-4">
                        <div id="protocol-steps-container" class="space-y-3">
                            </div>
                        <button onclick="addProtocolStep()" class="text-sm bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-xl hover:bg-gray-300 transition shadow-sm">+ A√±adir Paso</button>
                    </div>
                </div>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-200 flex justify-end space-x-4">
                <button onclick="closeWellConfigModal()" class="bg-gray-500 text-white font-bold py-3 px-8 rounded-xl hover:bg-gray-600 transition shadow-lg">Cancelar</button>
                <button onclick="saveWellConfig()" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-blue-700 transition shadow-lg">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <div id="model-data-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4">
        <!-- ... (CONTENIDO DEL MODAL DE DATOS DEL MODELO) ... -->
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg p-8 border-4 border-green-500/50">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">A√±adir Registro para Modelo <span id="modal-model-id" class="text-green-600 font-extrabold"></span></h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Peso (g):</label>
                    <input type="number" id="modal-model-weight" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Talla (cm):</label>
                    <input type="number" id="modal-model-size" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Glucosa (mg/dL):</label>
                    <input type="number" id="modal-model-glucose" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Fuerza Agarre (gf):</label>
                    <input type="number" id="modal-model-grip" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Notas/Otras Mediciones:</label>
                    <textarea id="modal-model-notes" rows="2" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm p-2"></textarea>
                </div>
            </div>
            <div class="mt-8 flex justify-end space-x-4 border-t pt-4">
                <button onclick="closeModelDataModal()" class="bg-gray-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-gray-600 transition shadow-md">Cancelar</button>
                <button onclick="saveModelDataEntry()" class="bg-green-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-green-700 transition shadow-md">Guardar Registro</button>
            </div>
        </div>
    </div>


    <div id="variable-template" class="hidden p-4 border rounded-xl bg-gray-50 transition hover:bg-gray-100">
        <!-- ... (CONTENIDO DE PLANTILLA DE VARIABLE) ... -->
        <div class="grid grid-cols-1 md:grid-cols-12 gap-x-4 gap-y-3 items-center">
            <div class="md:col-span-12 flex justify-between items-center border-b pb-2 mb-2">
                <input type="text" class="variable-name w-full md:w-1/3 border-0 bg-transparent font-extrabold text-gray-800 focus:ring-0 text-lg" placeholder="Nombre (Ej: PMA)">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-red-500 hover:text-red-700 font-bold transition">üóëÔ∏è Eliminar</button>
            </div>

            <label class="md:col-span-2 text-sm font-medium text-gray-700">Conc. Final:</label>
            <div class="md:col-span-4">
                <input type="number" class="variable-final-conc w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Valor">
            </div>
            <div class="md:col-span-4">
                <select class="variable-final-conc-unit w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
            </div>
            <div class="md:col-span-2">
                <button onclick="toggleSubCalc(this.dataset.target)" data-target="stock-calc-X" class="stock-calc-toggle bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 w-full text-sm transition shadow-sm">‚öôÔ∏è Stock</button>
            </div>

            <div class="sub-calc md:col-span-12 p-3 border rounded-lg bg-white mt-2 space-y-3 shadow-inner">
                <p class="text-xs font-semibold text-gray-700 border-b pb-1">Calcular volumen de stock del reactivo:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <input type="number" class="variable-stock-conc w-full text-sm border-gray-300 rounded-lg p-2" placeholder="Conc. stock">
                    <select class="variable-stock-conc-unit w-full text-sm border-gray-300 rounded-lg p-2"></select>
                </div>
                <button onclick="calculateStockVolume(this)" class="w-full text-sm bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition shadow-sm">Calcular Volumen (¬µL)</button>
                <p class="variable-stock-volume-result text-sm font-medium text-blue-700 bg-blue-100 p-2 rounded-lg"></p>
            </div>
        </div>
    </div>

    <div id="protocol-step-template" class="hidden p-3 border rounded-xl bg-white shadow-sm hover:shadow-md transition">
        <!-- ... (CONTENIDO DE PLANTILLA DE PASO) ... -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
            <input type="text" class="protocol-step-name md:col-span-1 border-gray-300 rounded-lg p-2" placeholder="Nombre (Ej: Incubaci√≥n PMA)">
            <div class="flex items-center space-x-2 md:col-span-2">
                <input type="number" class="protocol-step-duration w-1/2 border-gray-300 rounded-lg p-2" placeholder="Duraci√≥n">
                <select class="protocol-step-unit w-1/2 border-gray-300 rounded-lg p-2">
                    <option value="3600000">horas</option>
                    <option value="60000">minutos</option>
                    <option value="86400000">d√≠as</option>
                </select>
            </div>
            <div class="md:col-span-1 flex justify-end">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-red-500 hover:text-red-700 font-bold transition">üóëÔ∏è Eliminar</button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="toast fixed bottom-5 right-5 bg-green-600 text-white py-4 px-8 rounded-xl shadow-2xl z-50">
        <p id="toast-message" class="font-semibold"></p>
    </div>

    <script>
        // --- DATA & STATE MANAGEMENT ---
        const ATOMIC_WEIGHTS = { 
            'H': 1.008, 'C': 12.011, 'N': 14.007, 'O': 15.999, 'Na': 22.990, 'Mg': 24.305, 
            'P': 30.974, 'S': 32.06, 'Cl': 35.45, 'K': 39.098, 'Ca': 40.078, 'Fe': 55.845,
            'He': 4.0026, 'Li': 6.94, 'Be': 9.0122, 'B': 10.81, 'F': 18.998, 'Ne': 20.180, 'Al': 26.982, 'Si': 28.085, 'Ar': 39.948, 'Sc': 44.956, 'Ti': 47.867, 'V': 50.942, 'Cr': 51.996, 'Mn': 54.938, 'Co': 58.933, 'Ni': 58.693, 'Cu': 63.546, 'Zn': 65.38, 'Ga': 69.723, 'Ge': 72.630, 'As': 74.922, 'Se': 78.971, 'Br': 79.904, 'Kr': 83.798, 'Rb': 85.468, 'Sr': 87.62, 'Y': 88.906, 'Zr': 91.224, 'Nb': 92.906, 'Mo': 95.96, 'Tc': 98, 'Ru': 101.07, 'Rh': 102.91, 'Pd': 106.42, 'Ag': 107.87, 'Cd': 112.41, 'In': 114.82, 'Sn': 118.71, 'Sb': 121.76, 'Te': 127.60, 'I': 126.90, 'Xe': 131.29, 'Cs': 132.91, 'Ba': 137.33,
        };

        const CONVERSION_FACTORS = {
            'mass': { 'kg': 1000, 'g': 1, 'mg': 1e-3, '¬µg': 1e-6, 'ng': 1e-9, 'pg': 1e-12 },
            'volume': { 'L': 1, 'mL': 1e-3, '¬µL': 1e-6, 'nL': 1e-9 },
            'concentration': { 'M': 1, 'mM': 1e-3, '¬µM': 1e-6, 'nM': 1e-9 },
            'length': { 'm': 1, 'cm': 1e-2, 'mm': 1e-3},
            'force': { 'N': 1, 'gf': 9.80665e-3 }, 
            'pressure': { 'Pa': 1, 'mmHg': 133.322 },
        };
        
        let wellData = {}; 
        let selectedWells = new Set();
        let variableCounter = 0;
        let runningTimers = {};
        let animalModels = {}; 
        let currentEditingModelId = null; 

        // --- VARIABLES DEL CONTADOR AI ---
        let base64Images = []; // Almacena hasta 4 objetos de imagen
        let currentResults = []; // Almacena resultados de la tabla para Excel
        const MAX_SLOTS = 4;
        const CORRECTION_FACTOR = 2500; // Factor para 4 cuadrantes grandes (1 / 0.0004 mL)
        const DILUTION_FACTOR_FIXED = 1; // Diluci√≥n asumida: Muestra Pura (1:1)
        const apiKey = ""; // Clave API gestionada por el entorno
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const MAX_RETRIES = 3;


        // --- TABS & NAVIGATION ---
        function changeTab(tabName) {
            const contents = ['planner', 'models', 'protocols', 'report', 'calculators', 'guide', 'about', 'cell-counter']; 
            contents.forEach(content => {
                const el = document.getElementById(`content-${content}`);
                const tab = document.getElementById(`tab-${content}`);
                if (el) el.style.display = content === tabName ? 'block' : 'none';
                if (tab) tab.classList.toggle('active', content === tabName);
            });
            if (tabName === 'models') {
                renderAnimalModels(); 
            }
        }

        // --- UTILIDADES DE CONVERSI√ìN ---
        function getUnitType(unit) {
             if (!unit) return null;
             for (const type in CONVERSION_FACTORS) {
                 if (CONVERSION_FACTORS[type][unit]) {
                     return type;
                 }
             }
             if (unit.includes('/')) {
                 const parts = unit.split('/');
                 if (parts.length === 2 && CONVERSION_FACTORS.mass[parts[0]] && CONVERSION_FACTORS.volume[parts[1]]) {
                     return 'combined_concentration';
                 }
             }
             return null; 
        }

        function convertToBaseUnit(value, fromUnit) {
            const type = getUnitType(fromUnit);
            if (!type || isNaN(value)) return NaN;

            if (type === 'combined_concentration') {
                 const [massUnit, volUnit] = fromUnit.split('/');
                 const valueInG = value * (CONVERSION_FACTORS.mass[massUnit] || NaN);
                 const volumeInL = 1 * (CONVERSION_FACTORS.volume[volUnit] || NaN); 
                 if (isNaN(valueInG) || isNaN(volumeInL) || volumeInL === 0) return NaN;
                 return valueInG / volumeInL; 
            } else if (CONVERSION_FACTORS[type]) {
                return value * (CONVERSION_FACTORS[type][fromUnit] || NaN);
            }
            return NaN; 
        }

        function convertFromBaseUnit(value, toUnit) {
            const type = getUnitType(toUnit);
             if (!type || isNaN(value)) return NaN;

             if (type === 'combined_concentration') {
                 const [massUnit, volUnit] = toUnit.split('/');
                 const targetMassFactor = CONVERSION_FACTORS.mass[massUnit];
                 const targetVolFactor = CONVERSION_FACTORS.volume[volUnit];
                 if (!targetMassFactor || !targetVolFactor) return NaN;
                 return value * targetMassFactor / targetVolFactor;
             } else if (CONVERSION_FACTORS[type]) {
                 const factor = CONVERSION_FACTORS[type][toUnit];
                 if (!factor) return NaN;
                 return value / factor;
             }
             return NaN; 
        }

        function _pureConvertUnits(value, from, to) {
            if (isNaN(value) || !from || !to) return NaN;
            if (from === to) return value;

            const fromType = getUnitType(from);
            const toType = getUnitType(to);

             if (!fromType || !toType || fromType !== toType) {
                 return NaN; 
             }
            
            const baseValue = convertToBaseUnit(value, from);
            if (isNaN(baseValue)) return NaN;
            const finalValue = convertFromBaseUnit(baseValue, to);
             
            return finalValue;
        }

        // --- QUICK CALCULATORS (Molar Mass, Unit Conversion, Dilution) ---
        function parseFormula(formula) {
            const regex = /([A-Z][a-z]*)(\d*)|(\()|(\))(\d*)/g;
            let match;
            const stack = [{}]; 
            while ((match = regex.exec(formula))) {
                const [, element, countStr, openParen, closeParen, parenCountStr] = match;
                const count = countStr ? parseInt(countStr) : 1;
                const parenCount = parenCountStr ? parseInt(parenCountStr) : 1;

                if (element) { 
                    const currentGroup = stack[stack.length - 1];
                    currentGroup[element] = (currentGroup[element] || 0) + count;
                } else if (openParen) { 
                    stack.push({});
                } else if (closeParen && stack.length > 1) { 
                    const completedGroup = stack.pop();
                    const currentGroup = stack[stack.length - 1];
                    for (const el in completedGroup) {
                        currentGroup[el] = (currentGroup[el] || 0) + completedGroup[el] * parenCount;
                    }
                }
            }
            if (stack.length !== 1) { 
                throw new Error("Par√©ntesis no balanceados en la f√≥rmula.");
            }
            return stack[0]; 
        }


        function calculateMolarMass() {
            const formula = document.getElementById('chem-formula').value.replace(/\s+/g, ''); 
            const resultDiv = document.getElementById('molar-mass-result');
            if (!formula) {
                resultDiv.innerHTML = `<span class="text-red-500">Por favor, introduce una f√≥rmula.</span>`;
                return;
            }
            try {
                const composition = parseFormula(formula);
                let totalMass = 0;
                let breakdown = [];
                for (const element in composition) {
                    if (!ATOMIC_WEIGHTS[element]) {
                        throw new Error(`Elemento desconocido: ${element}`);
                    }
                    const mass = ATOMIC_WEIGHTS[element] * composition[element];
                    totalMass += mass;
                    breakdown.push(`<b>${element}</b>: ${composition[element]} x ${ATOMIC_WEIGHTS[element]} = ${mass.toFixed(4)}`);
                }
                resultDiv.innerHTML = `<b>Masa Molar Total: <span class="text-blue-600">${totalMass.toFixed(4)} g/mol</span></b><br><small>${breakdown.join('<br>')}</small>`;
            } catch (error) {
                resultDiv.innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
            }
        }
        
        function convertUnits() {
            const value = parseFloat(document.getElementById('uc-value').value);
            const from = document.getElementById('uc-from').value;
            const to = document.getElementById('uc-to').value;
            const resultDiv = document.getElementById('uc-result');

            const finalValue = _pureConvertUnits(value, from, to);
            
            if (isNaN(finalValue)) {
                 resultDiv.innerHTML = `<span class="text-red-500">No se puede convertir entre estas unidades o tipos.</span>`;
            } else {
                 resultDiv.textContent = `${value} ${from} = ${finalValue.toExponential(4)} ${to}`;
            }
        }

        function calculateDilution() {
            const fields = {
                c1: { val: parseFloat(document.getElementById('c1').value), unit: document.getElementById('c1-unit').value },
                v1: { val: parseFloat(document.getElementById('v1').value), unit: document.getElementById('v1-unit').value },
                c2: { val: parseFloat(document.getElementById('c2').value), unit: document.getElementById('c2-unit').value },
                v2: { val: parseFloat(document.getElementById('v2').value), unit: document.getElementById('v2-unit').value },
            };

            const resultDiv = document.getElementById('dilution-result');
            const emptyFields = Object.keys(fields).filter(k => isNaN(fields[k].val));

            if (emptyFields.length !== 1) {
                resultDiv.innerHTML = `<span class="text-red-500">Por favor, introduce exactamente 3 valores num√©ricos.</span>`;
                return;
            }

            const missingVar = emptyFields[0];
            let result;
            let resultUnit;

            try {
                 const c2_conv = _pureConvertUnits(fields.c2.val, fields.c2.unit, fields.c1.unit);
                 const v2_conv = _pureConvertUnits(fields.v2.val, fields.v2.unit, fields.v1.unit);
                
                if (isNaN(c2_conv) && !isNaN(fields.c2.val)) throw new Error(`No se puede convertir la unidad de C2 (${fields.c2.unit}) a la de C1 (${fields.c1.unit}). Aseg√∫rate que son del mismo tipo (ej. ambas molares o ambas masa/volumen).`);
                if (isNaN(v2_conv) && !isNaN(fields.v2.val)) throw new Error(`No se puede convertir la unidad de V2 (${fields.v2.unit}) a la de V1 (${fields.v1.unit}).`);

                let c1_val = fields.c1.val;
                let v1_val = fields.v1.val;

                switch (missingVar) {
                    case 'c1': 
                        result = (c2_conv * v2_conv) / v1_val;
                        resultUnit = fields.c1.unit; 
                        break;
                    case 'v1': 
                        result = (c2_conv * v2_conv) / c1_val;
                        resultUnit = fields.v1.unit; 
                        break;
                    case 'c2': 
                        const c2_in_c1_units = (c1_val * v1_val) / v2_conv; 
                        result = _pureConvertUnits(c2_in_c1_units, fields.c1.unit, fields.c2.unit);
                        resultUnit = fields.c2.unit;
                        break;
                    case 'v2': 
                        const v2_in_v1_units = (c1_val * v1_val) / c2_conv;
                        result = _pureConvertUnits(v2_in_v1_units, fields.v1.unit, fields.v2.unit);
                        resultUnit = fields.v2.unit;
                        break;
                }

                if (isNaN(result) || !isFinite(result)) {
                    throw new Error("El resultado es inv√°lido. Revisa los valores y unidades.");
                }

                resultDiv.textContent = `Resultado: ${missingVar.toUpperCase()} = ${result.toPrecision(4)} ${resultUnit}`;

            } catch (error) {
                 resultDiv.innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
            }
        }


        // --- CONTADOR CELULAR AI FUNCTIONS ---

        /** Inicializa los slots de carga de im√°genes */
        function initializeUploadSlots() {
            const cellUploadSlotsContainer = document.getElementById('cellUploadSlots');
            const cellUploadSlotTemplate = document.getElementById('cellUploadSlotTemplate');
            
            // Limpiar slots existentes antes de inicializar
            cellUploadSlotsContainer.innerHTML = ''; 
            base64Images = [];

            for (let i = 1; i <= MAX_SLOTS; i++) {
                const slot = cellUploadSlotTemplate.content.cloneNode(true);
                const container = slot.querySelector('div');
                const label = container.querySelector('[data-slot-label]');
                const input = container.querySelector('.cell-upload-input');
                const preview = container.querySelector('.image-preview-slot');
                const clearButton = container.querySelector('.clear-button');

                label.textContent = `Regi√≥n ${i}`;
                input.id = `imageUpload${i}`;
                input.dataset.slotIndex = i;
                preview.dataset.slotIndex = i;
                clearButton.dataset.slotIndex = i;
                clearButton.onclick = function() { clearImageSlot(this); };
                input.onchange = function(event) { handleImageUpload(event, this); };

                cellUploadSlotsContainer.appendChild(slot);
                base64Images[i] = null; // Inicializar array
            }
            updateAnalyzeButtonState();
        }

        /**
         * Convierte el archivo seleccionado a una cadena base64.
         */
        function getBase64Image(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const [mimeTypePart, dataPart] = reader.result.split(',');
                    const mimeType = mimeTypePart.match(/:(.*?);/)[1];
                    resolve({ data: dataPart, mimeType: mimeType });
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /**
         * Maneja la carga de la imagen en un slot espec√≠fico.
         */
        async function handleImageUpload(event, inputElement) {
            document.getElementById('errorCard').classList.add('hidden');
            document.getElementById('resultsContent').innerHTML = '<p>Los resultados del conteo aparecer√°n aqu√≠ en una tabla detallada por cada regi√≥n cargada.</p>';
            document.getElementById('downloadExcelButton').classList.add('hidden');
            document.getElementById('totalSummary').classList.add('hidden');
            currentResults = [];
            
            const slotIndex = parseInt(inputElement.dataset.slotIndex);
            const file = inputElement.files[0];
            const preview = inputElement.nextElementSibling;
            const clearButton = inputElement.nextElementSibling.nextElementSibling;

            if (file) {
                preview.src = URL.createObjectURL(file);
                try {
                    const result = await getBase64Image(file);
                    base64Images[slotIndex] = { ...result, slotIndex };
                    clearButton.classList.remove('hidden');
                } catch (error) {
                    console.error("Error al leer el archivo:", error);
                    base64Images[slotIndex] = null;
                    clearButton.classList.add('hidden');
                }
            } else {
                clearImageSlot(clearButton);
            }
            updateAnalyzeButtonState();
        }

        /** Limpia un slot de imagen. */
        function clearImageSlot(buttonElement) {
            const slotIndex = parseInt(buttonElement.dataset.slotIndex);
            const container = buttonElement.closest('div');
            const input = container.querySelector('.cell-upload-input');
            const preview = container.querySelector('.image-preview-slot');

            input.value = ''; // Resetear el input file
            preview.src = `https://placehold.co/150x150/e5e7eb/9ca3af?text=Slot`;
            base64Images[slotIndex] = null;
            buttonElement.classList.add('hidden');
            updateAnalyzeButtonState();
        }

        /** Habilita/deshabilita el bot√≥n de an√°lisis. */
        function updateAnalyzeButtonState() {
            const loadedImages = base64Images.filter(img => img !== null && img !== undefined);
            const analyzeButton = document.getElementById('analyzeButton');
            if (loadedImages.length > 0) {
                analyzeButton.disabled = false;
                analyzeButton.classList.replace('bg-gray-400', 'bg-blue-600');
                analyzeButton.classList.add('hover:bg-blue-700');
            } else {
                analyzeButton.disabled = true;
                analyzeButton.classList.replace('bg-blue-600', 'bg-gray-400');
                analyzeButton.classList.remove('hover:bg-blue-700');
            }
        }
        
        /**
         * Formato de n√∫meros grandes con separador de miles.
         */
        function formatNumber(num) {
            if (num === 0) return '0';
            const options = { maximumSignificantDigits: 4 };
            return new Intl.NumberFormat('es-MX', options).format(num);
        }

        /**
         * Calcula la concentraci√≥n final de la muestra.
         * C√©lulas/mL = (Conteo Total / N Cuadrantes) * 1 (Diluci√≥n Fija) * 2,500
         */
        function calculateConcentration(totalCount) {
            const dilutionFactor = DILUTION_FACTOR_FIXED; 
            const numRegions = base64Images.filter(img => img !== null && img !== undefined).length;
            
            if (totalCount === 0 || numRegions === 0) return 0;

            const averageCountPerRegion = totalCount / numRegions; 
            const concentration = averageCountPerRegion * dilutionFactor * CORRECTION_FACTOR;

            return concentration;
        }


        /**
         * Llama a la API de Gemini para analizar las im√°genes.
         */
        async function analyzeImage() {
            const loadedImages = base64Images.filter(img => img !== null && img !== undefined);
            const analyzeButton = document.getElementById('analyzeButton');
            const loadingIndicator = document.getElementById('loadingIndicator');

            if (loadedImages.length === 0) {
                displayError("Carga al menos una imagen para analizar.");
                return;
            }

            document.getElementById('errorCard').classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            analyzeButton.disabled = true;
            analyzeButton.textContent = 'Analizando...';
            document.getElementById('resultsContent').innerHTML = '';
            document.getElementById('downloadExcelButton').classList.add('hidden');
            document.getElementById('totalSummary').classList.add('hidden');
            currentResults = [];

            // Construir la lista de partes del contenido (texto + im√°genes)
            const parts = [{ 
                text: `Analiza las ${loadedImages.length} im√°genes proporcionadas. Identif√≠calas como Regi√≥n ${loadedImages.map(img => img.slotIndex).join(', Regi√≥n ')}. Para cada imagen, realiza el conteo total de c√©lulas. Luego, proporciona un an√°lisis estructurado y profesional. Tu respuesta debe ser una lista numerada (1. Regi√≥n X, 2. Regi√≥n Y, etc.) donde cada entrada contiene: a) El conteo total como primer valor num√©rico, y b) una descripci√≥n con las siguientes secciones obligatorias, usando el formato **T√≠tulo** para los encabezados: **CONTEO Y DENSIDAD**, **MORFOLOG√çA CELULAR**, **DISTRIBUCI√ìN EN LA CUADR√çCULA**, y **APUNTES ADICIONALES**. No incluyas ning√∫n saludo, introducci√≥n o descripci√≥n de tu persona ni notas de cierre.` 
            }];

            loadedImages.forEach(img => {
                parts.push({
                    inlineData: {
                        mimeType: img.mimeType,
                        data: img.data
                    }
                });
            });

            const systemPrompt = "Eres un sistema de an√°lisis de im√°genes cuyo √∫nico objetivo es ejecutar la tarea solicitada. Genera el resultado del an√°lisis de las im√°genes de la c√°mara de Neubauer. Tu respuesta debe ser concisa, profesional y limitarse estrictamente a la informaci√≥n solicitada sin pre√°mbulos, descripciones de tu rol, ni notas de cierre. El primer elemento de cada entrada de la lista debe ser el n√∫mero total de c√©lulas contado para esa imagen.";

            const payload = {
                contents: [{ role: "user", parts }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    // --- NUEVA L√ìGICA DE MANEJO DE RESPUESTA ROBUSTA ---
                    const responseText = await response.text();
                    let result;

                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        // Captura el error de sintaxis JSON (ej: Unexpected end of input)
                        if (!response.ok) {
                            // Si el status NO es OK y falla JSON, es un error HTTP con respuesta malformada
                            throw new Error(`Error HTTP ${response.status} (${response.statusText}). La respuesta no es JSON v√°lido. Contenido: ${responseText.substring(0, 100)}...`);
                        }
                        // Si el status S√ç es OK (200) pero falla JSON (cuerpo vac√≠o o incompleto)
                        throw new Error(`Error de sintaxis JSON, la respuesta de la API fue inv√°lida. Contenido: ${responseText.substring(0, 100)}...`);
                    }

                    if (!response.ok) {
                        // Si la respuesta fue HTTP error pero el cuerpo s√≠ era JSON v√°lido.
                        throw new Error(`Error HTTP ${response.status} (${response.statusText}): ${result.error?.message || 'Fallo en la llamada a la API.'}`);
                    }
                    // --- FIN L√ìGICA DE MANEJO DE RESPUESTA ---

                    // Continuar con el procesamiento del resultado
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        formatAndDisplayResult(text);
                        return; // √âxito, salir del bucle
                    } else {
                        // El JSON es v√°lido (cuerpo no vac√≠o), pero faltan los datos esperados
                        throw new Error("La respuesta de la IA no conten√≠a texto generado (candidatos vac√≠os o estructura inesperada).");
                    }

                } catch (error) {
                    console.error(`Intento ${i + 1} fallido:`, error);
                    if (i === MAX_RETRIES - 1) {
                        displayError(`No se pudo completar el an√°lisis despu√©s de ${MAX_RETRIES} intentos. Error: ${error.message}`);
                    } else {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    }
                } finally {
                    loadingIndicator.classList.add('hidden');
                    updateAnalyzeButtonState(); 
                    analyzeButton.textContent = 'Paso 3: Analizar y Calcular Concentraci√≥n';
                }
            }
        }

        /**
         * Formatea el resultado de texto de la IA (m√∫ltiples regiones) en una tabla y lo muestra.
         */
        function formatAndDisplayResult(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            const regionData = [];
            let totalCount = 0;
            let currentRegion = {};

            // Expresi√≥n para detectar el inicio de una nueva regi√≥n (ej. "1. Regi√≥n X" o "1.")
            const regionStartRegex = /^(\d+\.\s*|\[?Regi√≥n\s*(\d+)\]?\.?)(.*)/i; 
            
            // Reconstruir la data basada en las l√≠neas
            lines.forEach(line => {
                const match = line.match(regionStartRegex);
                
                if (match) {
                    if (currentRegion.Region) {
                        regionData.push(currentRegion);
                    }
                    
                    let regionText = match[0];
                    let countMatch = regionText.match(/(\d+)/);
                    let count = countMatch ? parseInt(countMatch[1]) : 0;
                    
                    let regionNumber = match[2] ? parseInt(match[2]) : (regionData.length + 1);

                    currentRegion = {
                        Region: `Regi√≥n ${regionNumber}`,
                        Conteo: count,
                        Interpretacion: line.replace(countMatch ? countMatch[0] : '', '').trim()
                    };
                    
                    if (!countMatch) {
                        const innerCountMatch = line.match(/\*\*CONTEO Y DENSIDAD\*\*.*?(\d+)/i);
                        currentRegion.Conteo = innerCountMatch ? parseInt(innerCountMatch[1]) : 0;
                    }

                    totalCount += currentRegion.Conteo;

                } else if (currentRegion.Region) {
                    currentRegion.Interpretacion += '\n' + line;
                }
            });

            if (currentRegion.Region) {
                regionData.push(currentRegion);
            }

            // CALCULAR CONCENTRACI√ìN
            const finalConcentration = calculateConcentration(totalCount);
            const numRegions = base64Images.filter(img => img !== null && img !== undefined).length;
            
            // Actualizar visualizaci√≥n del resumen
            document.getElementById('totalCountDisplay').textContent = formatNumber(totalCount);
            document.getElementById('finalConcentrationDisplay').textContent = formatNumber(finalConcentration);
            document.getElementById('calcRegions').textContent = numRegions;


            // Mapear los resultados para la tabla HTML y el Excel
            currentResults = regionData.map(data => {
                const interpretationHTML = data.Interpretacion
                    .replace(/\*\*(.*?)\*\*/g, '<h4>$1</h4>') // Markdown a <h4>
                    .split('\n').map(line => line.trim() === '' ? '<br>' : line).join('');

                return {
                    'Regi√≥n': data.Region,
                    'Conteo': data.Conteo,
                    'Interpretaci√≥n (HTML)': interpretationHTML,
                    'Interpretaci√≥n (Texto Simple)': data.Interpretacion.replace(/<\/?h4>/g, ' ').replace(/<br>/g, ' ').replace(/\s+/g, ' ').trim() // Para Excel
                };
            });
            
            // Generar HTML de la tabla
            let tableHtml = `
                <div class="table-responsive">
                    <table id="cell-counter-results-table" class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">Regi√≥n</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">C√©lulas Contadas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10/12">Interpretaci√≥n y An√°lisis Morfol√≥gico</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;

            currentResults.forEach(data => {
                tableHtml += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 align-top">${data['Regi√≥n']}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-green-600 align-top">
                            <span class="text-xl font-extrabold">${data.Conteo}</span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500 interpretation-content">
                            ${data['Interpretaci√≥n (HTML)']}
                        </td>
                    </tr>
                `;
            });

            tableHtml += `</tbody></table></div>`;
            
            document.getElementById('resultsContent').innerHTML = tableHtml;
            document.getElementById('totalSummary').classList.remove('hidden');
            document.getElementById('downloadExcelButton').classList.remove('hidden'); 
        }

        /**
         * Muestra un mensaje de error y limpia el estado de carga.
         */
        function displayError(message) {
            document.getElementById('loadingIndicator').classList.add('hidden');
            document.getElementById('analyzeButton').disabled = false;
            document.getElementById('analyzeButton').textContent = 'Paso 3: Analizar y Calcular Concentraci√≥n';
            document.getElementById('errorCard').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('downloadExcelButton').classList.add('hidden');
            document.getElementById('totalSummary').classList.add('hidden');
        }

        /**
         * Descarga los resultados actuales en un archivo Excel.
         */
        function downloadExcel() {
            if (currentResults.length === 0) {
                document.getElementById('errorMessage').textContent = "No hay resultados para descargar.";
                document.getElementById('errorCard').classList.remove('hidden');
                return;
            }

            const totalCount = currentResults.reduce((sum, item) => sum + item['Conteo'], 0);
            const finalConcentration = calculateConcentration(totalCount);
            
            // Preparamos los datos para Excel (usando solo las columnas de texto simple)
            const excelData = currentResults.map(data => ({
                'Regi√≥n': data['Regi√≥n'],
                'C√©lulas Contadas': data['Conteo'],
                'An√°lisis Detallado': data['Interpretaci√≥n (Texto Simple)']
            }));
            
            // A√±adir la fila de resumen
            excelData.push(
                {}, 
                {
                    'Regi√≥n': 'RESUMEN TOTAL',
                    'C√©lulas Contadas': totalCount,
                    'An√°lisis Detallado': 'Suma total de c√©lulas contadas en todas las regiones.'
                },
                {
                    'Regi√≥n': 'CONCENTRACI√ìN FINAL (C√©lulas/mL)',
                    'C√©lulas Contadas': finalConcentration,
                    'An√°lisis Detallado': `C√°lculo: (Conteo Promedio) x 2,500. Se asume Diluci√≥n 1:1. Regiones Contadas: ${currentResults.length}.`
                }
            );

            const worksheet = XLSX.utils.json_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Conteo Celular Multirregi√≥n");
            XLSX.writeFile(workbook, `resultados_conteo_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }
        
        // --- PLATE PLANNER ---
        function generatePlate(restoringData = null) {
            const plateType = restoringData ? restoringData.plateType : document.getElementById('plate-type').value;
            document.getElementById('plate-type').value = plateType; 
            const layout = document.getElementById('plate-layout');
            layout.innerHTML = ''; 
            
            if (!restoringData) {
                wellData = {};
            }
            selectedWells.clear(); 

            const plateConfigs = {
                '6': { rows: 2, cols: 3 }, '12': { rows: 3, cols: 4 },
                '24': { rows: 4, cols: 6 }, '48': { rows: 6, cols: 8 },
                '96': { rows: 8, cols: 12 },
            };
            const config = plateConfigs[plateType];
            layout.style.gridTemplateColumns = `repeat(${config.cols}, minmax(0, 1fr))`;
            layout.style.display = 'grid';

            for (let r = 0; r < config.rows; r++) {
                for (let c = 0; c < config.cols; c++) {
                    const rowLabel = String.fromCharCode(65 + r); 
                    const colLabel = c + 1; 
                    const wellId = `${rowLabel}${colLabel}`; 
                    
                    const well = document.createElement('div');
                    well.id = `well-${wellId}`;
                    well.className = 'well w-12 h-12 md:w-16 md:h-16 rounded-full flex items-center justify-center cursor-pointer bg-white';
                    well.dataset.id = wellId;
                    
                    const label = document.createElement('span');
                    label.className = 'well-label text-sm md:text-base font-semibold';
                    label.textContent = wellId;
                    well.appendChild(label);

                    well.addEventListener('click', () => toggleWellSelection(wellId));
                    layout.appendChild(well); 

                    if (restoringData?.wellData?.[wellId]) {
                        const data = restoringData.wellData[wellId];
                        well.classList.add('configured'); 
                        if (data.wellType && data.wellType !== 'default') {
                            well.classList.add(data.wellType);
                        }
                    }
                }
            }
            updateProtocolSchedule(); 
        }


        function toggleWellSelection(wellId) {
            const wellEl = document.getElementById(`well-${wellId}`);
            if (selectedWells.has(wellId)) { 
                selectedWells.delete(wellId);
                wellEl.classList.remove('selected');
            } else { 
                selectedWells.add(wellId);
                wellEl.classList.add('selected');
            }
        }

        function selectAllWells() {
            document.querySelectorAll('#plate-layout .well').forEach(well => {
                const wellId = well.dataset.id;
                if (!selectedWells.has(wellId)) { 
                    selectedWells.add(wellId);
                    well.classList.add('selected');
                }
            });
        }
        
        function clearSelection() {
            selectedWells.forEach(wellId => { 
                const wellEl = document.getElementById(`well-${wellId}`);
                if (wellEl) wellEl.classList.remove('selected');
            });
            selectedWells.clear(); 
        }

        function openWellConfigModal() {
            if (selectedWells.size === 0) { 
                showToast('Por favor, selecciona al menos un pozo para configurar.', 'error');
                return;
            }
            const wellIds = Array.from(selectedWells).sort(); 
            document.getElementById('well-ids-display').textContent = wellIds.join(', ');
            
            const firstWellId = wellIds[0];
            if (wellData[firstWellId]) {
                loadConfigToModal(wellData[firstWellId]); 
            } else {
                resetModal(); 
            }

            document.getElementById('well-config-modal').style.display = 'flex';
        }

        function closeWellConfigModal() {
            document.getElementById('well-config-modal').style.display = 'none'; 
        }
        
        function resetModal() {
             document.getElementById('well-type').value = 'default';
             document.getElementById('well-total-volume').value = '';
             document.getElementById('well-cell-count').value = '';
             document.getElementById('variables-container').innerHTML = ''; 
             document.getElementById('protocol-steps-container').innerHTML = ''; 
             document.getElementById('neubauer-q1').value = '';
             document.getElementById('neubauer-q2').value = '';
             document.getElementById('neubauer-q3').value = '';
             document.getElementById('neubauer-q4').value = '';
             document.getElementById('cell-stock-conc').value = '';
             document.getElementById('cell-stock-conc-unit').value = '1'; 
             document.getElementById('cell-volume-result').textContent = '';
             variableCounter = 0; 
             addVariable(); 
             addProtocolStep(); 
        }


        function loadConfigToModal(data) {
            resetModal(); 
             document.getElementById('well-type').value = data.wellType || 'default';
             document.getElementById('well-total-volume').value = data.totalVolume || '';
             document.getElementById('well-cell-count').value = data.cells?.count || '';
            
            const variablesContainer = document.getElementById('variables-container');
            variablesContainer.innerHTML = ''; 
            if (data.variables?.length > 0) {
                data.variables.forEach(v => addVariable(v)); 
            } else {
                addVariable(); 
            }
            
            const stepsContainer = document.getElementById('protocol-steps-container');
            stepsContainer.innerHTML = ''; 
            if (data.protocol?.steps?.length > 0) {
                data.protocol.steps.forEach(s => addProtocolStep(s)); 
            } else {
                addProtocolStep(); 
            }
        }


        function saveWellConfig() {
            const wellType = document.getElementById('well-type').value;
            const totalVolume = parseFloat(document.getElementById('well-total-volume').value);
            const cellCount = parseFloat(document.getElementById('well-cell-count').value);

            const variables = [];
            document.querySelectorAll('#variables-container > div.p-4').forEach(varDiv => { 
                const variable = {
                    id: varDiv.dataset.id, 
                    name: varDiv.querySelector('.variable-name').value.trim(),
                    finalConc: parseFloat(varDiv.querySelector('.variable-final-conc').value),
                    finalConcUnit: varDiv.querySelector('.variable-final-conc-unit').value,
                };
                if (variable.name && !isNaN(variable.finalConc)) {
                    variables.push(variable);
                }
            });
            
            const protocolSteps = [];
            document.querySelectorAll('#protocol-steps-container > div').forEach(stepDiv => {
                const step = {
                    name: stepDiv.querySelector('.protocol-step-name').value.trim(),
                    duration: parseFloat(stepDiv.querySelector('.protocol-step-duration').value),
                    unit: parseInt(stepDiv.querySelector('.protocol-step-unit').value) 
                };
                if (step.name && !isNaN(step.duration)) {
                    protocolSteps.push(step);
                }
            });

            const configData = {
                wellType,
                totalVolume: isNaN(totalVolume) ? null : totalVolume, 
                cells: { count: isNaN(cellCount) ? null : cellCount }, 
                variables,
                protocol: {
                    steps: protocolSteps
                }
            };
            
            selectedWells.forEach(wellId => {
                wellData[wellId] = JSON.parse(JSON.stringify(configData)); 
                const wellEl = document.getElementById(`well-${wellId}`);
                if (wellEl) {
                     wellEl.classList.remove('control', 'experimental', 'blanco', 'tratamiento-1', 'tratamiento-2', 'default');
                    if (wellType !== 'default') {
                        wellEl.classList.add(wellType); 
                    }
                    wellEl.classList.add('configured'); 
                    wellEl.classList.remove('selected'); 
                }
            });
            
            updateProtocolSchedule(); 
            clearSelection(); 
            closeWellConfigModal(); 
            showToast('Configuraci√≥n guardada para los pozos seleccionados.'); 
        }
        
        function addVariable(data = null) {
            const template = document.getElementById('variable-template');
            const clone = template.cloneNode(true); 
            clone.id = ''; 
            clone.classList.remove('hidden'); 
            
            const uniqueId = `var-${variableCounter++}`; 
            clone.dataset.id = uniqueId; 

            populateUnitDropdowns(clone); 
            
            const stockCalcToggle = clone.querySelector('.stock-calc-toggle');
            const subCalcDiv = clone.querySelector('.sub-calc');
            const subCalcId = `stock-calc-${uniqueId}`;
            stockCalcToggle.dataset.target = subCalcId; 
            subCalcDiv.id = subCalcId; 
            
            if (data) {
                 clone.querySelector('.variable-name').value = data.name || '';
                 clone.querySelector('.variable-final-conc').value = data.finalConc || '';
                 clone.querySelector('.variable-final-conc-unit').value = data.finalConcUnit || '¬µM'; 
            }

            document.getElementById('variables-container').appendChild(clone);
        }

        function addProtocolStep(data = null) {
            const template = document.getElementById('protocol-step-template');
            const clone = template.cloneNode(true); 
            clone.id = ''; 
            clone.classList.remove('hidden'); 
            if (data) {
                clone.querySelector('.protocol-step-name').value = data.name || '';
                clone.querySelector('.protocol-step-duration').value = data.duration || '';
                clone.querySelector('.protocol-step-unit').value = data.unit || '3600000'; 
            }
            document.getElementById('protocol-steps-container').appendChild(clone);
        }

        function calculateCellVolume() {
            const cellCount = parseFloat(document.getElementById('well-cell-count').value);
            let stockConc = parseFloat(document.getElementById('cell-stock-conc').value); 
            const stockUnitFactor = parseFloat(document.getElementById('cell-stock-conc-unit').value); 
            const resultEl = document.getElementById('cell-volume-result');

            if (isNaN(cellCount) || isNaN(stockConc) || stockConc === 0) {
                resultEl.textContent = 'Inputs inv√°lidos.';
                return;
            }
            
            const stockConcInMl = stockConc * stockUnitFactor;

            const volumeInMicroL = (cellCount / stockConcInMl) * 1000;
             // Display result
            resultEl.textContent = `Tomar: ${volumeInMicroL.toFixed(2)} ¬µL`;
        }

        function calculateNeubauer() {
             const q1 = parseFloat(document.getElementById('neubauer-q1').value) || 0;
            const q2 = parseFloat(document.getElementById('neubauer-q2').value) || 0;
            const q3 = parseFloat(document.getElementById('neubauer-q3').value) || 0;
            const q4 = parseFloat(document.getElementById('neubauer-q4').value) || 0;

            const sum = q1 + q2 + q3 + q4;
            if (sum === 0) { 
                showToast("Introduce los conteos de los cuadrantes.", "error");
                return;
            }
            const avg = sum / 4; 
            const concentration = avg * 10000; 
            
            document.getElementById('cell-stock-conc-unit').value = "1"; 
            document.getElementById('cell-stock-conc').value = concentration; 
            showToast(`Concentraci√≥n calculada: ${concentration.toExponential(2)} c√©lulas/mL.`); 
             calculateCellVolume(); 
        }

        function calculateStockVolume(button) {
             const variableSection = button.closest('.p-4.border.rounded-lg.bg-gray-50'); 
            if (!variableSection) return; 

            const finalConc = parseFloat(variableSection.querySelector('.variable-final-conc').value);
            const finalConcUnit = variableSection.querySelector('.variable-final-conc-unit').value;
            const stockConc = parseFloat(variableSection.querySelector('.variable-stock-conc').value);
            const stockConcUnit = variableSection.querySelector('.variable-stock-conc-unit').value;
             const totalVolume = parseFloat(document.getElementById('well-total-volume').value); 
            const resultEl = variableSection.querySelector('.variable-stock-volume-result');

            if (isNaN(finalConc) || isNaN(stockConc) || isNaN(totalVolume) || stockConc === 0) {
                 resultEl.textContent = 'Inputs inv√°lidos.';
                 return;
            }
            
            const finalConcConverted = _pureConvertUnits(finalConc, finalConcUnit, stockConcUnit);
            if (isNaN(finalConcConverted)) { 
                 resultEl.textContent = 'Error de conversi√≥n de unidad.';
                 return;
            }

            const V_Stock_in_uL = (finalConcConverted * totalVolume) / stockConc;

             // Display result
            resultEl.textContent = `Tomar: ${V_Stock_in_uL.toFixed(3)} ¬µL`;
        }
        
        function calculateMasterMix() {
            if (selectedWells.size === 0) {
                showToast("Selecciona los pozos para los que quieres calcular la mezcla.", 'error');
                return;
            }
            
            const numWells = selectedWells.size;
            const extraVolFactor = 1 + (parseFloat(document.getElementById('extra-volume').value) || 0) / 100;
            const totalWellsToPrep = numWells * extraVolFactor;

            const masterMix = {};
            let firstWellId = Array.from(selectedWells)[0];
            const baseConfig = wellData[firstWellId];

            if (!baseConfig) { 
                showToast("El primer pozo seleccionado no est√° configurado.", 'error');
                return;
            }

            if (baseConfig.cells?.count > 0) {
                masterMix['C√©lulas'] = { 
                    total: `${(baseConfig.cells.count * totalWellsToPrep).toExponential(2)} c√©lulas`,
                    note: 'El volumen a tomar depende de la concentraci√≥n de tu stock celular.'
                };
            }
            
            baseConfig.variables.forEach(v => {
                 masterMix[v.name] = {
                     total: `A√±adir para una concentraci√≥n final de ${v.finalConc} ${v.finalConcUnit}`,
                     note: 'El volumen a tomar depende de la concentraci√≥n de tu reactivo stock.'
                 };
            });
            
            let html = `<h3 class="font-bold mb-2">Receta para ${numWells} pozos (+${(extraVolFactor-1)*100}% extra):</h3>`;
            html += `<table class="min-w-full divide-y divide-gray-200">
                         <thead class="bg-gray-100"><tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Componente</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Cantidad Total / Objetivo</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Notas</th>
                        </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

            for(const component in masterMix) { 
                html += `<tr>
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium">${component}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm">${masterMix[component].total}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${masterMix[component].note}</td>
                          </tr>`;
            }
            
             html += `<tr><td class="px-4 py-2 text-sm font-bold">Medio de cultivo (completar hasta)</td>
                              <td class="px-4 py-2 text-sm font-bold">${(baseConfig.totalVolume * totalWellsToPrep).toFixed(2)} ¬µL</td><td></td></tr>`;

            html += `</tbody></table><p class="text-xs mt-2 text-gray-500">Usa las sub-calculadoras en la configuraci√≥n de pozos para determinar los vol√∫menes exactos a tomar de tus stocks.</p>`;
            document.getElementById('master-mix-results').innerHTML = html;
        }

        function updateProtocolSchedule() {
            const scheduleContainer = document.getElementById('protocol-schedule-container');
            scheduleContainer.innerHTML = ''; 
            let allSteps = [];

            for (const wellId in wellData) {
                const data = wellData[wellId];
                if (!data.protocol?.steps) continue; 
                
                data.protocol.steps.forEach((step, index) => {
                    allSteps.push({ 
                        ...step, 
                        wellId, 
                        stepIndex: index + 1, 
                        eventId: `${wellId}-${step.name.replace(/\s/g, '')}-${index}` 
                    });
                });
            }
            
            const uniqueSteps = Object.values(allSteps.reduce((acc, cur) => {
                const key = `${cur.name}-${cur.duration}-${cur.unit}-${cur.stepIndex}`; 
                if (!acc[key]) {
                     acc[key] = { ...cur, wells: [cur.wellId] }; 
                } else {
                    acc[key].wells.push(cur.wellId); 
                }
                return acc;
            }, {}));
            
            uniqueSteps.sort((a,b) => a.stepIndex - b.stepIndex);


            if (uniqueSteps.length === 0) { 
                scheduleContainer.innerHTML = '<p class="text-gray-500">No hay pasos de protocolo configurados.</p>';
                return;
            }

            uniqueSteps.forEach((step) => {
                const durationMs = step.duration * step.unit; 
                 const unitText = {3600000: 'horas', 60000: 'minutos', 86400000: 'd√≠as'}[step.unit] || 'ms';

                const eventEl = document.createElement('div');
                eventEl.className = 'flex items-center justify-between p-3 bg-gray-100 rounded-lg';
                eventEl.innerHTML = `
                    <div>
                        <span class="font-bold">Paso ${step.stepIndex}: ${step.name}</span>
                        <span class="text-sm text-gray-600 ml-2">(${step.duration} ${unitText})</span>
                        <p class="text-xs text-blue-600">Pozos: ${step.wells.join(', ')}</p> 
                    </div>
                    <div class="flex items-center space-x-3">
                        <span id="timer-display-${step.eventId}" class="font-mono text-lg">--:--:--</span>
                        <button id="timer-btn-${step.eventId}" class="bg-green-500 text-white text-sm font-semibold py-1 px-3 rounded-md hover:bg-green-600">Iniciar</button>
                    </div>
                `;
                scheduleContainer.appendChild(eventEl); 
                
                document.getElementById(`timer-btn-${step.eventId}`).addEventListener('click', (e) => {
                    handleTimerClick(e, step, durationMs);
                });
            });
        }
        
        function handleTimerClick(e, event, durationMs) {
            const btn = e.target;
            const timerId = `timer-btn-${event.eventId}`; 
            const displayId = `timer-display-${event.eventId}`; 

            if (runningTimers[timerId]) { 
                clearInterval(runningTimers[timerId].interval); 
                delete runningTimers[timerId]; 
                btn.textContent = 'Iniciar'; 
                btn.classList.add('bg-green-500', 'hover:bg-green-600');
                btn.classList.remove('bg-red-500', 'hover:bg-red-600');
                document.getElementById(displayId).textContent = '--:--:--'; 
            } else { 
                const endTime = Date.now() + durationMs; 
                btn.textContent = 'Detener'; 
                btn.classList.remove('bg-green-500', 'hover:bg-green-600');
                btn.classList.add('bg-red-500', 'hover:bg-red-600');

                const updateDisplay = () => {
                    const remaining = endTime - Date.now();
                    if (remaining <= 0) { 
                        clearInterval(interval); 
                        document.getElementById(displayId).textContent = '00:00:00';
                        const notificationMessage = `¬°Paso finalizado: ${event.name}!`;
                        showToast(notificationMessage); 
                        if (Notification.permission === 'granted') {
                            new Notification(notificationMessage);
                        }
                        btn.textContent = 'Finalizado'; 
                        btn.disabled = true; 
                        btn.classList.remove('bg-red-500', 'hover:bg-red-600'); 
                        delete runningTimers[timerId]; 
                    } else { 
                        const h = String(Math.floor(remaining / 3600000)).padStart(2, '0');
                        const m = String(Math.floor((remaining % 3600000) / 60000)).padStart(2, '0');
                        const s = String(Math.floor((remaining % 60000) / 1000)).padStart(2, '0');
                        document.getElementById(displayId).textContent = `${h}:${m}:${s}`; 
                    }
                };

                const interval = setInterval(updateDisplay, 1000);
                updateDisplay();
                runningTimers[timerId] = { interval, endTime };
            }
        }
        
        // --- ANIMAL MODELS ---
        function addAnimalModel() {
            const modelIdInput = document.getElementById('new-model-id');
            const modelId = modelIdInput.value.trim();
            if (!modelId) {
                showToast("Por favor, introduce un ID para el nuevo modelo.", "error");
                return;
            }
            if (animalModels[modelId]) {
                 showToast(`El modelo con ID "${modelId}" ya existe.`, "error");
                return;
            }
            animalModels[modelId] = { id: modelId, data: [] }; 
            modelIdInput.value = ''; 
            renderAnimalModels(); 
            showToast(`Modelo "${modelId}" a√±adido.`);
        }

        function renderAnimalModels() {
            const container = document.getElementById('animal-models-container');
            container.innerHTML = ''; 
            const sortedModelIds = Object.keys(animalModels).sort(); 

            if (sortedModelIds.length === 0) {
                 container.innerHTML = '<p class="text-gray-500">No hay modelos a√±adidos todav√≠a.</p>';
                 return;
            }

            sortedModelIds.forEach(modelId => {
                const model = animalModels[modelId];
                const modelDiv = document.createElement('div');
                modelDiv.className = 'p-4 border rounded-lg bg-white shadow';
                modelDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-lg text-blue-700">${model.id}</h3>
                        <div>
                            <button onclick="openModelDataModal('${modelId}')" class="text-sm bg-green-500 text-white py-1 px-3 rounded-md hover:bg-green-600">+ A√±adir Registro</button>
                            <button onclick="deleteAnimalModel('${modelId}')" class="text-sm bg-red-500 text-white py-1 px-3 rounded-md hover:bg-red-600 ml-2">Eliminar Modelo</button>
                        </div>
                    </div>
                    <div class="max-h-60 overflow-y-auto">
                        <table id="model-data-table-${modelId}" class="min-w-full text-sm">
                            <thead>
                                <tr><th>Fecha</th><th>Peso (g)</th><th>Talla (cm)</th><th>Glucosa (mg/dL)</th><th>Fuerza (gf)</th><th>Notas</th></tr>
                            </thead>
                            <tbody>
                                ${model.data.sort((a,b) => new Date(b.date) - new Date(a.date)).map(entry => `
                                    <tr>
                                        <td>${new Date(entry.date).toLocaleDateString()}</td>
                                        <td>${entry.weight ?? ''}</td>
                                        <td>${entry.size ?? ''}</td>
                                        <td>${entry.glucose ?? ''}</td>
                                        <td>${entry.grip ?? ''}</td>
                                        <td>${entry.notes ?? ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                container.appendChild(modelDiv);
            });
        }
         function deleteAnimalModel(modelId) {
             if (confirm(`¬øEst√°s seguro de eliminar el modelo ${modelId} y todos sus registros?`)) {
                 if (animalModels[modelId]) {
                     delete animalModels[modelId];
                     renderAnimalModels();
                     showToast(`Modelo "${modelId}" eliminado.`);
                 }
             }
        }


        function openModelDataModal(modelId) {
            currentEditingModelId = modelId; 
            document.getElementById('modal-model-id').textContent = modelId; 
            document.getElementById('modal-model-weight').value = '';
            document.getElementById('modal-model-size').value = '';
            document.getElementById('modal-model-glucose').value = '';
            document.getElementById('modal-model-grip').value = '';
            document.getElementById('modal-model-notes').value = '';
            document.getElementById('model-data-modal').style.display = 'flex';
        }

        function closeModelDataModal() {
            document.getElementById('model-data-modal').style.display = 'none';
            currentEditingModelId = null; 
        }

        function saveModelDataEntry() {
            if (!currentEditingModelId || !animalModels[currentEditingModelId]) return;

            const entry = {
                date: new Date().toISOString(), 
                weight: parseFloat(document.getElementById('modal-model-weight').value) || null,
                size: parseFloat(document.getElementById('modal-model-size').value) || null,
                glucose: parseFloat(document.getElementById('modal-model-glucose').value) || null,
                grip: parseFloat(document.getElementById('modal-model-grip').value) || null,
                notes: document.getElementById('modal-model-notes').value.trim() || null,
            };

            animalModels[currentEditingModelId].data.push(entry);
            renderAnimalModels(); 
            closeModelDataModal(); 
            showToast(`Registro a√±adido para ${currentEditingModelId}.`);
        }

        function saveModelData() {
             if (Object.keys(animalModels).length === 0) {
                 showToast("No hay datos de modelos para guardar.", "warning");
                 return;
             }
             const dataString = JSON.stringify(animalModels, null, 2);
             const blob = new Blob([dataString], { type: 'application/json' });
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url;
             a.download = `datos_modelos_${new Date().toISOString().split('T')[0]}.json`;
             document.body.appendChild(a);
             a.click();
             document.body.removeChild(a);
             URL.revokeObjectURL(url);
             showToast('Datos de modelos guardados.');
        }

        function loadModelData(event) {
            const file = event.target.files[0]; 
            if (!file) return; 
            const reader = new FileReader(); 
            reader.onload = (e) => {
                try {
                    const loadedData = JSON.parse(e.target.result);
                     if (typeof loadedData === 'object' && loadedData !== null) {
                         animalModels = loadedData; 
                         renderAnimalModels(); 
                         showToast('Datos de modelos cargados.');
                     } else {
                         throw new Error("El archivo no tiene el formato esperado.");
                     }
                } catch (error) {
                    showToast(`Error al cargar datos de modelos: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; 
        }

        function calculateModelDose() {
             const doseAmount = parseFloat(document.getElementById('dose-amount').value);
             const doseAmountUnit = document.getElementById('dose-amount-unit').value;
             const doseWeightUnitVal = parseFloat(document.getElementById('dose-weight-unit-val').value) || 1; 
             const doseWeightUnit = document.getElementById('dose-weight-unit').value; 
             const modelWeight = parseFloat(document.getElementById('model-weight').value);
             const modelWeightUnit = document.getElementById('model-weight-unit').value;
             const stockConcAmount = parseFloat(document.getElementById('stock-conc-dose').value);
             const stockConcUnit = document.getElementById('stock-conc-dose-unit').value; 
             const outputUnit = document.getElementById('dose-output-unit').value; 
             const resultDiv = document.getElementById('dose-calculation-result');

             if (isNaN(doseAmount) || isNaN(modelWeight) || isNaN(stockConcAmount) || stockConcAmount === 0 || isNaN(doseWeightUnitVal) || doseWeightUnitVal === 0) {
                 resultDiv.innerHTML = `<span class="text-red-500">Por favor, completa todos los campos num√©ricos requeridos.</span>`;
                 return;
             }

             try {
                 const modelWeightConverted = _pureConvertUnits(modelWeight, modelWeightUnit, doseWeightUnit);
                  if (isNaN(modelWeightConverted)) throw new Error(`No se puede convertir el peso del modelo (${modelWeightUnit}) a la unidad de peso de la dosis (${doseWeightUnit}).`);
                
                  const totalAmountNeeded = (modelWeightConverted / doseWeightUnitVal) * doseAmount;
                 
                  const stockMassUnit = stockConcUnit.split('/')[0];
                  const stockVolUnit = stockConcUnit.split('/')[1];
                  if (!stockMassUnit || !stockVolUnit) throw new Error(`Unidad de concentraci√≥n de stock inv√°lida: ${stockConcUnit}`);

                  const totalAmountConverted = _pureConvertUnits(totalAmountNeeded, doseAmountUnit, stockMassUnit);
                   if (isNaN(totalAmountConverted)) throw new Error(`No se puede convertir la unidad de cantidad de dosis (${doseAmountUnit}) a la unidad de masa del stock (${stockMassUnit}).`);

                  const volumeInStockVolUnit = totalAmountConverted / stockConcAmount;

                  const finalVolume = _pureConvertUnits(volumeInStockVolUnit, stockVolUnit, outputUnit);
                   if (isNaN(finalVolume)) throw new Error(`No se puede convertir el volumen calculado (${stockVolUnit}) a la unidad de salida (${outputUnit}).`);

                  resultDiv.textContent = `Administrar: ${finalVolume.toPrecision(4)} ${outputUnit}`;

             } catch (error) {
                 resultDiv.innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
             }
        }


        // --- UTILITIES ---
        function toggleSubCalc(targetId) {
            const el = document.getElementById(targetId);
            if(el) {
                el.style.display = el.style.display === 'block' ? 'none' : 'block';
            }
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message; 
            toast.className = 'toast show fixed bottom-5 right-5 text-white py-4 px-8 rounded-xl shadow-2xl z-50'; 
            toast.classList.add(type === 'error' ? 'bg-red-600' : 'bg-green-600');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        function populateUnitDropdowns(context = document) {
            const massUnits = Object.keys(CONVERSION_FACTORS.mass);
            const volUnits = Object.keys(CONVERSION_FACTORS.volume);
            const concUnits = Object.keys(CONVERSION_FACTORS.concentration); 
            const combinedUnits = [];
            massUnits.forEach(m => volUnits.forEach(v => combinedUnits.push(`${m}/${v}`)));
            const allConcUnits = [...concUnits, ...combinedUnits];
            const allUnits = [...massUnits, ...volUnits, ...allConcUnits]; 

            const ucFrom = context.querySelector('#uc-from'); 
            if (ucFrom && context === document) { 
                
                ucFrom.innerHTML = allUnits.map(u => `<option value="${u}">${u}</option>`).join('');
                document.getElementById('uc-to').innerHTML = allUnits.map(u => `<option value="${u}">${u}</option>`).join('');
                
                document.getElementById('c1-unit').innerHTML = allConcUnits.map(u => `<option value="${u}" ${u==='mM' ? 'selected':''}>${u}</option>`).join('');
                document.getElementById('c2-unit').innerHTML = allConcUnits.map(u => `<option value="${u}" ${u==='¬µM' ? 'selected':''}>${u}</option>`).join('');
                document.getElementById('v1-unit').innerHTML = volUnits.map(u => `<option value="${u}" ${u==='mL' ? 'selected':''}>${u}</option>`).join('');
                document.getElementById('v2-unit').innerHTML = volUnits.map(u => `<option value="${u}" ${u==='¬µL' ? 'selected':''}>${u}</option>`).join('');

                 document.getElementById('dose-amount-unit').innerHTML = massUnits.map(u => `<option value="${u}" ${u==='mg' ? 'selected':''}>${u}</option>`).join('');
                 document.getElementById('stock-conc-dose-unit').innerHTML = allConcUnits.map(u => `<option value="${u}" ${u==='mg/mL' ? 'selected':''}>${u}</option>`).join('');
            }
            
            const finalConcUnitSelects = context.querySelectorAll('.variable-final-conc-unit');
            const stockConcUnitSelects = context.querySelectorAll('.variable-stock-conc-unit');
            
            finalConcUnitSelects.forEach(select => {
                select.innerHTML = allConcUnits.map(u => `<option value="${u}" ${u === '¬µM' ? 'selected' : ''}>${u}</option>`).join('');
            });
            stockConcUnitSelects.forEach(select => {
                select.innerHTML = allConcUnits.map(u => `<option value="${u}" ${u === 'mM' ? 'selected' : ''}>${u}</option>`).join('');
            });
        }
        
        // --- SAVE / LOAD ---
        function saveExperiment() {
            const experimentState = {
                experimentName: document.getElementById('exp-name').value,
                plateType: document.getElementById('plate-type').value,
                wellData: wellData, 
            };

            const jsonString = JSON.stringify(experimentState, null, 2); 
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url; 
            const fileName = (experimentState.experimentName || 'experimento').replace(/\s+/g, '_');
            a.download = `${fileName}.json`; 
            document.body.appendChild(a); 
            a.click(); 
            document.body.removeChild(a); 
            URL.revokeObjectURL(url); 
            showToast('Experimento guardado exitosamente.'); 
        }

        function loadExperiment(event) {
            const file = event.target.files[0]; 
            if (!file) return; 

            const reader = new FileReader(); 
            reader.onload = function(e) { 
                try {
                    const loadedState = JSON.parse(e.target.result);
                    
                    document.getElementById('exp-name').value = loadedState.experimentName || ''; 
                    wellData = loadedState.wellData || {}; 
                    generatePlate(loadedState); 
                    showToast('Experimento cargado exitosamente.'); 
                } catch (error) {
                    showToast('Error al cargar el archivo. Aseg√∫rate de que es un archivo de experimento v√°lido.', 'error'); 
                }
            };
            reader.readAsText(file);
            event.target.value = ''; 
        }

        // --- REPORTING ---
        function generateReport() {
            const output = document.getElementById('report-output');
            const expName = document.getElementById('exp-name').value || 'Sin nombre';
            const plateType = document.getElementById('plate-type').value;

            if (Object.keys(wellData).length === 0) {
                output.innerHTML = '<p class="text-red-500">No hay datos de experimento para reportar. Por favor, configura al menos un pozo.</p>';
                document.getElementById('export-csv-btn').style.display = 'none'; 
                return;
            }

            let html = `<h3>Informaci√≥n General</h3>
                        <ul>
                            <li><strong>Nombre del Experimento:</strong> ${expName}</li>
                            <li><strong>Tipo de Placa:</strong> ${plateType} pozos</li>
                        </ul>`;

            const groupedWells = {};
            for (const wellId in wellData) {
                const configKey = JSON.stringify(wellData[wellId]); 
                if (!groupedWells[configKey]) {
                    groupedWells[configKey] = {
                        config: wellData[wellId],
                        wells: [] 
                    };
                }
                groupedWells[configKey].wells.push(wellId);
            }

            html += `<h3>Configuraci√≥n de Pozos</h3>`;
            Object.values(groupedWells).forEach((group, index) => {
                const config = group.config; 
                html += `<div class="p-4 mb-4 border rounded-lg">
                            <h4><strong>Grupo ${index + 1}:</strong> Pozos ${group.wells.join(', ')}</h4>
                            <ul>
                                <li><strong>Tipo:</strong> ${config.wellType}</li>
                                <li><strong>Volumen Total:</strong> ${config.totalVolume ?? 'N/A'} ¬µL</li>
                                <li><strong>C√©lulas:</strong> ${config.cells?.count ?? 'N/A'}</li>
                            </ul>`;
                if (config.variables?.length > 0) {
                    html += `<h5>Variables:</h5>
                             <table class="min-w-full text-sm">
                                 <thead class="bg-gray-100"><tr><th>Nombre</th><th>Conc. Final</th></tr></thead>
                                 <tbody>`;
                    config.variables.forEach(v => {
                        html += `<tr><td>${v.name}</td><td>${v.finalConc} ${v.finalConcUnit}</td></tr>`;
                    });
                    html += `</tbody></table>`;
                }
                 if (config.protocol?.steps?.length > 0) {
                    html += `<h5>Protocolo:</h5><ul>`;
                    config.protocol.steps.forEach((step, i) => {
                         const unitText = {3600000:'horas', 60000:'minutos', 86400000:'d√≠as'}[step.unit] || 'ms';
                        html += `<li><strong>Paso ${i+1}:</strong> ${step.name} (${step.duration} ${unitText})</li>`;
                    });
                    html += `</ul>`;
                }
                html += `</div>`;
            });
            
            output.innerHTML = html;
            document.getElementById('export-csv-btn').style.display = 'inline-block';
        }

        function exportReportCSV() {
            const expName = document.getElementById('exp-name').value || 'Sin nombre';
            const plateType = document.getElementById('plate-type').value;
            let csvContent = "\uFEFF"; 
            
            const escapeCSV = (str) => {
                 const value = (str === undefined || str === null) ? '' : String(str);
                if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                    return `"${value.replace(/"/g, '""')}"`; 
                }
                return value; 
            };

            csvContent += "Secci√≥n,Par√°metro,Valor\n";
            csvContent += `Informaci√≥n General,Nombre del Experimento,${escapeCSV(expName)}\n`;
            csvContent += `Informaci√≥n General,Tipo de Placa,${escapeCSV(plateType + ' pozos')}\n\n`;

            const headers = ['Pozo', 'Tipo de Pozo', 'Volumen Total (uL)', 'Cantidad de C√©lulas'];
            const allVars = new Set();
            let maxSteps = 0;
            Object.values(wellData).forEach(d => {
                d.variables?.forEach(v => allVars.add(v.name)); 
                if(d.protocol?.steps?.length > maxSteps) maxSteps = d.protocol.steps.length; 
            });
            const varColumns = Array.from(allVars); 
            varColumns.forEach(v => headers.push(`Variable: ${v} (Conc. Final)`));
             for(let i=1; i<= maxSteps; i++) {
                 headers.push(`Paso ${i}: Nombre`);
                 headers.push(`Paso ${i}: Duraci√≥n`);
             }
            csvContent += headers.map(escapeCSV).join(',') + '\n';
            
            const sortedWellIds = Object.keys(wellData).sort((a, b) => {
                const rowA = a.match(/[A-Z]+/)[0];
                const colA = parseInt(a.match(/\d+/)[0]);
                const rowB = b.match(/[A-Z]+/)[0];
                const colB = parseInt(b.match(/\d+/)[0]);
                if (rowA !== rowB) return rowA.localeCompare(rowB);
                return colA - colB;
            });

            for (const wellId of sortedWellIds) {
                const d = wellData[wellId]; 
                 const row = [
                    wellId,
                    d.wellType,
                    d.totalVolume ?? '', 
                    d.cells?.count ?? '' 
                ];
                varColumns.forEach(varName => {
                    const variable = d.variables?.find(v => v.name === varName); 
                    row.push(variable ? `${variable.finalConc ?? ''} ${variable.finalConcUnit ?? ''}`.trim() : ''); 
                });

                for(let i=0; i< maxSteps; i++) {
                    const step = d.protocol?.steps?.[i]; 
                    if (step) {
                         const unitText = {3600000:'horas', 60000:'minutos', 86400000:'d√≠as'}[step.unit] || 'ms';
                        row.push(step.name);
                        row.push(`${step.duration} ${unitText}`);
                    } else {
                        row.push('');
                        row.push('');
                    }
                }
                csvContent += row.map(escapeCSV).join(',') + '\n';
            }
            csvContent += '\n'; 


            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            const fileName = (expName || 'reporte').replace(/\s+/g, '_'); 
            link.setAttribute("download", `${fileName}.csv`);
            document.body.appendChild(link); 
            link.click(); 
            document.body.removeChild(link); 
            URL.revokeObjectURL(url); 
        }


        // --- INITIALIZATION ---
        window.onload = () => {
            generatePlate(); 
            populateUnitDropdowns(); 
            initializeUploadSlots(); // Inicializar los slots de la c√°mara de Neubauer
            if (typeof Notification !== 'undefined' && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission();
            }
            changeTab('guide'); 
            document.getElementById('load-exp-input').addEventListener('change', loadExperiment);
            document.getElementById('load-model-input').addEventListener('change', loadModelData);

        };
    </script>
</body>
</html>
