<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LICAM Asistente de Laboratorio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Base Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 - Fondo mÃ¡s profesional */
        }
        
        /* Tab Navigation Styles (for a clean, indicator-only look) */
        .tab-button {
            transition: all 0.3s ease;
            font-weight: 600;
            border-bottom: 3px solid transparent;
        }
        .tab-button:hover {
            color: #1d4ed8; /* Blue 700 */
        }
        .tab-button.active {
            border-color: #1d4ed8; /* Blue 700 para el indicador activo */
            color: #1d4ed8; /* Blue 700 para el texto activo */
            background-color: #f0f4f8; /* Un fondo muy ligero para la pestaÃ±a activa */
        }

        /* Well/Plate Styles */
        .well {
            transition: all 0.2s ease;
            border: 3px solid #e2e8f0; /* Color de borde mÃ¡s sutil */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
            /* Soft default background */
            background-color: #f7fafc; 
        }
        .well.selected {
            /* Sombra interna para indicar el color del borde */
            box-shadow: inset 0 0 0 3px #2563eb, 0 6px 12px -3px rgba(0, 0, 0, 0.2); 
            border-color: transparent; /* El borde ya no es visible por el shadow */
            background-color: #eff6ff; /* Blue 50 */
            transform: scale(1.05); /* Efecto de "lift" sutil */
        }
        .well:not(.configured) .well-label {
            opacity: 0.6;
            font-style: italic;
        }
        /* Well Type Colors (Usando box-shadow: inset para el anillo) */
        .well.control { box-shadow: inset 0 0 0 3px #10b981; } /* Green 500 */
        .well.experimental { box-shadow: inset 0 0 0 3px #ef4444; } /* Red 500 */
        .well.blanco { box-shadow: inset 0 0 0 3px #6366f1; } /* Indigo 500 */
        .well.tratamiento-1 { box-shadow: inset 0 0 0 3px #f97316; } /* Orange 500 */
        .well.tratamiento-2 { box-shadow: inset 0 0 0 3px #8b5cf6; } /* Violet 500 */

        /* General Dynamic/Modal Styles */
        .modal {
            display: none;
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(4px); /* Efecto de desenfoque */
            z-index: 50; /* Ensure modals are on top */
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .toast {
             /* Use Tailwind for visibility/opacity control in JS */
             z-index: 60;
        }
        .sub-calc {
            display: none;
        }

        /* Styles for inner content tables/boxes */
        .calc-result-box {
            background-color: #f0f9ff; /* Blue 50 */
            border-left: 4px solid #3b82f6; /* Blue 500 */
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            color: #1e3a8a; /* Dark blue text for contrast */
        }
        /* Prose Styles Enhancement */
        .prose h3, .prose h4 { margin-top: 1.5em; margin-bottom: 0.5em; font-weight: 700; color: #1e3a8a; }
        #model-data-table th, #model-data-table td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            text-align: left;
        }
        #model-data-table th {
            background-color: #eef2ff; /* Indigo 50 */
            color: #4338ca; /* Indigo 700 */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <header class="bg-white shadow-xl sticky top-0 z-20 border-b border-blue-200">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="logo_licam.png" onerror="this.onerror=null;this.src='';" alt="Logo LICAM" class="h-14 w-auto object-contain">
                <h1 class="text-3xl font-extrabold text-blue-700 tracking-tight">LICAM <span class="text-gray-500 font-semibold text-xl">Asistente de Laboratorio</span></h1>
            </div>
            <div>
                 <img src="logo_ipn.png" onerror="this.onerror=null;this.src='';" alt="Logo IPN" class="h-12 w-auto object-contain">
            </div>
        </div>
    </header>
    <div class="bg-white shadow-md z-10 sticky top-14">
        <div class="container mx-auto px-4 border-b border-gray-200">
            <nav class="flex space-x-1 overflow-x-auto pb-0" aria-label="Tabs">
                <button onclick="changeTab('guide')" id="tab-guide" class="tab-button active text-md py-3 px-4 flex-shrink-0 flex items-center space-x-2">ğŸ’¡ GuÃ­a de Uso</button>
                <button onclick="changeTab('planner')" id="tab-planner" class="tab-button text-md py-3 px-4 flex-shrink-0 flex items-center space-x-2">ğŸ§ª Organizador de Cultivo</button>
                <button onclick="changeTab('models')" id="tab-models" class="tab-button text-md py-3 px-4 flex-shrink-0 flex items-center space-x-2">ğŸ­ Modelos Animales</button>
                <button onclick="changeTab('protocols')" id="tab-protocols" class="tab-button text-md py-3 px-4 flex-shrink-0 flex items-center space-x-2">ğŸ“š Protocolos y Recursos</button>
                <button onclick="changeTab('report')" id="tab-report" class="tab-button text-md py-3 px-4 flex-shrink-0 flex items-center space-x-2">ğŸ“„ Reporte del Experimento</button>
                <button onclick="changeTab('calculators')" id="tab-calculators" class="tab-button text-md py-3 px-4 flex-shrink-0 flex items-center space-x-2">ğŸ”¢ Calculadoras RÃ¡pidas</button>
                <button onclick="changeTab('about')" id="tab-about" class="tab-button text-md py-3 px-4 flex-shrink-0 flex items-center space-x-2">â„¹ï¸ Acerca del Proyecto</button>
            </nav>
        </div>
    </div>


    <main class="container mx-auto p-4 md:p-8">
        <div id="content-guide" class="space-y-6 bg-white p-8 rounded-3xl shadow-2xl border border-gray-200">
            <h2 class="text-3xl font-bold text-blue-700 border-b pb-4">ğŸ’¡ GuÃ­a de Uso RÃ¡pido</h2>
            <div class="prose max-w-none text-gray-700">
                 Â  Â  Â  Â  Â  Â  Â  Â  Â <p>Â¡Bienvenido/a al Asistente de Laboratorio LICAM! Esta guÃ­a te ayudarÃ¡ a usar las funciones principales.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â <h3>Organizador de Cultivo (ğŸ§ª)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p>Esta es la secciÃ³n principal para planificar tus experimentos en placas.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â <ul class="list-disc list-inside">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <li><strong>1. ConfiguraciÃ³n del Experimento:</strong> Dale un nombre a tu experimento y selecciona el tipo de placa (6, 12, 24, 48, 96 pozos). Haz clic en "Generar Placa".</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <li><strong>Guardar/Cargar Experimento:</strong> Usa los botones verdes y grises para guardar tu progreso en un archivo <code>.json</code> o cargar un experimento previamente guardado.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <li><strong>2. DiseÃ±o de la Placa:</strong> Haz clic en los pozos para seleccionarlos (se pondrÃ¡n azules). Puedes seleccionar varios. Usa "Seleccionar Todos" o "Limpiar SelecciÃ³n" para ayudarte.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <li><strong>Configurar Pozo(s):</strong> Con los pozos seleccionados, haz clic en "Configurar Pozo(s)". Se abrirÃ¡ una ventana:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>ParÃ¡metros Generales:</strong> Define el Tipo de Pozo, Volumen Total Final y Cantidad de CÃ©lulas por pozo. Usa el icono âš™ï¸ junto a CÃ©lulas para:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Calcular el volumen a tomar de tu stock celular (necesitas la concentraciÃ³n de tu stock).</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>O usar la calculadora de CÃ¡mara de Neubauer: introduce los conteos de 4 cuadrantes y haz clic en "Calcular ConcentraciÃ³n" para obtener la concentraciÃ³n de tu stock en cÃ©lulas/mL.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <li><strong>Variables/Reactivos:</strong> AÃ±ade los reactivos que usarÃ¡s. Define la ConcentraciÃ³n Final deseada. Usa el icono âš™ï¸ para calcular cuÃ¡nto volumen tomar de tu reactivo stock.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <li><strong>Pasos del Protocolo:</strong> Define los pasos secuenciales de tu experimento (Ej. Paso 1: IncubaciÃ³n PMA, DuraciÃ³n: 24 horas; Paso 2: Lavado + LPS, DuraciÃ³n: 12 horas). AÃ±ade tantos pasos como necesites.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <li><strong>3. Creador de Stock General:</strong> Selecciona los pozos que tendrÃ¡n la misma mezcla y haz clic en "Calcular Stock...". Indica un porcentaje extra si lo deseas. La tabla te mostrarÃ¡ cuÃ¡nto necesitas preparar en total.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <li><strong>4. Cronograma del Protocolo:</strong> AquÃ­ aparecerÃ¡n todos los Pasos del Protocolo. Cada paso tendrÃ¡ su propio temporizador. Haz clic en "Iniciar" para comenzar la cuenta regresiva.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â </ul>

Â  Â  Â  Â  Â  Â  Â  Â  Â <h3>Modelos Animales (ğŸ­)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p>SecciÃ³n para llevar un registro de datos de modelos animales y calcular dosis.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â <ul class="list-disc list-inside">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <li><strong>Seguimiento:</strong> AÃ±ade modelos con un ID Ãºnico. Luego, haz clic en "+ AÃ±adir Registro" para ingresar Peso (g), Talla (cm), Glucosa (mg/dL), Fuerza de Agarre (gf) y Notas.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <li><strong>Dosis:</strong> Utiliza la Calculadora de DosificaciÃ³n para saber cuÃ¡nto volumen administrar (ÂµL o mL) segÃºn la dosis requerida (mg/kg), el peso del modelo y la concentraciÃ³n de tu stock.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <li><strong>Guardar/Cargar:</strong> Guarda o carga los datos de tus modelos en archivos <code>.json</code>.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â </ul>

Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Protocolos y Recursos (ğŸ“š)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p>Contiene una secciÃ³n editable de notas para protocolos comunes (ej. ExtracciÃ³n de ARN) y enlaces directos a bases de datos Ãºtiles (PubMed, UniProt, etc.).</p>

Â  Â  Â  Â  Â  Â  Â  Â  Â <h3>Reporte y Calculadoras (ğŸ“„/ğŸ”¢)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p>El <strong>Reporte</strong> genera un archivo CSV listo para Excel con la configuraciÃ³n de tu placa. Las <strong>Calculadoras</strong> te permiten realizar cÃ¡lculos rÃ¡pidos de Masa Molar, ConversiÃ³n de Unidades y DiluciÃ³n (Câ‚Vâ‚=Câ‚‚Vâ‚‚) de forma independiente.</p>

Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Acerca del Proyecto (â„¹ï¸)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Muestra informaciÃ³n sobre el desarrollo, colaboradores, instituciÃ³n y datos de contacto de LICAM.</p>
Â  Â  Â  Â  Â  Â  Â </div>
        </div>

        <div id="content-planner" class="hidden space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 bg-white p-6 rounded-3xl shadow-xl border border-gray-200">
                    <h2 class="text-2xl font-bold mb-5 text-indigo-700 border-b pb-3">1. ConfiguraciÃ³n âœ¨</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="exp-name" class="block text-sm font-medium text-gray-700">Nombre del Experimento:</label>
                            <input type="text" id="exp-name" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2" placeholder="Ej: Curva de dosis PMA/LPS">
                        </div>
                        <div>
                            <label for="plate-type" class="block text-sm font-medium text-gray-700">Tipo de Placa:</label>
                            <select id="plate-type" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2">
                                <option value="6">6 Pozos</option>
                                <option value="12">12 Pozos</option>
                                <option value="24" selected>24 Pozos</option>
                                <option value="48">48 Pozos</option>
                                <option value="96">96 Pozos</option>
                            </select>
                        </div>
                        <button onclick="generatePlate()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">Generar Placa</button>
                    </div>
                    
                    <div class="mt-8 pt-4 border-t border-gray-200">
                        <h3 class="text-xl font-bold mb-3 text-gray-700">Guardar / Cargar Experimento</h3>
                        <div class="flex space-x-2">
                            <button onclick="saveExperiment()" class="flex-1 bg-green-600 text-white font-bold py-2 px-3 text-sm rounded-xl hover:bg-green-700 transition shadow-md">ğŸ’¾ Guardar</button>
                            <label for="load-exp-input" class="flex-1 bg-gray-600 text-white font-bold py-2 px-3 text-sm rounded-xl hover:bg-gray-700 cursor-pointer text-center transition shadow-md">ğŸ“‚ Cargar</label>
                            <input type="file" id="load-exp-input" class="hidden" accept=".json">
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h3 class="text-xl font-bold mb-3 text-gray-700">Controles de SelecciÃ³n</h3>
                        <div class="flex space-x-2 mb-4">
                            <button onclick="selectAllWells()" class="flex-1 bg-gray-200 text-gray-800 py-2 px-3 text-sm rounded-xl hover:bg-gray-300 transition shadow-sm">Seleccionar Todos</button>
                            <button onclick="clearSelection()" class="flex-1 bg-gray-200 text-gray-800 py-2 px-3 text-sm rounded-xl hover:bg-gray-300 transition shadow-sm">Limpiar SelecciÃ³n</button>
                        </div>
                       <button onclick="openWellConfigModal()" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-indigo-700 transition duration-300 shadow-lg">âš™ï¸ Configurar Pozo(s)</button>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-white p-6 rounded-3xl shadow-xl border border-gray-200 flex flex-col">
                    <div class="flex justify-between items-center mb-5 border-b pb-3 border-gray-200">
                        <h2 class="text-2xl font-bold text-indigo-700">2. DiseÃ±o de la Placa</h2>
                        <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs items-center justify-end">
                            <span class="flex items-center p-1 rounded-md border border-green-500"><span class="w-3 h-3 rounded-full bg-white border-2 border-green-500 mr-1"></span>Control</span>
                            <span class="flex items-center p-1 rounded-md border border-red-500"><span class="w-3 h-3 rounded-full bg-white border-2 border-red-500 mr-1"></span>Experimental</span>
                            <span class="flex items-center p-1 rounded-md border border-indigo-500"><span class="w-3 h-3 rounded-full bg-white border-2 border-indigo-500 mr-1"></span>Blanco</span>
                            <span class="flex items-center p-1 rounded-md border border-orange-500"><span class="w-3 h-3 rounded-full bg-white border-2 border-orange-500 mr-1"></span>Trat. 1</span>
                            <span class="flex items-center p-1 rounded-md border border-violet-500"><span class="w-3 h-3 rounded-full bg-white border-2 border-violet-500 mr-1"></span>Trat. 2</span>
                        </div>
                    </div>
                    <div id="plate-layout-container" class="p-6 bg-gray-100 rounded-xl overflow-x-auto flex-grow flex items-center justify-center">
                        <div id="plate-layout" class="grid gap-3 p-2 bg-white rounded-lg shadow-inner" style="grid-template-columns: repeat(6, 1fr); display:none;">
                            </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-5 text-indigo-700 border-b pb-3">3. Creador de Stock General ğŸ’§</h2>
                <div class="flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-6 mb-4 p-4 bg-purple-50 rounded-xl border border-purple-200">
                    <button onclick="calculateMasterMix()" class="bg-purple-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-purple-700 transition duration-300 shadow-md flex-shrink-0">Calcular Stock para Pozos Seleccionados</button>
                    <div class="flex items-center space-x-2">
                        <label for="extra-volume" class="mr-2 text-sm font-medium text-gray-700 whitespace-nowrap">Volumen extra (% de seguridad):</label>
                        <input type="number" id="extra-volume" value="10" class="w-20 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-center p-2">
                    </div>
                </div>
                <div id="master-mix-results" class="calc-result-box">
                    <p class="text-gray-600 font-normal">Los resultados del cÃ¡lculo para el stock general aparecerÃ¡n aquÃ­.</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-5 text-indigo-700 border-b pb-3">4. Cronograma del Protocolo â°</h2>
                <div class="text-sm text-gray-700 mb-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 rounded-lg">
                    <b class="font-extrabold">ğŸš¨ Alerta de Tiempo:</b> Las alarmas y notificaciones solo funcionarÃ¡n si esta pestaÃ±a del navegador permanece abierta.
                </div>
                <div id="protocol-schedule-container" class="space-y-4">
                    <p class="text-gray-500">Los eventos del protocolo para los pozos configurados aparecerÃ¡n aquÃ­.</p>
                </div>
            </div>
        </div>
        
        <div id="content-models" class="hidden space-y-8">
            <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-5 text-indigo-700 border-b pb-3">ğŸ­ Seguimiento de Modelos Animales</h2>
                <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4 mb-6">
                    <button onclick="saveModelData()" class="bg-green-600 text-white font-bold py-2 px-4 text-sm rounded-xl hover:bg-green-700 transition shadow-md">ğŸ’¾ Guardar Datos Modelos</button>
                    <label for="load-model-input" class="bg-gray-600 text-white font-bold py-2 px-4 text-sm rounded-xl hover:bg-gray-700 cursor-pointer text-center transition shadow-md">ğŸ“‚ Cargar Datos Modelos</label>
                    <input type="file" id="load-model-input" class="hidden" accept=".json">
                    <div class="flex space-x-2 w-full md:w-auto">
                        <input type="text" id="new-model-id" placeholder="ID Nuevo Modelo (Ej: RatÃ³n-01)" class="border-gray-300 rounded-lg shadow-sm p-2 w-full">
                        <button onclick="addAnimalModel()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-xl hover:bg-blue-700 transition shadow-md flex-shrink-0">AÃ±adir</button>
                    </div>
                </div>
                <div id="animal-models-container" class="space-y-6">
                    </div>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-5 text-indigo-700 border-b pb-3">ğŸ’‰ Calculadora de DosificaciÃ³n por Peso</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                    <div>
                        <label class="block text-sm font-bold text-gray-700">Dosis Deseada (mg/kg):</label>
                        <div class="flex space-x-1 mt-1">
                            <input type="number" id="dose-amount" placeholder="Cantidad" class="w-1/2 border-gray-300 rounded-lg shadow-sm p-2">
                            <select id="dose-amount-unit" class="w-1/2 border-gray-300 rounded-lg shadow-sm p-2"></select>
                         </div>
                         <div class="flex space-x-1 mt-2 items-center text-sm">
                            <span class="whitespace-nowrap">por cada</span>
                            <input type="number" id="dose-weight-unit-val" value="1" class="w-1/4 border-gray-300 rounded-lg shadow-sm p-2 text-center">
                            <select id="dose-weight-unit" class="w-1/2 border-gray-300 rounded-lg shadow-sm p-2">
                                <option value="g">g</option>
                                <option value="kg" selected>kg</option>
                            </select>
                         </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700">Peso del Modelo:</label>
                        <div class="flex space-x-1 mt-1">
                            <input type="number" id="model-weight" placeholder="Peso" class="w-1/2 border-gray-300 rounded-lg shadow-sm p-2">
                            <select id="model-weight-unit" class="w-1/2 border-gray-300 rounded-lg shadow-sm p-2">
                                <option value="g" selected>g</option>
                                <option value="kg">kg</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700">ConcentraciÃ³n del Stock (Ej: mg/mL):</label>
                        <div class="flex space-x-1 mt-1">
                            <input type="number" id="stock-conc-dose" placeholder="Conc." class="w-1/2 border-gray-300 rounded-lg shadow-sm p-2">
                            <select id="stock-conc-dose-unit" class="w-1/2 border-gray-300 rounded-lg shadow-sm p-2"></select>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-between items-center border-t pt-4">
                    <button onclick="calculateModelDose()" class="bg-teal-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-teal-700 transition shadow-md">Calcular Volumen a Administrar</button>
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium">Resultado en:</label>
                        <select id="dose-output-unit" class="border-gray-300 rounded-lg shadow-sm p-2">
                            <option value="ÂµL" selected>ÂµL</option>
                            <option value="mL">mL</option>
                        </select>
                    </div>
                </div>
                <div id="dose-calculation-result" class="mt-4 calc-result-box"></div>
            </div>
        </div>

        <div id="content-protocols" class="hidden space-y-6 bg-white p-8 rounded-3xl shadow-xl border border-gray-200">
            <h2 class="text-3xl font-bold text-blue-700 border-b pb-4">ğŸ“š Protocolos Comunes y Recursos Externos</h2>
            <div class="prose max-w-none grid grid-cols-1 md:grid-cols-2 gap-8 text-gray-700">
                <div>
                    <h3>Protocolos Comunes (Notas RÃ¡pidas)</h3>
                    <div class="p-4 border border-gray-300 rounded-xl bg-gray-50 shadow-inner">
                        <h4>ExtracciÃ³n de ARN (Esquema BÃ¡sico)</h4>
                        <p>Este es un lugar para tus notas o un checklist simple:</p>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <li>Lisis celular (ej. Trizol)</li>
                            <li>SeparaciÃ³n de fases (Cloroformo)</li>
                            <li>PrecipitaciÃ³n de ARN (Isopropanol)</li>
                            <li>Lavados (Etanol 70-75%)</li>
                            <li>ResuspensiÃ³n (Agua libre de nucleasas)</li>
                            <li>CuantificaciÃ³n (Nanodrop/Qubit)</li>
                            <li>Control de Calidad (Gel/Bioanalyzer)</li>
                        </ul>
                        <p class="text-xs text-gray-500 mt-3">Puedes editar este archivo HTML para aÃ±adir detalles especÃ­ficos de tus kits o protocolos.</p>
                    </div>
                </div>
                <div>
                    <h3>Bases de Datos Externas</h3>
                    <p>Enlaces rÃ¡pidos a recursos Ãºtiles de ciencia:</p>
                    <ul class="list-disc list-inside space-y-2">
                        <li><a href="https://pubmed.ncbi.nlm.nih.gov/" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline font-semibold">PubMed (NCBI):</a> BÃºsqueda de literatura biomÃ©dica.</li>
                        <li><a href="https://www.ncbi.nlm.nih.gov/gene/" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline font-semibold">NCBI Gene:</a> InformaciÃ³n sobre genes especÃ­ficos.</li>
                        <li><a href="https://blast.ncbi.nlm.nih.gov/Blast.cgi" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline font-semibold">NCBI BLAST:</a> BÃºsqueda de secuencias.</li>
                        <li><a href="https://www.uniprot.org/" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline font-semibold">UniProt:</a> InformaciÃ³n sobre proteÃ­nas.</li>
                        <li><a href="https://www.rcsb.org/" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline font-semibold">Protein Data Bank (PDB):</a> Estructuras 3D.</li>
                    </ul>
                </div>
            </div>
        </div>


        <div id="content-report" class="hidden space-y-6 bg-white p-8 rounded-3xl shadow-xl border border-gray-200">
            <h2 class="text-3xl font-bold text-blue-700 border-b pb-4">ğŸ“„ Reporte del Experimento</h2>
            <div class="flex space-x-4">
                <button onclick="generateReport()" class="bg-teal-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-teal-700 transition shadow-md">Generar Reporte Completo</button>
                <button onclick="exportReportCSV()" id="export-csv-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 hidden transition shadow-md">â¬‡ï¸ Descargar Reporte (CSV)</button>
            </div>
            <div id="report-output" class="prose max-w-none mt-4 border-t pt-4 text-gray-700">
                <p class="text-gray-500">Haz clic en el botÃ³n para generar un resumen de tu experimento.</p>
            </div>
        </div>

        <div id="content-calculators" class="hidden space-y-8">
            <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-5 text-indigo-700">ğŸ”¢ Calculadora de Masa Molar</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div class="md:col-span-2">
                        <label for="chem-formula" class="block text-sm font-medium text-gray-700">FÃ³rmula QuÃ­mica (Ej: C6H12O6):</label>
                        <input type="text" id="chem-formula" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Ej: C6H12O6, NaCl">
                    </div>
                    <div>
                        <button onclick="calculateMolarMass()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition shadow-md">Calcular Masa Molar</button>
                    </div>
                </div>
                <div id="molar-mass-result" class="mt-4 calc-result-box"></div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-5 text-indigo-700">ğŸ”„ Conversor de Unidades</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 items-end">
                    <div>
                        <label for="uc-value" class="block text-sm font-medium text-gray-700">Valor:</label>
                        <input type="number" id="uc-value" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2">
                    </div>
                    <div>
                        <label for="uc-from" class="block text-sm font-medium text-gray-700">Desde:</label>
                        <select id="uc-from" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
                    </div>
                    <div class="hidden md:block text-center text-xl font-bold text-gray-500">=</div>
                    <div>
                        <label for="uc-to" class="block text-sm font-medium text-gray-700">Hasta:</label>
                        <select id="uc-to" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
                    </div>
                    <button onclick="convertUnits()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition shadow-md">Convertir</button>
                </div>
                <div id="uc-result" class="mt-4 calc-result-box"></div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-5 text-indigo-700">ğŸ’§ Calculadora de DiluciÃ³n (Câ‚Vâ‚ = Câ‚‚Vâ‚‚)</h2>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label for="c1" class="block text-sm font-medium text-gray-700">C1 (Stock):</label>
                            <input type="number" id="c1" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Conc. inicial">
                        </div>
                        <div>
                            <label for="c1-unit" class="block text-sm font-medium text-gray-700">Unidad C1:</label>
                            <select id="c1-unit" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
                        </div>
                        <div>
                            <label for="v1" class="block text-sm font-medium text-gray-700">V1 (Stock):</label>
                            <input type="number" id="v1" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Vol. inicial">
                        </div>
                        <div>
                            <label for="v1-unit" class="block text-sm font-medium text-gray-700">Unidad V1:</label>
                            <select id="v1-unit" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
                        </div>
                        <div>
                            <label for="c2" class="block text-sm font-medium text-gray-700">C2 (Final):</label>
                            <input type="number" id="c2" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Conc. final">
                        </div>
                        <div>
                            <label for="c2-unit" class="block text-sm font-medium text-gray-700">Unidad C2:</label>
                            <select id="c2-unit" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
                        </div>
                        <div>
                            <label for="v2" class="block text-sm font-medium text-gray-700">V2 (Final):</label>
                            <input type="number" id="v2" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Vol. final">
                        </div>
                        <div>
                            <label for="v2-unit" class="block text-sm font-medium text-gray-700">Unidad V2:</label>
                            <select id="v2-unit" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
                        </div>
                    </div>
                </div>
                <div class="mt-6">
                    <button onclick="calculateDilution()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition shadow-md">Calcular Valor Faltante</button>
                </div>
                <div id="dilution-result" class="mt-4 calc-result-box"></div>
            </div>
        </div>

        <div id="content-about" class="hidden space-y-8 bg-white p-8 rounded-3xl shadow-xl border border-gray-200">
            <h2 class="text-3xl font-bold text-blue-700 border-b pb-4">â„¹ï¸ InformaciÃ³n del Proyecto y Colaboradores</h2>
            <div class="prose max-w-none text-gray-700">
                <p class="text-lg">Esta aplicaciÃ³n es una herramienta de apoyo desarrollada como parte de un proyecto de tesis para optimizar el trabajo en el laboratorio, especialmente en la planificaciÃ³n y seguimiento de cultivos celulares.</p>
                
                <h3 class="font-bold text-2xl text-indigo-600 mt-8 mb-4 border-b border-indigo-100 pb-2">Equipo de Desarrollo y AsesorÃ­a</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="p-4 bg-gray-50 border border-gray-200 rounded-xl shadow-md transition hover:shadow-lg">
                        <p class="text-xl font-extrabold text-indigo-700">Tesista</p>
                        <p class="mt-1 font-semibold">Edsel Yahvi MÃ©ndez HernÃ¡ndez</p>
                    </div>
                    <div class="p-4 bg-gray-50 border border-gray-200 rounded-xl shadow-md transition hover:shadow-lg">
                        <p class="text-xl font-extrabold text-indigo-700">Asesora Externa</p>
                        <p class="mt-1 font-semibold">Dra. Nayelli NÃ¡jera GarcÃ­a</p>
                    </div>
                    <div class="p-4 bg-gray-50 border border-gray-200 rounded-xl shadow-md transition hover:shadow-lg">
                        <p class="text-xl font-extrabold text-indigo-700">Asesor Docente</p>
                        <p class="mt-1 font-semibold">Dr. Bustos GarcÃ­a Juan Roberto Israel</p>
                    </div>
                </div>

                <h3 class="font-bold text-2xl text-indigo-600 mt-10 mb-4 border-b border-indigo-100 pb-2">InstituciÃ³n y Laboratorio</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl shadow-md transition hover:shadow-lg">
                        <p class="text-xl font-extrabold text-blue-700">InstituciÃ³n</p>
                        <p class="mt-1 font-semibold">Escuela Superior de Medicina (ESM) - IPN</p>
                    </div>
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl shadow-md transition hover:shadow-lg">
                        <p class="text-xl font-extrabold text-blue-700">Laboratorio Colaborador (LICAM)</p>
                        <p class="mt-1 font-semibold">InvestigaciÃ³n Integral CardiometabÃ³lica (IPN)</p>
                    </div>
                </div>
                
                <div class="mt-10 pt-6 border-t border-gray-200">
                    <h3 class="font-bold text-2xl text-indigo-600">Contacto y Redes</h3>
                    <p class="mt-4">
                        <span class="font-bold">DirecciÃ³n:</span> Plan de San Luis y DÃ­az MirÃ³n s/n Col. Casco de Santo TomÃ¡s, Miguel Hidalgo, 11340, Ciudad de MÃ©xico, CDMX.
                    </p>
                    <p>
                        <span class="font-bold">Correo:</span> nnajerag@ipn.mx
                    </p>
                    <p>
                        <span class="font-bold">TelÃ©fono:</span> 55 5729 6300 ext 62820
                    </p>
                    <div class="mt-4 flex space-x-4 text-lg">
                        <a href="https://cemiztli.wixsite.com/cardiometabolismo" target="_blank" class="text-blue-600 hover:text-blue-800 font-semibold transition flex items-center">
                            ğŸŒ Website
                        </a>
                        <a href="#" class="text-blue-600 hover:text-blue-800 font-semibold transition flex items-center">
                            ğŸ“˜ Facebook
                        </a>
                        <a href="#" class="text-blue-600 hover:text-blue-800 font-semibold transition flex items-center">
                            ğŸ“¸ Instagram
                        </a>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <div id="well-config-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-4xl max-h-[95vh] overflow-y-auto p-8 border-4 border-indigo-500/50">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Configurar Pozo(s): <span id="well-ids-display" class="text-indigo-600 font-extrabold"></span></h2>
                <button onclick="closeWellConfigModal()" class="text-3xl text-gray-500 hover:text-gray-800 transition leading-none">&times;</button>
            </div>
            
            <div class="space-y-6">
                <div>
                    <h3 class="font-bold text-xl mb-3 text-indigo-700 border-b border-indigo-100 pb-2">ParÃ¡metros Generales</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border rounded-xl bg-indigo-50">
                        <div>
                            <label for="well-type" class="block text-sm font-medium text-gray-700">Tipo de Pozo:</label>
                             <select id="well-type" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm p-2">
                                 <option value="default">No Asignado</option>
                                 <option value="control">Control</option>
                                 <option value="experimental">Experimental</option>
                                 <option value="blanco">Blanco</option>
                                 <option value="tratamiento-1">Tratamiento 1</option>
                                 <option value="tratamiento-2">Tratamiento 2</option>
                             </select>
                        </div>
                        <div>
                            <label for="well-total-volume" class="block text-sm font-medium text-gray-700">Volumen Total Final (ÂµL):</label>
                            <input type="number" id="well-total-volume" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Ej: 2000">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">CÃ©lulas por Pozo:</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="well-cell-count" class="w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Ej: 200000">
                                <button onclick="toggleSubCalc('cell-calc')" class="bg-gray-200 p-2 rounded-lg hover:bg-gray-300 transition">âš™ï¸</button>
                            </div>
                            <div id="cell-calc" class="sub-calc p-3 border rounded-lg bg-white mt-2 space-y-3 shadow-inner">
                                <div class="space-y-2">
                                    <p class="text-xs font-semibold text-gray-700 border-b pb-1">Calcular volumen de stock celular:</p>
                                    <div class="flex items-center space-x-2">
                                        <input type="number" id="cell-stock-conc" placeholder="Conc. stock" class="w-full text-sm border-gray-300 rounded-lg p-2">
                                        <select id="cell-stock-conc-unit" class="text-sm border-gray-300 rounded-lg p-2">
                                            <option value="1">cÃ©lulas/mL</option>
                                            <option value="1000">cÃ©lulas/ÂµL</option>
                                        </select>
                                    </div>
                                    <button onclick="calculateCellVolume()" class="w-full text-sm bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition shadow-sm">Calcular Volumen (ÂµL)</button>
                                    <p id="cell-volume-result" class="text-sm font-medium text-blue-700 bg-blue-100 p-2 rounded-lg"></p>
                                </div>
                                <div class="mt-4 pt-4 border-t border-gray-200 space-y-2">
                                    <p class="text-xs font-semibold text-gray-700 border-b pb-1">Calculadora CÃ¡mara de Neubauer:</p>
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="number" id="neubauer-q1" placeholder="Cuadrante 1" class="w-full text-sm border-gray-300 rounded-lg p-2">
                                        <input type="number" id="neubauer-q2" placeholder="Cuadrante 2" class="w-full text-sm border-gray-300 rounded-lg p-2">
                                        <input type="number" id="neubauer-q3" placeholder="Cuadrante 3" class="w-full text-sm border-gray-300 rounded-lg p-2">
                                        <input type="number" id="neubauer-q4" placeholder="Cuadrante 4" class="w-full text-sm border-gray-300 rounded-lg p-2">
                                    </div>
                                    <button onclick="calculateNeubauer()" class="w-full text-sm bg-teal-500 text-white py-2 rounded-lg hover:bg-teal-600 transition shadow-sm">Calcular ConcentraciÃ³n</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="font-bold text-xl mb-3 text-indigo-700 border-b border-indigo-100 pb-2">Variables / Reactivos</h3>
                    <div id="variables-container" class="space-y-4">
                        </div>
                    <button onclick="addVariable()" class="mt-4 text-sm bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-xl hover:bg-gray-300 transition shadow-sm">+ AÃ±adir Variable</button>
                </div>

                <div>
                    <h3 class="font-bold text-xl mb-3 text-indigo-700 border-b border-indigo-100 pb-2">Pasos del Protocolo</h3>
                    <div class="p-4 border rounded-xl bg-indigo-50 space-y-4">
                        <div id="protocol-steps-container" class="space-y-3">
                            </div>
                        <button onclick="addProtocolStep()" class="text-sm bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-xl hover:bg-gray-300 transition shadow-sm">+ AÃ±adir Paso</button>
                    </div>
                </div>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-200 flex justify-end space-x-4">
                <button onclick="closeWellConfigModal()" class="bg-gray-500 text-white font-bold py-3 px-8 rounded-xl hover:bg-gray-600 transition shadow-lg">Cancelar</button>
                <button onclick="saveWellConfig()" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-blue-700 transition shadow-lg">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <div id="model-data-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg p-8 border-4 border-green-500/50">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">AÃ±adir Registro para Modelo <span id="modal-model-id" class="text-green-600 font-extrabold"></span></h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Peso (g):</label>
                    <input type="number" id="modal-model-weight" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Talla (cm):</label>
                    <input type="number" id="modal-model-size" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Glucosa (mg/dL):</label>
                    <input type="number" id="modal-model-glucose" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Fuerza Agarre (gf):</label>
                    <input type="number" id="modal-model-grip" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Notas/Otras Mediciones:</label>
                    <textarea id="modal-model-notes" rows="2" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm p-2"></textarea>
                </div>
            </div>
            <div class="mt-8 flex justify-end space-x-4 border-t pt-4">
                <button onclick="closeModelDataModal()" class="bg-gray-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-gray-600 transition shadow-md">Cancelar</button>
                <button onclick="saveModelDataEntry()" class="bg-green-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-green-700 transition shadow-md">Guardar Registro</button>
            </div>
        </div>
    </div>


    <div id="variable-template" class="hidden p-4 border rounded-xl bg-gray-50 transition hover:bg-gray-100">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-x-4 gap-y-3 items-center">
            <div class="md:col-span-12 flex justify-between items-center border-b pb-2 mb-2">
                <input type="text" class="variable-name w-full md:w-1/3 border-0 bg-transparent font-extrabold text-gray-800 focus:ring-0 text-lg" placeholder="Nombre (Ej: PMA)">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-red-500 hover:text-red-700 font-bold transition">ğŸ—‘ï¸ Eliminar</button>
            </div>

            <label class="md:col-span-2 text-sm font-medium text-gray-700">Conc. Final:</label>
            <div class="md:col-span-4">
                <input type="number" class="variable-final-conc w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Valor">
            </div>
            <div class="md:col-span-4">
                <select class="variable-final-conc-unit w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
            </div>
            <div class="md:col-span-2">
                <button onclick="toggleSubCalc(this.dataset.target)" data-target="stock-calc-X" class="stock-calc-toggle bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 w-full text-sm transition shadow-sm">âš™ï¸ Stock</button>
            </div>

            <div class="sub-calc md:col-span-12 p-3 border rounded-lg bg-white mt-2 space-y-3 shadow-inner">
                <p class="text-xs font-semibold text-gray-700 border-b pb-1">Calcular volumen de stock del reactivo:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <input type="number" class="variable-stock-conc w-full text-sm border-gray-300 rounded-lg p-2" placeholder="Conc. stock">
                    <select class="variable-stock-conc-unit w-full text-sm border-gray-300 rounded-lg p-2"></select>
                </div>
                <button onclick="calculateStockVolume(this)" class="w-full text-sm bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition shadow-sm">Calcular Volumen (ÂµL)</button>
                <p class="variable-stock-volume-result text-sm font-medium text-blue-700 bg-blue-100 p-2 rounded-lg"></p>
            </div>
        </div>
    </div>

    <div id="protocol-step-template" class="hidden p-3 border rounded-xl bg-white shadow-sm hover:shadow-md transition">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
            <input type="text" class="protocol-step-name md:col-span-1 border-gray-300 rounded-lg p-2" placeholder="Nombre (Ej: IncubaciÃ³n PMA)">
            <div class="flex items-center space-x-2 md:col-span-2">
                <input type="number" class="protocol-step-duration w-1/2 border-gray-300 rounded-lg p-2" placeholder="DuraciÃ³n">
                <select class="protocol-step-unit w-1/2 border-gray-300 rounded-lg p-2">
                    <option value="3600000">horas</option>
                    <option value="60000">minutos</option>
                    <option value="86400000">dÃ­as</option>
                </select>
            </div>
            <div class="md:col-span-1 flex justify-end">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-red-500 hover:text-red-700 font-bold transition">ğŸ—‘ï¸ Eliminar</button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="toast fixed bottom-5 right-5 bg-green-600 text-white py-4 px-8 rounded-xl shadow-2xl z-50">
        <p id="toast-message" class="font-semibold"></p>
    </div>

    <script>
        // --- DATA & STATE MANAGEMENT ---
        const ATOMIC_WEIGHTS = { 
Â  Â  Â  Â  Â  Â  'H': 1.008, 'C': 12.011, 'N': 14.007, 'O': 15.999, 'Na': 22.990, 'Mg': 24.305,Â 
Â  Â  Â  Â  Â  Â  'P': 30.974, 'S': 32.06, 'Cl': 35.45, 'K': 39.098, 'Ca': 40.078, 'Fe': 55.845,
            'He': 4.0026, 'Li': 6.94, 'Be': 9.0122, 'B': 10.81, 'F': 18.998, 'Ne': 20.180, 'Al': 26.982, 'Si': 28.085, 'Ar': 39.948, 'Sc': 44.956, 'Ti': 47.867, 'V': 50.942, 'Cr': 51.996, 'Mn': 54.938, 'Co': 58.933, 'Ni': 58.693, 'Cu': 63.546, 'Zn': 65.38, 'Ga': 69.723, 'Ge': 72.630, 'As': 74.922, 'Se': 78.971, 'Br': 79.904, 'Kr': 83.798, 'Rb': 85.468, 'Sr': 87.62, 'Y': 88.906, 'Zr': 91.224, 'Nb': 92.906, 'Mo': 95.96, 'Tc': 98, 'Ru': 101.07, 'Rh': 102.91, 'Pd': 106.42, 'Ag': 107.87, 'Cd': 112.41, 'In': 114.82, 'Sn': 118.71, 'Sb': 121.76, 'Te': 127.60, 'I': 126.90, 'Xe': 131.29, 'Cs': 132.91, 'Ba': 137.33,
Â  Â  Â  Â  };

Â  Â  Â  Â  const CONVERSION_FACTORS = {
Â  Â  Â  Â  Â  Â  'mass': { 'kg': 1000, 'g': 1, 'mg': 1e-3, 'Âµg': 1e-6, 'ng': 1e-9, 'pg': 1e-12 },
Â  Â  Â  Â  Â  Â  'volume': { 'L': 1, 'mL': 1e-3, 'ÂµL': 1e-6, 'nL': 1e-9 },
Â  Â  Â  Â  Â  Â  'concentration': { 'M': 1, 'mM': 1e-3, 'ÂµM': 1e-6, 'nM': 1e-9 },
Â  Â  Â  Â  Â  Â  'length': { 'm': 1, 'cm': 1e-2, 'mm': 1e-3},
Â  Â  Â  Â  Â  Â  'force': { 'N': 1, 'gf': 9.80665e-3 }, 
Â  Â  Â  Â  Â  Â  'pressure': { 'Pa': 1, 'mmHg': 133.322 },
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  let wellData = {};Â 
Â  Â  Â  Â  let selectedWells = new Set();
Â  Â  Â  Â  let variableCounter = 0;
Â  Â  Â  Â  let runningTimers = {};
Â  Â  Â  Â  let animalModels = {}; 
Â  Â  Â  Â  let currentEditingModelId = null; 

Â  Â  Â  Â  // --- TABS & NAVIGATION ---
Â  Â  Â  Â  function changeTab(tabName) {
Â  Â  Â  Â  Â  Â  const contents = ['planner', 'models', 'protocols', 'report', 'calculators', 'guide', 'about']; 
Â  Â  Â  Â  Â  Â  contents.forEach(content => {
Â  Â  Â  Â  Â  Â  Â  Â  const el = document.getElementById(`content-${content}`);
Â  Â  Â  Â  Â  Â  Â  Â  const tab = document.getElementById(`tab-${content}`);
Â  Â  Â  Â  Â  Â  Â  Â  if (el) el.style.display = content === tabName ? 'block' : 'none';
Â  Â  Â  Â  Â  Â  Â  Â  if (tab) tab.classList.toggle('active', content === tabName);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â if (tabName === 'models') {
Â  Â  Â  Â  Â  Â  Â  Â  renderAnimalModels(); 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- QUICK CALCULATORS (Molar Mass, Unit Conversion, Dilution) ---
Â  Â  Â  Â  function parseFormula(formula) {
Â  Â  Â  Â  Â  Â  const regex = /([A-Z][a-z]*)(\d*)|(\()|(\))(\d*)/g;
Â  Â  Â  Â  Â  Â  let match;
Â  Â  Â  Â  Â  Â  const stack = [{}]; 
Â  Â  Â  Â  Â  Â  while ((match = regex.exec(formula))) {
Â  Â  Â  Â  Â  Â  Â  Â  const [, element, countStr, openParen, closeParen, parenCountStr] = match;
Â  Â  Â  Â  Â  Â  Â  Â  const count = countStr ? parseInt(countStr) : 1;
Â  Â  Â  Â  Â  Â  Â  Â  const parenCount = parenCountStr ? parseInt(parenCountStr) : 1;

Â  Â  Â  Â  Â  Â  Â  Â  if (element) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentGroup = stack[stack.length - 1];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentGroup[element] = (currentGroup[element] || 0) + count;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (openParen) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stack.push({});
Â  Â  Â  Â  Â  Â  Â  Â  } else if (closeParen && stack.length > 1) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const completedGroup = stack.pop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentGroup = stack[stack.length - 1];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (const el in completedGroup) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentGroup[el] = (currentGroup[el] || 0) + completedGroup[el] * parenCount;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (stack.length !== 1) { 
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("ParÃ©ntesis no balanceados en la fÃ³rmula.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return stack[0]; 
Â  Â  Â  Â  }


Â  Â  Â  Â  function calculateMolarMass() {
Â  Â  Â  Â  Â  Â  const formula = document.getElementById('chem-formula').value.replace(/\s+/g, ''); 
Â  Â  Â  Â  Â  Â  const resultDiv = document.getElementById('molar-mass-result');
Â  Â  Â  Â  Â  Â  if (!formula) {
Â  Â  Â  Â  Â  Â  Â  Â  resultDiv.innerHTML = `<span class="text-red-500">Por favor, introduce una fÃ³rmula.</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const composition = parseFormula(formula);
Â  Â  Â  Â  Â  Â  Â  Â  let totalMass = 0;
Â  Â  Â  Â  Â  Â  Â  Â  let breakdown = [];
Â  Â  Â  Â  Â  Â  Â  Â  for (const element in composition) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!ATOMIC_WEIGHTS[element]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Elemento desconocido: ${element}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const mass = ATOMIC_WEIGHTS[element] * composition[element];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalMass += mass;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  breakdown.push(`<b>${element}</b>: ${composition[element]} x ${ATOMIC_WEIGHTS[element]} = ${mass.toFixed(4)}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  resultDiv.innerHTML = `<b>Masa Molar Total: <span class="text-blue-600">${totalMass.toFixed(4)} g/mol</span></b><br><small>${breakdown.join('<br>')}</small>`;
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  resultDiv.innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function getUnitType(unit) {
Â  Â  Â  Â  Â  Â  Â if (!unit) return null;
Â  Â  Â  Â  Â  Â  Â for (const type in CONVERSION_FACTORS) {
Â  Â  Â  Â  Â  Â  Â  Â  Â if (CONVERSION_FACTORS[type][unit]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return type;
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  if (unit.includes('/')) {
Â  Â  Â  Â  Â  Â  Â  Â  const parts = unit.split('/');
Â  Â  Â  Â  Â  Â  Â  Â  if (parts.length === 2 && CONVERSION_FACTORS.mass[parts[0]] && CONVERSION_FACTORS.volume[parts[1]]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return 'combined_concentration';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return null; 
Â  Â  Â  Â  }

Â  Â  Â  Â  function convertToBaseUnit(value, fromUnit) {
Â  Â  Â  Â  Â  Â  const type = getUnitType(fromUnit);
Â  Â  Â  Â  Â  Â  if (!type || isNaN(value)) return NaN;

Â  Â  Â  Â  Â  Â  if (type === 'combined_concentration') {
Â  Â  Â  Â  Â  Â  Â  Â  Â const [massUnit, volUnit] = fromUnit.split('/');
Â  Â  Â  Â  Â  Â  Â  Â  Â const valueInG = value * (CONVERSION_FACTORS.mass[massUnit] || NaN);
Â  Â  Â  Â  Â  Â  Â  Â  Â const volumeInL = 1 * (CONVERSION_FACTORS.volume[volUnit] || NaN); 
Â  Â  Â  Â  Â  Â  Â  Â  Â if (isNaN(valueInG) || isNaN(volumeInL) || volumeInL === 0) return NaN;
Â  Â  Â  Â  Â  Â  Â  Â  Â return valueInG / volumeInL; 
Â  Â  Â  Â  Â  Â  } else if (CONVERSION_FACTORS[type]) {
Â  Â  Â  Â  Â  Â  Â  Â  return value * (CONVERSION_FACTORS[type][fromUnit] || NaN);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return NaN; 
Â  Â  Â  Â  }

Â  Â  Â  Â  function convertFromBaseUnit(value, toUnit) {
Â  Â  Â  Â  Â  Â  const type = getUnitType(toUnit);
Â  Â  Â  Â  Â  Â  Â if (!type || isNaN(value)) return NaN;

Â  Â  Â  Â  Â  Â  Â if (type === 'combined_concentration') {
Â  Â  Â  Â  Â  Â  Â  Â  Â const [massUnit, volUnit] = toUnit.split('/');
Â  Â  Â  Â  Â  Â  Â  Â  Â const targetMassFactor = CONVERSION_FACTORS.mass[massUnit];
Â  Â  Â  Â  Â  Â  Â  Â  Â const targetVolFactor = CONVERSION_FACTORS.volume[volUnit];
Â  Â  Â  Â  Â  Â  Â  Â  Â if (!targetMassFactor || !targetVolFactor) return NaN;
Â  Â  Â  Â  Â  Â  Â  Â  Â return value * targetMassFactor / targetVolFactor;
Â  Â  Â  Â  Â  Â  Â } else if (CONVERSION_FACTORS[type]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â const factor = CONVERSION_FACTORS[type][toUnit];
Â  Â  Â  Â  Â  Â  Â  Â  Â if (!factor) return NaN;
Â  Â  Â  Â  Â  Â  Â  Â  Â return value / factor;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  return NaN; 
Â  Â  Â  Â  }

Â  Â  Â  Â  function _pureConvertUnits(value, from, to) {
Â  Â  Â  Â  Â  Â  if (isNaN(value) || !from || !to) return NaN;
Â  Â  Â  Â  Â  Â  if (from === to) return value;

Â  Â  Â  Â  Â  Â  const fromType = getUnitType(from);
Â  Â  Â  Â  Â  Â  const toType = getUnitType(to);

Â  Â  Â  Â  Â  Â  Â if (!fromType || !toType || fromType !== toType) {
Â  Â  Â  Â  Â  Â  Â  Â  Â return NaN; 
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const baseValue = convertToBaseUnit(value, from);
Â  Â  Â  Â  Â  Â  if (isNaN(baseValue)) return NaN;
Â  Â  Â  Â  Â  Â  const finalValue = convertFromBaseUnit(baseValue, to);
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  return finalValue;
Â  Â  Â  Â  }


Â  Â  Â  Â  function convertUnits() {
Â  Â  Â  Â  Â  Â  const value = parseFloat(document.getElementById('uc-value').value);
Â  Â  Â  Â  Â  Â  const from = document.getElementById('uc-from').value;
Â  Â  Â  Â  Â  Â  const to = document.getElementById('uc-to').value;
Â  Â  Â  Â  Â  Â  const resultDiv = document.getElementById('uc-result');

Â  Â  Â  Â  Â  Â  const finalValue = _pureConvertUnits(value, from, to);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (isNaN(finalValue)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â resultDiv.innerHTML = `<span class="text-red-500">No se puede convertir entre estas unidades o tipos.</span>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â resultDiv.textContent = `${value} ${from} = ${finalValue.toExponential(4)} ${to}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function calculateDilution() {
Â  Â  Â  Â  Â  Â  const fields = {
Â  Â  Â  Â  Â  Â  Â  Â  c1: { val: parseFloat(document.getElementById('c1').value), unit: document.getElementById('c1-unit').value },
Â  Â  Â  Â  Â  Â  Â  Â  v1: { val: parseFloat(document.getElementById('v1').value), unit: document.getElementById('v1-unit').value },
Â  Â  Â  Â  Â  Â  Â  Â  c2: { val: parseFloat(document.getElementById('c2').value), unit: document.getElementById('c2-unit').value },
Â  Â  Â  Â  Â  Â  Â  Â  v2: { val: parseFloat(document.getElementById('v2').value), unit: document.getElementById('v2-unit').value },
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const resultDiv = document.getElementById('dilution-result');
Â  Â  Â  Â  Â  Â  const emptyFields = Object.keys(fields).filter(k => isNaN(fields[k].val));

Â  Â  Â  Â  Â  Â  if (emptyFields.length !== 1) {
Â  Â  Â  Â  Â  Â  Â  Â  resultDiv.innerHTML = `<span class="text-red-500">Por favor, introduce exactamente 3 valores numÃ©ricos.</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const missingVar = emptyFields[0];
Â  Â  Â  Â  Â  Â  let result;
Â  Â  Â  Â  Â  Â  let resultUnit;

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â const c2_conv = _pureConvertUnits(fields.c2.val, fields.c2.unit, fields.c1.unit);
Â  Â  Â  Â  Â  Â  Â  Â  const v2_conv = _pureConvertUnits(fields.v2.val, fields.v2.unit, fields.v1.unit);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (isNaN(c2_conv) && !isNaN(fields.c2.val)) throw new Error(`No se puede convertir la unidad de C2 (${fields.c2.unit}) a la de C1 (${fields.c1.unit}). AsegÃºrate que son del mismo tipo (ej. ambas molares o ambas masa/volumen).`);
Â  Â  Â  Â  Â  Â  Â  Â  if (isNaN(v2_conv) && !isNaN(fields.v2.val)) throw new Error(`No se puede convertir la unidad de V2 (${fields.v2.unit}) a la de V1 (${fields.v1.unit}).`);

Â  Â  Â  Â  Â  Â  Â  Â  let c1_val = fields.c1.val;
Â  Â  Â  Â  Â  Â  Â  Â  let v1_val = fields.v1.val;

Â  Â  Â  Â  Â  Â  Â  Â  switch (missingVar) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'c1': 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = (c2_conv * v2_conv) / v1_val;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resultUnit = fields.c1.unit; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'v1': 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = (c2_conv * v2_conv) / c1_val;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resultUnit = fields.v1.unit; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'c2': 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const c2_in_c1_units = (c1_val * v1_val) / v2_conv;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = _pureConvertUnits(c2_in_c1_units, fields.c1.unit, fields.c2.unit);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resultUnit = fields.c2.unit;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'v2': 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const v2_in_v1_units = (c1_val * v1_val) / c2_conv;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result = _pureConvertUnits(v2_in_v1_units, fields.v1.unit, fields.v2.unit);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resultUnit = fields.v2.unit;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (isNaN(result) || !isFinite(result)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("El resultado es invÃ¡lido. Revisa los valores y unidades.");
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  resultDiv.textContent = `Resultado: ${missingVar.toUpperCase()} = ${result.toPrecision(4)} ${resultUnit}`;

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â resultDiv.innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- PLATE PLANNER ---
Â  Â  Â  Â  Â function generatePlate(restoringData = null) {
Â  Â  Â  Â  Â  Â  const plateType = restoringData ? restoringData.plateType : document.getElementById('plate-type').value;
Â  Â  Â  Â  Â  Â  document.getElementById('plate-type').value = plateType; 
Â  Â  Â  Â  Â  Â  const layout = document.getElementById('plate-layout');
Â  Â  Â  Â  Â  Â  layout.innerHTML = ''; 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!restoringData) {
Â  Â  Â  Â  Â  Â  Â  Â  wellData = {};
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  selectedWells.clear(); 

Â  Â  Â  Â  Â  Â  const plateConfigs = {
Â  Â  Â  Â  Â  Â  Â  Â  '6': { rows: 2, cols: 3 }, '12': { rows: 3, cols: 4 },
Â  Â  Â  Â  Â  Â  Â  Â  '24': { rows: 4, cols: 6 }, '48': { rows: 6, cols: 8 },
Â  Â  Â  Â  Â  Â  Â  Â  '96': { rows: 8, cols: 12 },
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  const config = plateConfigs[plateType];
Â  Â  Â  Â  Â  Â  layout.style.gridTemplateColumns = `repeat(${config.cols}, minmax(0, 1fr))`;
Â  Â  Â  Â  Â  Â  layout.style.display = 'grid';

Â  Â  Â  Â  Â  Â  for (let r = 0; r < config.rows; r++) {
Â  Â  Â  Â  Â  Â  Â  Â  for (let c = 0; c < config.cols; c++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const rowLabel = String.fromCharCode(65 + r); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const colLabel = c + 1; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const wellId = `${rowLabel}${colLabel}`; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const well = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  well.id = `well-${wellId}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  well.className = 'well w-12 h-12 md:w-16 md:h-16 rounded-full flex items-center justify-center cursor-pointer bg-white';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  well.dataset.id = wellId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const label = document.createElement('span');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label.className = 'well-label text-sm md:text-base font-semibold';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label.textContent = wellId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  well.appendChild(label);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  well.addEventListener('click', () => toggleWellSelection(wellId));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  layout.appendChild(well); 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (restoringData?.wellData?.[wellId]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = restoringData.wellData[wellId];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  well.classList.add('configured'); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.wellType && data.wellType !== 'default') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  well.classList.add(data.wellType);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateProtocolSchedule(); 
Â  Â  Â  Â  }


Â  Â  Â  Â  function toggleWellSelection(wellId) {
Â  Â  Â  Â  Â  Â  const wellEl = document.getElementById(`well-${wellId}`);
Â  Â  Â  Â  Â  Â  if (selectedWells.has(wellId)) { 
Â  Â  Â  Â  Â  Â  Â  Â  selectedWells.delete(wellId);
Â  Â  Â  Â  Â  Â  Â  Â  wellEl.classList.remove('selected');
Â  Â  Â  Â  Â  Â  } else { 
Â  Â  Â  Â  Â  Â  Â  Â  selectedWells.add(wellId);
Â  Â  Â  Â  Â  Â  Â  Â  wellEl.classList.add('selected');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function selectAllWells() {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('#plate-layout .well').forEach(well => {
Â  Â  Â  Â  Â  Â  Â  Â  const wellId = well.dataset.id;
Â  Â  Â  Â  Â  Â  Â  Â  if (!selectedWells.has(wellId)) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedWells.add(wellId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  well.classList.add('selected');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function clearSelection() {
Â  Â  Â  Â  Â  Â  selectedWells.forEach(wellId => { 
Â  Â  Â  Â  Â  Â  Â  Â  const wellEl = document.getElementById(`well-${wellId}`);
Â  Â  Â  Â  Â  Â  Â  Â  if (wellEl) wellEl.classList.remove('selected');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  selectedWells.clear(); 
Â  Â  Â  Â  }

Â  Â  Â  Â  function openWellConfigModal() {
Â  Â  Â  Â  Â  Â  if (selectedWells.size === 0) { 
Â  Â  Â  Â  Â  Â  Â  Â  showToast('Por favor, selecciona al menos un pozo para configurar.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const wellIds = Array.from(selectedWells).sort();Â 
Â  Â  Â  Â  Â  Â  document.getElementById('well-ids-display').textContent = wellIds.join(', ');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const firstWellId = wellIds[0];
Â  Â  Â  Â  Â  Â  if (wellData[firstWellId]) {
Â  Â  Â  Â  Â  Â  Â  Â  loadConfigToModal(wellData[firstWellId]); 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  resetModal(); 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.getElementById('well-config-modal').style.display = 'flex';
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeWellConfigModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('well-config-modal').style.display = 'none'; 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â function resetModal() {
Â  Â  Â  Â  Â  Â  Â document.getElementById('well-type').value = 'default';
Â  Â  Â  Â  Â  Â  document.getElementById('well-total-volume').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('well-cell-count').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('variables-container').innerHTML = ''; 
Â  Â  Â  Â  Â  Â  document.getElementById('protocol-steps-container').innerHTML = ''; 
Â  Â  Â  Â  Â  Â  document.getElementById('neubauer-q1').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('neubauer-q2').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('neubauer-q3').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('neubauer-q4').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('cell-stock-conc').value = '';
Â  Â  Â  Â  Â  Â  Â document.getElementById('cell-stock-conc-unit').value = '1'; 
Â  Â  Â  Â  Â  Â  document.getElementById('cell-volume-result').textContent = '';
Â  Â  Â  Â  Â  Â  variableCounter = 0; 
Â  Â  Â  Â  Â  Â  addVariable(); 
Â  Â  Â  Â  Â  Â  addProtocolStep(); 
Â  Â  Â  Â  }


Â  Â  Â  Â  function loadConfigToModal(data) {
Â  Â  Â  Â  Â  Â  resetModal(); 
Â  Â  Â  Â  Â  Â  document.getElementById('well-type').value = data.wellType || 'default';
Â  Â  Â  Â  Â  Â  document.getElementById('well-total-volume').value = data.totalVolume || '';
Â  Â  Â  Â  Â  Â  document.getElementById('well-cell-count').value = data.cells?.count || '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const variablesContainer = document.getElementById('variables-container');
Â  Â  Â  Â  Â  Â  variablesContainer.innerHTML = ''; 
Â  Â  Â  Â  Â  Â  if (data.variables?.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  data.variables.forEach(v => addVariable(v));Â 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  addVariable(); 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const stepsContainer = document.getElementById('protocol-steps-container');
Â  Â  Â  Â  Â  Â  stepsContainer.innerHTML = ''; 
Â  Â  Â  Â  Â  Â  if (data.protocol?.steps?.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  data.protocol.steps.forEach(s => addProtocolStep(s));Â 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  addProtocolStep(); 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  function saveWellConfig() {
Â  Â  Â  Â  Â  Â  const wellType = document.getElementById('well-type').value;
Â  Â  Â  Â  Â  Â  const totalVolume = parseFloat(document.getElementById('well-total-volume').value);
Â  Â  Â  Â  Â  Â  const cellCount = parseFloat(document.getElementById('well-cell-count').value);

Â  Â  Â  Â  Â  Â  const variables = [];
Â  Â  Â  Â  Â  Â  document.querySelectorAll('#variables-container > div.p-4').forEach(varDiv => { 
Â  Â  Â  Â  Â  Â  Â  Â  const variable = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: varDiv.dataset.id, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: varDiv.querySelector('.variable-name').value.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finalConc: parseFloat(varDiv.querySelector('.variable-final-conc').value),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finalConcUnit: varDiv.querySelector('.variable-final-conc-unit').value,
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  if (variable.name && !isNaN(variable.finalConc)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  variables.push(variable);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const protocolSteps = [];
Â  Â  Â  Â  Â  Â  document.querySelectorAll('#protocol-steps-container > div').forEach(stepDiv => {
Â  Â  Â  Â  Â  Â  Â  Â  const step = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: stepDiv.querySelector('.protocol-step-name').value.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  duration: parseFloat(stepDiv.querySelector('.protocol-step-duration').value),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unit: parseInt(stepDiv.querySelector('.protocol-step-unit').value)Â 
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  if (step.name && !isNaN(step.duration)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  protocolSteps.push(step);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const configData = {
Â  Â  Â  Â  Â  Â  Â  Â  wellType,
Â  Â  Â  Â  Â  Â  Â  Â  totalVolume: isNaN(totalVolume) ? null : totalVolume, 
Â  Â  Â  Â  Â  Â  Â  Â  cells: { count: isNaN(cellCount) ? null : cellCount }, 
Â  Â  Â  Â  Â  Â  Â  Â  variables,
Â  Â  Â  Â  Â  Â  Â  Â  protocol: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  steps: protocolSteps
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  selectedWells.forEach(wellId => {
Â  Â  Â  Â  Â  Â  Â  Â  wellData[wellId] = JSON.parse(JSON.stringify(configData));Â 
Â  Â  Â  Â  Â  Â  Â  Â  const wellEl = document.getElementById(`well-${wellId}`);
Â  Â  Â  Â  Â  Â  Â  Â  if (wellEl) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â wellEl.classList.remove('control', 'experimental', 'blanco', 'tratamiento-1', 'tratamiento-2', 'default');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(wellType !== 'default') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  wellEl.classList.add(wellType); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  wellEl.classList.add('configured'); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  wellEl.classList.remove('selected'); 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  updateProtocolSchedule(); 
Â  Â  Â  Â  Â  Â  clearSelection(); 
Â  Â  Â  Â  Â  Â  closeWellConfigModal(); 
Â  Â  Â  Â  Â  Â  showToast('ConfiguraciÃ³n guardada para los pozos seleccionados.'); 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function addVariable(data = null) {
Â  Â  Â  Â  Â  Â  const template = document.getElementById('variable-template');
Â  Â  Â  Â  Â  Â  const clone = template.cloneNode(true); 
Â  Â  Â  Â  Â  Â  clone.id = ''; 
Â  Â  Â  Â  Â  Â  clone.classList.remove('hidden'); 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const uniqueId = `var-${variableCounter++}`;Â 
Â  Â  Â  Â  Â  Â  clone.dataset.id = uniqueId; 

Â  Â  Â  Â  Â  Â  populateUnitDropdowns(clone); 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const stockCalcToggle = clone.querySelector('.stock-calc-toggle');
Â  Â  Â  Â  Â  Â  const subCalcDiv = clone.querySelector('.sub-calc');
Â  Â  Â  Â  Â  Â  const subCalcId = `stock-calc-${uniqueId}`;
Â  Â  Â  Â  Â  Â  stockCalcToggle.dataset.target = subCalcId; 
Â  Â  Â  Â  Â  Â  subCalcDiv.id = subCalcId; 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (data) {
Â  Â  Â  Â  Â  Â  Â  Â  Â clone.querySelector('.variable-name').value = data.name || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â clone.querySelector('.variable-final-conc').value = data.finalConc || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â clone.querySelector('.variable-final-conc-unit').value = data.finalConcUnit || 'ÂµM'; 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.getElementById('variables-container').appendChild(clone);
Â  Â  Â  Â  }

Â  Â  Â  Â  function addProtocolStep(data = null) {
Â  Â  Â  Â  Â  Â  const template = document.getElementById('protocol-step-template');
Â  Â  Â  Â  Â  Â  const clone = template.cloneNode(true); 
Â  Â  Â  Â  Â  Â  clone.id = ''; 
Â  Â  Â  Â  Â  Â  clone.classList.remove('hidden'); 
Â  Â  Â  Â  Â  Â  if (data) {
Â  Â  Â  Â  Â  Â  Â  Â  clone.querySelector('.protocol-step-name').value = data.name || '';
Â  Â  Â  Â  Â  Â  Â  Â  clone.querySelector('.protocol-step-duration').value = data.duration || '';
Â  Â  Â  Â  Â  Â  Â  Â  clone.querySelector('.protocol-step-unit').value = data.unit || '3600000'; 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.getElementById('protocol-steps-container').appendChild(clone);
Â  Â  Â  Â  }

Â  Â  Â  Â  function calculateCellVolume() {
Â  Â  Â  Â  Â  Â  const cellCount = parseFloat(document.getElementById('well-cell-count').value);
Â  Â  Â  Â  Â  Â  let stockConc = parseFloat(document.getElementById('cell-stock-conc').value);Â 
Â  Â  Â  Â  Â  Â  const stockUnitFactor = parseFloat(document.getElementById('cell-stock-conc-unit').value);Â 
Â  Â  Â  Â  Â  Â  const resultEl = document.getElementById('cell-volume-result');

Â  Â  Â  Â  Â  Â  if (isNaN(cellCount) || isNaN(stockConc) || stockConc === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  resultEl.textContent = 'Inputs invÃ¡lidos.';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const stockConcInMl = stockConc * stockUnitFactor;

Â  Â  Â  Â  Â  Â  const volumeInMicroL = (cellCount / stockConcInMl) * 1000;
Â  Â  Â  Â  Â  Â  Â // Display result
Â  Â  Â  Â  Â  Â  resultEl.textContent = `Tomar: ${volumeInMicroL.toFixed(2)} ÂµL`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function calculateNeubauer() {
Â  Â  Â  Â  Â  Â  Â const q1 = parseFloat(document.getElementById('neubauer-q1').value) || 0;
Â  Â  Â  Â  Â  Â  const q2 = parseFloat(document.getElementById('neubauer-q2').value) || 0;
Â  Â  Â  Â  Â  Â  const q3 = parseFloat(document.getElementById('neubauer-q3').value) || 0;
Â  Â  Â  Â  Â  Â  const q4 = parseFloat(document.getElementById('neubauer-q4').value) || 0;

Â  Â  Â  Â  Â  Â  const sum = q1 + q2 + q3 + q4;
Â  Â  Â  Â  Â  Â  if (sum === 0) { 
Â  Â  Â  Â  Â  Â  Â  Â  showToast("Introduce los conteos de los cuadrantes.", "error");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const avg = sum / 4; 
Â  Â  Â  Â  Â  Â  const concentration = avg * 10000; 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('cell-stock-conc-unit').value = "1"; 
Â  Â  Â  Â  Â  Â  document.getElementById('cell-stock-conc').value = concentration; 
Â  Â  Â  Â  Â  Â  showToast(`ConcentraciÃ³n calculada: ${concentration.toExponential(2)} cÃ©lulas/mL.`); 
Â  Â  Â  Â  Â  Â  Â calculateCellVolume();Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  function calculateStockVolume(button) {
Â  Â  Â  Â  Â  Â  Â const variableSection = button.closest('.p-4.border.rounded-lg.bg-gray-50');Â 
Â  Â  Â  Â  Â  Â  if (!variableSection) return;Â 

Â  Â  Â  Â  Â  Â  const finalConc = parseFloat(variableSection.querySelector('.variable-final-conc').value);
Â  Â  Â  Â  Â  Â  const finalConcUnit = variableSection.querySelector('.variable-final-conc-unit').value;
Â  Â  Â  Â  Â  Â  const stockConc = parseFloat(variableSection.querySelector('.variable-stock-conc').value);
Â  Â  Â  Â  Â  Â  const stockConcUnit = variableSection.querySelector('.variable-stock-conc-unit').value;
Â  Â  Â  Â  Â  Â  Â const totalVolume = parseFloat(document.getElementById('well-total-volume').value); 
Â  Â  Â  Â  Â  Â  const resultEl = variableSection.querySelector('.variable-stock-volume-result');

Â  Â  Â  Â  Â  Â  if (isNaN(finalConc) || isNaN(stockConc) || isNaN(totalVolume) || stockConc === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â resultEl.textContent = 'Inputs invÃ¡lidos.';
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const finalConcConverted = _pureConvertUnits(finalConc, finalConcUnit, stockConcUnit);
Â  Â  Â  Â  Â  Â  if (isNaN(finalConcConverted)) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â resultEl.textContent = 'Error de conversiÃ³n de unidad.';
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const V_Stock_in_uL = (finalConcConverted * totalVolume) / stockConc;

Â  Â  Â  Â  Â  Â  Â // Display result
Â  Â  Â  Â  Â  Â  resultEl.textContent = `Tomar: ${V_Stock_in_uL.toFixed(3)} ÂµL`;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function calculateMasterMix() {
Â  Â  Â  Â  Â  Â  if (selectedWells.size === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast("Selecciona los pozos para los que quieres calcular la mezcla.", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const numWells = selectedWells.size;
Â  Â  Â  Â  Â  Â  const extraVolFactor = 1 + (parseFloat(document.getElementById('extra-volume').value) || 0) / 100;
Â  Â  Â  Â  Â  Â  const totalWellsToPrep = numWells * extraVolFactor;

Â  Â  Â  Â  Â  Â  const masterMix = {};
Â  Â  Â  Â  Â  Â  let firstWellId = Array.from(selectedWells)[0];
Â  Â  Â  Â  Â  Â  const baseConfig = wellData[firstWellId];

Â  Â  Â  Â  Â  Â  if (!baseConfig) { 
Â  Â  Â  Â  Â  Â  Â  Â  showToast("El primer pozo seleccionado no estÃ¡ configurado.", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (baseConfig.cells?.count > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  masterMix['CÃ©lulas'] = {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total: `${(baseConfig.cells.count * totalWellsToPrep).toExponential(2)} cÃ©lulas`,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  note: 'El volumen a tomar depende de la concentraciÃ³n de tu stock celular.'
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  baseConfig.variables.forEach(v => {
Â  Â  Â  Â  Â  Â  Â  Â  Â masterMix[v.name] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â total: `AÃ±adir para una concentraciÃ³n final de ${v.finalConc} ${v.finalConcUnit}`,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â note: 'El volumen a tomar depende de la concentraciÃ³n de tu reactivo stock.'
Â  Â  Â  Â  Â  Â  Â  Â  Â };
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let html = `<h3 class="font-bold mb-2">Receta para ${numWells} pozos (+${(extraVolFactor-1)*100}% extra):</h3>`;
Â  Â  Â  Â  Â  Â  html += `<table class="min-w-full divide-y divide-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead class="bg-gray-100"><tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Componente</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Cantidad Total / Objetivo</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Notas</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

Â  Â  Â  Â  Â  Â  for(const component in masterMix) { 
Â  Â  Â  Â  Â  Â  Â  Â  html += `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-4 py-2 whitespace-nowrap text-sm font-medium">${component}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-4 py-2 whitespace-nowrap text-sm">${masterMix[component].total}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${masterMix[component].note}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </tr>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â html += `<tr><td class="px-4 py-2 text-sm font-bold">Medio de cultivo (completar hasta)</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-4 py-2 text-sm font-bold">${(baseConfig.totalVolume * totalWellsToPrep).toFixed(2)} ÂµL</td><td></td></tr>`;

Â  Â  Â  Â  Â  Â  html += `</tbody></table><p class="text-xs mt-2 text-gray-500">Usa las sub-calculadoras en la configuraciÃ³n de pozos para determinar los volÃºmenes exactos a tomar de tus stocks.</p>`;
Â  Â  Â  Â  Â  Â  document.getElementById('master-mix-results').innerHTML = html;
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateProtocolSchedule() {
Â  Â  Â  Â  Â  Â  const scheduleContainer = document.getElementById('protocol-schedule-container');
Â  Â  Â  Â  Â  Â  scheduleContainer.innerHTML = ''; 
Â  Â  Â  Â  Â  Â  let allSteps = [];

Â  Â  Â  Â  Â  Â  for (const wellId in wellData) {
Â  Â  Â  Â  Â  Â  Â  Â  const data = wellData[wellId];
Â  Â  Â  Â  Â  Â  Â  Â  if (!data.protocol?.steps) continue;Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  data.protocol.steps.forEach((step, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allSteps.push({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...step, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  wellId,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stepIndex: index + 1, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  eventId: `${wellId}-${step.name.replace(/\s/g, '')}-${index}`Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const uniqueSteps = Object.values(allSteps.reduce((acc, cur) => {
Â  Â  Â  Â  Â  Â  Â  Â  const key = `${cur.name}-${cur.duration}-${cur.unit}-${cur.stepIndex}`;Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!acc[key]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â acc[key] = { ...cur, wells: [cur.wellId] };Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  acc[key].wells.push(cur.wellId); 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return acc;
Â  Â  Â  Â  Â  Â  }, {}));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  uniqueSteps.sort((a,b) => a.stepIndex - b.stepIndex);


Â  Â  Â  Â  Â  Â  if (uniqueSteps.length === 0) { 
Â  Â  Â  Â  Â  Â  Â  Â  scheduleContainer.innerHTML = '<p class="text-gray-500">No hay pasos de protocolo configurados.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  uniqueSteps.forEach((step) => {
Â  Â  Â  Â  Â  Â  Â  Â  const durationMs = step.duration * step.unit; 
Â  Â  Â  Â  Â  Â  Â  Â  Â const unitText = {3600000: 'horas', 60000: 'minutos', 86400000: 'dÃ­as'}[step.unit] || 'ms';

Â  Â  Â  Â  Â  Â  Â  Â  const eventEl = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  eventEl.className = 'flex items-center justify-between p-3 bg-gray-100 rounded-lg';
Â  Â  Â  Â  Â  Â  Â  Â  eventEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bold">Paso ${step.stepIndex}: ${step.name}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm text-gray-600 ml-2">(${step.duration} ${unitText})</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-blue-600">Pozos: ${step.wells.join(', ')}</p>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center space-x-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="timer-display-${step.eventId}" class="font-mono text-lg">--:--:--</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="timer-btn-${step.eventId}" class="bg-green-500 text-white text-sm font-semibold py-1 px-3 rounded-md hover:bg-green-600">Iniciar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  scheduleContainer.appendChild(eventEl); 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`timer-btn-${step.eventId}`).addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleTimerClick(e, step, durationMs);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function handleTimerClick(e, event, durationMs) {
Â  Â  Â  Â  Â  Â  const btn = e.target;
Â  Â  Â  Â  Â  Â  const timerId = `timer-btn-${event.eventId}`; 
Â  Â  Â  Â  Â  Â  const displayId = `timer-display-${event.eventId}`; 

Â  Â  Â  Â  Â  Â  if (runningTimers[timerId]) { 
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(runningTimers[timerId].interval); 
Â  Â  Â  Â  Â  Â  Â  Â  delete runningTimers[timerId]; 
Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = 'Iniciar'; 
Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.add('bg-green-500', 'hover:bg-green-600');
Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.remove('bg-red-500', 'hover:bg-red-600');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(displayId).textContent = '--:--:--'; 
Â  Â  Â  Â  Â  Â  } else { 
Â  Â  Â  Â  Â  Â  Â  Â  const endTime = Date.now() + durationMs; 
Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = 'Detener'; 
Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.remove('bg-green-500', 'hover:bg-green-600');
Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.add('bg-red-500', 'hover:bg-red-600');

Â  Â  Â  Â  Â  Â  Â  Â  const updateDisplay = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const remaining = endTime - Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (remaining <= 0) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(interval); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(displayId).textContent = '00:00:00';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const notificationMessage = `Â¡Paso finalizado: ${event.name}!`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast(notificationMessage); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (Notification.permission === 'granted') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  new Notification(notificationMessage);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = 'Finalizado'; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = true; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.remove('bg-red-500', 'hover:bg-red-600'); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delete runningTimers[timerId]; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const h = String(Math.floor(remaining / 3600000)).padStart(2, '0');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const m = String(Math.floor((remaining % 3600000) / 60000)).padStart(2, '0');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const s = String(Math.floor((remaining % 60000) / 1000)).padStart(2, '0');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(displayId).textContent = `${h}:${m}:${s}`; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  const interval = setInterval(updateDisplay, 1000);
Â  Â  Â  Â  Â  Â  Â  Â  updateDisplay();
Â  Â  Â  Â  Â  Â  Â  Â  runningTimers[timerId] = { interval, endTime };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- ANIMAL MODELS ---
Â  Â  Â  Â  function addAnimalModel() {
Â  Â  Â  Â  Â  Â  const modelIdInput = document.getElementById('new-model-id');
Â  Â  Â  Â  Â  Â  const modelId = modelIdInput.value.trim();
Â  Â  Â  Â  Â  Â  if (!modelId) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast("Por favor, introduce un ID para el nuevo modelo.", "error");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (animalModels[modelId]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showToast(`El modelo con ID "${modelId}" ya existe.`, "error");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  animalModels[modelId] = { id: modelId, data: [] }; 
Â  Â  Â  Â  Â  Â  modelIdInput.value = ''; 
Â  Â  Â  Â  Â  Â  renderAnimalModels(); 
Â  Â  Â  Â  Â  Â  showToast(`Modelo "${modelId}" aÃ±adido.`);
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderAnimalModels() {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('animal-models-container');
Â  Â  Â  Â  Â  Â  container.innerHTML = ''; 
Â  Â  Â  Â  Â  Â  const sortedModelIds = Object.keys(animalModels).sort(); 

Â  Â  Â  Â  Â  Â  if (sortedModelIds.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â container.innerHTML = '<p class="text-gray-500">No hay modelos aÃ±adidos todavÃ­a.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  sortedModelIds.forEach(modelId => {
Â  Â  Â  Â  Â  Â  Â  Â  const model = animalModels[modelId];
Â  Â  Â  Â  Â  Â  Â  Â  const modelDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  modelDiv.className = 'p-4 border rounded-lg bg-white shadow';
Â  Â  Â  Â  Â  Â  Â  Â  modelDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-lg text-blue-700">${model.id}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="openModelDataModal('${modelId}')" class="text-sm bg-green-500 text-white py-1 px-3 rounded-md hover:bg-green-600">+ AÃ±adir Registro</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="deleteAnimalModel('${modelId}')" class="text-sm bg-red-500 text-white py-1 px-3 rounded-md hover:bg-red-600 ml-2">Eliminar Modelo</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="max-h-60 overflow-y-auto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table id="model-data-table-${modelId}" class="min-w-full text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><th>Fecha</th><th>Peso (g)</th><th>Talla (cm)</th><th>Glucosa (mg/dL)</th><th>Fuerza (gf)</th><th>Notas</th></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${model.data.sort((a,b) => new Date(b.date) - new Date(a.date)).map(entry => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${new Date(entry.date).toLocaleDateString()}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${entry.weight ?? ''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${entry.size ?? ''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${entry.glucose ?? ''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${entry.grip ?? ''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${entry.notes ?? ''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(modelDiv);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  Â function deleteAnimalModel(modelId) {
Â  Â  Â  Â  Â  Â  if (confirm(`Â¿EstÃ¡s seguro de eliminar el modelo ${modelId} y todos sus registros?`)) {
Â  Â  Â  Â  Â  Â  Â  Â  if (animalModels[modelId]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delete animalModels[modelId];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderAnimalModels();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast(`Modelo "${modelId}" eliminado.`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  function openModelDataModal(modelId) {
Â  Â  Â  Â  Â  Â  currentEditingModelId = modelId; 
Â  Â  Â  Â  Â  Â  document.getElementById('modal-model-id').textContent = modelId; 
Â  Â  Â  Â  Â  Â  document.getElementById('modal-model-weight').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('modal-model-size').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('modal-model-glucose').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('modal-model-grip').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('modal-model-notes').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('model-data-modal').style.display = 'flex';
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeModelDataModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('model-data-modal').style.display = 'none';
Â  Â  Â  Â  Â  Â  currentEditingModelId = null; 
Â  Â  Â  Â  }

Â  Â  Â  Â  function saveModelDataEntry() {
Â  Â  Â  Â  Â  Â  if (!currentEditingModelId || !animalModels[currentEditingModelId]) return;

Â  Â  Â  Â  Â  Â  const entry = {
Â  Â  Â  Â  Â  Â  Â  Â  date: new Date().toISOString(), 
Â  Â  Â  Â  Â  Â  Â  Â  weight: parseFloat(document.getElementById('modal-model-weight').value) || null,
Â  Â  Â  Â  Â  Â  Â  Â  size: parseFloat(document.getElementById('modal-model-size').value) || null,
Â  Â  Â  Â  Â  Â  Â  Â  glucose: parseFloat(document.getElementById('modal-model-glucose').value) || null,
Â  Â  Â  Â  Â  Â  Â  Â  grip: parseFloat(document.getElementById('modal-model-grip').value) || null,
Â  Â  Â  Â  Â  Â  Â  Â  notes: document.getElementById('modal-model-notes').value.trim() || null,
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  animalModels[currentEditingModelId].data.push(entry);
Â  Â  Â  Â  Â  Â  renderAnimalModels(); 
Â  Â  Â  Â  Â  Â  closeModelDataModal(); 
Â  Â  Â  Â  Â  Â  showToast(`Registro aÃ±adido para ${currentEditingModelId}.`);
Â  Â  Â  Â  }

Â  Â  Â  Â  function saveModelData() {
Â  Â  Â  Â  Â  Â  Â if (Object.keys(animalModels).length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast("No hay datos de modelos para guardar.", "warning");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const dataString = JSON.stringify(animalModels, null, 2);
Â  Â  Â  Â  Â  Â  const blob = new Blob([dataString], { type: 'application/json' });
Â  Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  Â  Â  Â  a.href = url;
Â  Â  Â  Â  Â  Â  a.download = `datos_modelos_${new Date().toISOString().split('T')[0]}.json`;
Â  Â  Â  Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  Â  Â  Â  a.click();
Â  Â  Â  Â  Â  Â  document.body.removeChild(a);
Â  Â  Â  Â  Â  Â  URL.revokeObjectURL(url);
Â  Â  Â  Â  Â  Â  showToast('Datos de modelos guardados.');
Â  Â  Â  Â  }

Â  Â  Â  Â  function loadModelData(event) {
Â  Â  Â  Â  Â  Â  const file = event.target.files[0]; 
Â  Â  Â  Â  Â  Â  if (!file) return; 
Â  Â  Â  Â  Â  Â  const reader = new FileReader(); 
Â  Â  Â  Â  Â  Â  reader.onload = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const loadedData = JSON.parse(e.target.result);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (typeof loadedData === 'object' && loadedData !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  animalModels = loadedData; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderAnimalModels(); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast('Datos de modelos cargados.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("El archivo no tiene el formato esperado.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast(`Error al cargar datos de modelos: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  reader.readAsText(file);
Â  Â  Â  Â  Â  Â  event.target.value = ''; 
Â  Â  Â  Â  }

Â  Â  Â  Â  function calculateModelDose() {
Â  Â  Â  Â  Â  Â  Â const doseAmount = parseFloat(document.getElementById('dose-amount').value);
Â  Â  Â  Â  Â  Â  Â const doseAmountUnit = document.getElementById('dose-amount-unit').value;
Â  Â  Â  Â  Â  Â  Â const doseWeightUnitVal = parseFloat(document.getElementById('dose-weight-unit-val').value) || 1; 
Â  Â  Â  Â  Â  Â  Â const doseWeightUnit = document.getElementById('dose-weight-unit').value; 
Â  Â  Â  Â  Â  Â  Â const modelWeight = parseFloat(document.getElementById('model-weight').value);
Â  Â  Â  Â  Â  Â  Â const modelWeightUnit = document.getElementById('model-weight-unit').value;
Â  Â  Â  Â  Â  Â  Â const stockConcAmount = parseFloat(document.getElementById('stock-conc-dose').value);
Â  Â  Â  Â  Â  Â  Â const stockConcUnit = document.getElementById('stock-conc-dose-unit').value; 
Â  Â  Â  Â  Â  Â  Â const outputUnit = document.getElementById('dose-output-unit').value; 
Â  Â  Â  Â  Â  Â  Â const resultDiv = document.getElementById('dose-calculation-result');

Â  Â  Â  Â  Â  Â  Â if (isNaN(doseAmount) || isNaN(modelWeight) || isNaN(stockConcAmount) || stockConcAmount === 0 || isNaN(doseWeightUnitVal) || doseWeightUnitVal === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â resultDiv.innerHTML = `<span class="text-red-500">Por favor, completa todos los campos numÃ©ricos requeridos.</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  const modelWeightConverted = _pureConvertUnits(modelWeight, modelWeightUnit, doseWeightUnit);
Â  Â  Â  Â  Â  Â  Â  Â  Â if (isNaN(modelWeightConverted)) throw new Error(`No se puede convertir el peso del modelo (${modelWeightUnit}) a la unidad de peso de la dosis (${doseWeightUnit}).`);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â const totalAmountNeeded = (modelWeightConverted / doseWeightUnitVal) * doseAmount;
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â const stockMassUnit = stockConcUnit.split('/')[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â const stockVolUnit = stockConcUnit.split('/')[1];
Â  Â  Â  Â  Â  Â  Â  Â  Â if (!stockMassUnit || !stockVolUnit) throw new Error(`Unidad de concentraciÃ³n de stock invÃ¡lida: ${stockConcUnit}`);

Â  Â  Â  Â  Â  Â  Â  Â  Â const totalAmountConverted = _pureConvertUnits(totalAmountNeeded, doseAmountUnit, stockMassUnit);
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isNaN(totalAmountConverted)) throw new Error(`No se puede convertir la unidad de cantidad de dosis (${doseAmountUnit}) a la unidad de masa del stock (${stockMassUnit}).`);

Â  Â  Â  Â  Â  Â  Â  Â  Â const volumeInStockVolUnit = totalAmountConverted / stockConcAmount;

Â  Â  Â  Â  Â  Â  Â  Â  Â const finalVolume = _pureConvertUnits(volumeInStockVolUnit, stockVolUnit, outputUnit);
Â  Â  Â  Â  Â  Â  Â  Â  Â if (isNaN(finalVolume)) throw new Error(`No se puede convertir el volumen calculado (${stockVolUnit}) a la unidad de salida (${outputUnit}).`);

Â  Â  Â  Â  Â  Â  Â  Â  Â resultDiv.textContent = `Administrar: ${finalVolume.toPrecision(4)} ${outputUnit}`;

Â  Â  Â  Â  Â  Â  Â } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â resultDiv.innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- UTILITIES ---
Â  Â  Â  Â  function toggleSubCalc(targetId) {
Â  Â  Â  Â  Â  Â  const el = document.getElementById(targetId);
Â  Â  Â  Â  Â  Â  if(el) {
Â  Â  Â  Â  Â  Â  Â  Â  el.style.display = el.style.display === 'block' ? 'none' : 'block';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function showToast(message, type = 'success') {
Â  Â  Â  Â  Â  Â  const toast = document.getElementById('toast');
Â  Â  Â  Â  Â  Â  const toastMessage = document.getElementById('toast-message');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  toastMessage.textContent = message; 
Â  Â  Â  Â  Â  Â  toast.className = 'toast show fixed bottom-5 right-5 text-white py-4 px-8 rounded-xl shadow-2xl z-50';Â 
Â  Â  Â  Â  Â  Â  toast.classList.add(type === 'error' ? 'bg-red-600' : 'bg-green-600');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  toast.classList.remove('show');
Â  Â  Â  Â  Â  Â  }, 3000);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function populateUnitDropdowns(context = document) {
Â  Â  Â  Â  Â  Â  const massUnits = Object.keys(CONVERSION_FACTORS.mass);
Â  Â  Â  Â  Â  Â  const volUnits = Object.keys(CONVERSION_FACTORS.volume);
Â  Â  Â  Â  Â  Â  const concUnits = Object.keys(CONVERSION_FACTORS.concentration); 
Â  Â  Â  Â  Â  Â  const combinedUnits = [];
Â  Â  Â  Â  Â  Â  massUnits.forEach(m => volUnits.forEach(v => combinedUnits.push(`${m}/${v}`)));
Â  Â  Â  Â  Â  Â  const allConcUnits = [...concUnits, ...combinedUnits];
Â  Â  Â  Â  Â  Â  const allUnits = [...massUnits, ...volUnits, ...allConcUnits];Â 

Â  Â  Â  Â  Â  Â  const ucFrom = context.querySelector('#uc-from');Â 
Â  Â  Â  Â  Â  Â  if (ucFrom && context === document) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  ucFrom.innerHTML = allUnits.map(u => `<option value="${u}">${u}</option>`).join('');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('uc-to').innerHTML = allUnits.map(u => `<option value="${u}">${u}</option>`).join('');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('c1-unit').innerHTML = allConcUnits.map(u => `<option value="${u}" ${u==='mM' ? 'selected':''}>${u}</option>`).join('');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('c2-unit').innerHTML = allConcUnits.map(u => `<option value="${u}" ${u==='ÂµM' ? 'selected':''}>${u}</option>`).join('');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('v1-unit').innerHTML = volUnits.map(u => `<option value="${u}" ${u==='mL' ? 'selected':''}>${u}</option>`).join('');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('v2-unit').innerHTML = volUnits.map(u => `<option value="${u}" ${u==='ÂµL' ? 'selected':''}>${u}</option>`).join('');

Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('dose-amount-unit').innerHTML = massUnits.map(u => `<option value="${u}" ${u==='mg' ? 'selected':''}>${u}</option>`).join('');
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('stock-conc-dose-unit').innerHTML = allConcUnits.map(u => `<option value="${u}" ${u==='mg/mL' ? 'selected':''}>${u}</option>`).join('');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const finalConcUnitSelects = context.querySelectorAll('.variable-final-conc-unit');
Â  Â  Â  Â  Â  Â  const stockConcUnitSelects = context.querySelectorAll('.variable-stock-conc-unit');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  finalConcUnitSelects.forEach(select => {
Â  Â  Â  Â  Â  Â  Â  Â  select.innerHTML = allConcUnits.map(u => `<option value="${u}" ${u === 'ÂµM' ? 'selected' : ''}>${u}</option>`).join('');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  stockConcUnitSelects.forEach(select => {
Â  Â  Â  Â  Â  Â  Â  Â  select.innerHTML = allConcUnits.map(u => `<option value="${u}" ${u === 'mM' ? 'selected' : ''}>${u}</option>`).join('');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- SAVE / LOAD ---
Â  Â  Â  Â  function saveExperiment() {
Â  Â  Â  Â  Â  Â  const experimentState = {
Â  Â  Â  Â  Â  Â  Â  Â  experimentName: document.getElementById('exp-name').value,
Â  Â  Â  Â  Â  Â  Â  Â  plateType: document.getElementById('plate-type').value,
Â  Â  Â  Â  Â  Â  Â  Â  wellData: wellData, 
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const jsonString = JSON.stringify(experimentState, null, 2); 
Â  Â  Â  Â  Â  Â  const blob = new Blob([jsonString], { type: 'application/json' });
Â  Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);

Â  Â  Â  Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  Â  Â  Â  a.href = url; 
Â  Â  Â  Â  Â  Â  const fileName = (experimentState.experimentName || 'experimento').replace(/\s+/g, '_');
Â  Â  Â  Â  Â  Â  a.download = `${fileName}.json`; 
Â  Â  Â  Â  Â  Â  document.body.appendChild(a); 
Â  Â  Â  Â  Â  Â  a.click(); 
Â  Â  Â  Â  Â  Â  document.body.removeChild(a); 
Â  Â  Â  Â  Â  Â  URL.revokeObjectURL(url); 
Â  Â  Â  Â  Â  Â  showToast('Experimento guardado exitosamente.'); 
Â  Â  Â  Â  }

Â  Â  Â  Â  function loadExperiment(event) {
Â  Â  Â  Â  Â  Â  const file = event.target.files[0]; 
Â  Â  Â  Â  Â  Â  if (!file) return; 

Â  Â  Â  Â  Â  Â  const reader = new FileReader(); 
Â  Â  Â  Â  Â  Â  reader.onload = function(e) { 
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const loadedState = JSON.parse(e.target.result);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('exp-name').value = loadedState.experimentName || ''; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  wellData = loadedState.wellData || {}; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  generatePlate(loadedState);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast('Experimento cargado exitosamente.'); 
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast('Error al cargar el archivo. AsegÃºrate de que es un archivo de experimento vÃ¡lido.', 'error'); 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  reader.readAsText(file);
Â  Â  Â  Â  Â  Â  event.target.value = '';Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- REPORTING ---
Â  Â  Â  Â  function generateReport() {
Â  Â  Â  Â  Â  Â  const output = document.getElementById('report-output');
Â  Â  Â  Â  Â  Â  const expName = document.getElementById('exp-name').value || 'Sin nombre';
Â  Â  Â  Â  Â  Â  const plateType = document.getElementById('plate-type').value;

Â  Â  Â  Â  Â  Â  if (Object.keys(wellData).length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  output.innerHTML = '<p class="text-red-500">No hay datos de experimento para reportar. Por favor, configura al menos un pozo.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('export-csv-btn').style.display = 'none'; 
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let html = `<h3>InformaciÃ³n General</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>Nombre del Experimento:</strong> ${expName}</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>Tipo de Placa:</strong> ${plateType} pozos</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>`;

Â  Â  Â  Â  Â  Â  const groupedWells = {};
Â  Â  Â  Â  Â  Â  for (const wellId in wellData) {
Â  Â  Â  Â  Â  Â  Â  Â  const configKey = JSON.stringify(wellData[wellId]);Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!groupedWells[configKey]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  groupedWells[configKey] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  config: wellData[wellId],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  wells: [] 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  groupedWells[configKey].wells.push(wellId);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  html += `<h3>ConfiguraciÃ³n de Pozos</h3>`;
Â  Â  Â  Â  Â  Â  Object.values(groupedWells).forEach((group, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const config = group.config; 
Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="p-4 mb-4 border rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4><strong>Grupo ${index + 1}:</strong> Pozos ${group.wells.join(', ')}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>Tipo:</strong> ${config.wellType}</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>Volumen Total:</strong> ${config.totalVolume ?? 'N/A'} ÂµL</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>CÃ©lulas:</strong> ${config.cells?.count ?? 'N/A'}</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>`;
Â  Â  Â  Â  Â  Â  Â  Â  if (config.variables?.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<h5>Variables:</h5>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <table class="min-w-full text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead class="bg-gray-100"><tr><th>Nombre</th><th>Conc. Final</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  config.variables.forEach(v => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<tr><td>${v.name}</td><td>${v.finalConc} ${v.finalConcUnit}</td></tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `</tbody></table>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â if (config.protocol?.steps?.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<h5>Protocolo:</h5><ul>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  config.protocol.steps.forEach((step, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const unitText = {3600000:'horas', 60000:'minutos', 86400000:'dÃ­as'}[step.unit] || 'ms';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<li><strong>Paso ${i+1}:</strong> ${step.name} (${step.duration} ${unitText})</li>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `</ul>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  html += `</div>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  output.innerHTML = html;
Â  Â  Â  Â  Â  Â  document.getElementById('export-csv-btn').style.display = 'inline-block';
Â  Â  Â  Â  }

Â  Â  Â  Â  function exportReportCSV() {
Â  Â  Â  Â  Â  Â  const expName = document.getElementById('exp-name').value || 'Sin nombre';
Â  Â  Â  Â  Â  Â  const plateType = document.getElementById('plate-type').value;
Â  Â  Â  Â  Â  Â  let csvContent = "\uFEFF";Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const escapeCSV = (str) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â const value = (str === undefined || str === null) ? '' : String(str);
Â  Â  Â  Â  Â  Â  Â  Â  if (value.includes(',') || value.includes('"') || value.includes('\n')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `"${value.replace(/"/g, '""')}"`; 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return value; 
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  csvContent += "SecciÃ³n,ParÃ¡metro,Valor\n";
Â  Â  Â  Â  Â  Â  csvContent += `InformaciÃ³n General,Nombre del Experimento,${escapeCSV(expName)}\n`;
Â  Â  Â  Â  Â  Â  csvContent += `InformaciÃ³n General,Tipo de Placa,${escapeCSV(plateType + ' pozos')}\n\n`;

Â  Â  Â  Â  Â  Â  const headers = ['Pozo', 'Tipo de Pozo', 'Volumen Total (uL)', 'Cantidad de CÃ©lulas'];
Â  Â  Â  Â  Â  Â  const allVars = new Set();
Â  Â  Â  Â  Â  Â  let maxSteps = 0;
Â  Â  Â  Â  Â  Â  Object.values(wellData).forEach(d => {
Â  Â  Â  Â  Â  Â  Â  Â  d.variables?.forEach(v => allVars.add(v.name)); 
Â  Â  Â  Â  Â  Â  Â  Â  if(d.protocol?.steps?.length > maxSteps) maxSteps = d.protocol.steps.length;Â 
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const varColumns = Array.from(allVars); 
Â  Â  Â  Â  Â  Â  varColumns.forEach(v => headers.push(`Variable: ${v} (Conc. Final)`));
Â  Â  Â  Â  Â  Â  Â for(let i=1; i<= maxSteps; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  headers.push(`Paso ${i}: Nombre`);
Â  Â  Â  Â  Â  Â  Â  Â  headers.push(`Paso ${i}: DuraciÃ³n`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  csvContent += headers.map(escapeCSV).join(',') + '\n';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const sortedWellIds = Object.keys(wellData).sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  const rowA = a.match(/[A-Z]+/)[0];
Â  Â  Â  Â  Â  Â  Â  Â  const colA = parseInt(a.match(/\d+/)[0]);
Â  Â  Â  Â  Â  Â  Â  Â  const rowB = b.match(/[A-Z]+/)[0];
Â  Â  Â  Â  Â  Â  Â  Â  const colB = parseInt(b.match(/\d+/)[0]);
Â  Â  Â  Â  Â  Â  Â  Â  if (rowA !== rowB) return rowA.localeCompare(rowB);
Â  Â  Â  Â  Â  Â  Â  Â  return colA - colB;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  for (const wellId of sortedWellIds) {
Â  Â  Â  Â  Â  Â  Â  Â  const d = wellData[wellId]; 
Â  Â  Â  Â  Â  Â  Â  Â  Â const row = [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  wellId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  d.wellType,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  d.totalVolume ?? '', 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  d.cells?.count ?? '' 
Â  Â  Â  Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  Â  Â  Â  Â  varColumns.forEach(varName => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const variable = d.variables?.find(v => v.name === varName);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.push(variable ? `${variable.finalConc ?? ''} ${variable.finalConcUnit ?? ''}`.trim() : '');Â 
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  for(let i=0; i< maxSteps; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const step = d.protocol?.steps?.[i]; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (step) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const unitText = {3600000:'horas', 60000:'minutos', 86400000:'dÃ­as'}[step.unit] || 'ms';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.push(step.name);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.push(`${step.duration} ${unitText}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.push('');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.push('');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  csvContent += row.map(escapeCSV).join(',') + '\n';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  csvContent += '\n'; 


Â  Â  Â  Â  Â  Â  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
Â  Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  const link = document.createElement("a");
Â  Â  Â  Â  Â  Â  link.setAttribute("href", url);
Â  Â  Â  Â  Â  Â  const fileName = (expName || 'reporte').replace(/\s+/g, '_'); 
Â  Â  Â  Â  Â  Â  link.setAttribute("download", `${fileName}.csv`);
Â  Â  Â  Â  Â  Â  document.body.appendChild(link); 
Â  Â  Â  Â  Â  Â  link.click(); 
Â  Â  Â  Â  Â  Â  document.body.removeChild(link); 
Â  Â  Â  Â  Â  Â  URL.revokeObjectURL(url); 
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- INITIALIZATION ---
Â  Â  Â  Â  window.onload = () => {
Â  Â  Â  Â  Â  Â  generatePlate(); 
Â  Â  Â  Â  Â  Â  populateUnitDropdowns(); 
Â  Â  Â  Â  Â  Â  if (typeof Notification !== 'undefined' && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
Â  Â  Â  Â  Â  Â  Â  Â  Notification.requestPermission();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  changeTab('guide'); 
Â  Â  Â  Â  Â  Â  document.getElementById('load-exp-input').addEventListener('change', loadExperiment);
Â  Â  Â  Â  Â  Â  document.getElementById('load-model-input').addEventListener('change', loadModelData);

Â  Â  Â  Â  };
    </script>
</body>
</html>
